[
  {
    "id" : "cd29e11f-5e03-41fb-9048-4c5cf0b49c09",
    "prId" : 44322,
    "prUrl" : "https://github.com/ansible/ansible/pull/44322#pullrequestreview-149185863",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f3982c79-774f-414a-b39a-f3a5126ee607",
        "parentId" : null,
        "authorId" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "body" : "When delegating, I'd think that we'd need to run the facts module for the delegated host rather than for the inventory_hostname host....",
        "createdAt" : "2018-08-22T14:02:47Z",
        "updatedAt" : "2018-08-27T16:29:21Z",
        "lastEditedBy" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "tags" : [
        ]
      },
      {
        "id" : "5407f758-6d1b-4cb1-a3c7-09cdb7335f4b",
        "parentId" : "f3982c79-774f-414a-b39a-f3a5126ee607",
        "authorId" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "body" : "@bcoca corrected me that _execute_module() takes care of delegation so this is fine.\r\n\r\nAfter discussion, though, we did decide that we should set the ansible_pkg_mgr fact when we return from this action plugin so that we don't end up having to discover it every time the actin plugin is run on the same host.",
        "createdAt" : "2018-08-23T03:37:09Z",
        "updatedAt" : "2018-08-27T16:29:21Z",
        "lastEditedBy" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "tags" : [
        ]
      },
      {
        "id" : "cd9c371a-9eb4-4b6e-a38d-dce956765306",
        "parentId" : "f3982c79-774f-414a-b39a-f3a5126ee607",
        "authorId" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "body" : "bcoca also mentioned that the facts end up being set on the host that's being processed in the task loop, not one that's being delegated_to.  So we should only return the ansible_pkg_mgr fact if we are not delegating.",
        "createdAt" : "2018-08-23T03:44:30Z",
        "updatedAt" : "2018-08-27T16:29:21Z",
        "lastEditedBy" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "tags" : [
        ]
      },
      {
        "id" : "1f636bc5-7e24-41c0-b206-782d846ec235",
        "parentId" : "f3982c79-774f-414a-b39a-f3a5126ee607",
        "authorId" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "body" : "Still need to add the ansible_pkg-mgr fact to results if:\r\n* We selected one of yum, yum4, or dnf\r\n* And we are not delegating.",
        "createdAt" : "2018-08-24T04:21:35Z",
        "updatedAt" : "2018-08-27T16:29:21Z",
        "lastEditedBy" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "tags" : [
        ]
      },
      {
        "id" : "7717037a-6951-4c07-bcae-04ba3a5f978a",
        "parentId" : "f3982c79-774f-414a-b39a-f3a5126ee607",
        "authorId" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "body" : "https://docs.ansible.com/ansible/2.6/reference_appendices/common_return_values.html#ansible-facts",
        "createdAt" : "2018-08-24T04:22:33Z",
        "updatedAt" : "2018-08-27T16:29:21Z",
        "lastEditedBy" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "tags" : [
        ]
      },
      {
        "id" : "b3feef8e-145d-4dd6-a4ad-2ed11c709d0f",
        "parentId" : "f3982c79-774f-414a-b39a-f3a5126ee607",
        "authorId" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "body" : "So I guess that this is where we need to set the fact in results.  This is the only place where we know that we've had to run the facts module in order to retrieve the package manager.",
        "createdAt" : "2018-08-24T06:23:00Z",
        "updatedAt" : "2018-08-27T16:29:21Z",
        "lastEditedBy" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "tags" : [
        ]
      }
    ],
    "commit" : "6cca4e8902de70f22e56e7b5830952f75a9280ec",
    "line" : 65,
    "diffHunk" : "@@ -1,1 +63,67 @@            facts = self._execute_module(module_name=\"setup\", module_args=dict(filter=\"ansible_pkg_mgr\", gather_subset=\"!all\"), task_vars=task_vars)\n            display.debug(\"Facts %s\" % facts)\n            module = facts.get(\"ansible_facts\", {}).get(\"ansible_pkg_mgr\", \"auto\")\n            if (not self._task.delegate_to or self._task.delegate_facts) and module != 'auto':\n                result['ansible_facts'] = {'pkg_mgr': module}"
  },
  {
    "id" : "74736034-f930-47a7-9a90-98777fdf4d2f",
    "prId" : 44322,
    "prUrl" : "https://github.com/ansible/ansible/pull/44322#pullrequestreview-148497806",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "4ace359b-81f7-4ca5-841d-3c2309b95b99",
        "parentId" : null,
        "authorId" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "body" : "If you don't modify the task args then you don't need to copy() them.  However, I think we want to add a ```use``` parameter for the action plugin and we will want to delete that parameter before we pass the args on to the module.  So this section would look like:\r\n``` python\r\nnew_module_args = self._task.args.copy()\r\ndel new_module_args['use']\r\n[...]\r\nresult.update(self._execute_module(module_name=module, module_args=new_module_args, task_vars=task_vars, wrap_async=self._task.async_val))\r\n```",
        "createdAt" : "2018-08-22T14:05:55Z",
        "updatedAt" : "2018-08-27T16:29:21Z",
        "lastEditedBy" : "838eb58c-0fa8-4742-994f-a407c7183e57",
        "tags" : [
        ]
      }
    ],
    "commit" : "6cca4e8902de70f22e56e7b5830952f75a9280ec",
    "line" : 78,
    "diffHunk" : "@@ -1,1 +76,80 @@            else:\n                # run either the yum (yum3) or dnf (yum4) backend module\n                new_module_args = self._task.args.copy()\n                if 'use_backend' in new_module_args:\n                    del new_module_args['use_backend']"
  }
]