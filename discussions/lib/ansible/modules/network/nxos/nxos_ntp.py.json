[
  {
    "id" : "ead28f8d-eb2d-41e2-8328-aed82d7e496d",
    "prId" : 39178,
    "prUrl" : "https://github.com/ansible/ansible/pull/39178#pullrequestreview-115084768",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "5f7561c5-2769-430a-8759-b106f6bad386",
        "parentId" : null,
        "authorId" : "284bb4ad-6403-4762-bb03-b2a921d26492",
        "body" : "Same like the above. Check `if existing_source_type and existing_source:` before hitting nested conditions. ",
        "createdAt" : "2018-04-24T11:27:10Z",
        "updatedAt" : "2018-04-25T16:41:28Z",
        "lastEditedBy" : "284bb4ad-6403-4762-bb03-b2a921d26492",
        "tags" : [
        ]
      },
      {
        "id" : "ba679aa3-0666-41e3-8a89-429fb9fe39d1",
        "parentId" : "5f7561c5-2769-430a-8759-b106f6bad386",
        "authorId" : "fa79aa34-d606-4908-acc5-6efdccee3b48",
        "body" : "@trishnaguha Made the changes. Can you please check if this new code works ok on your setup? All test cases passed for me even before this change so I am not able to get into the condition you described. ",
        "createdAt" : "2018-04-24T16:31:54Z",
        "updatedAt" : "2018-04-25T16:41:28Z",
        "lastEditedBy" : "fa79aa34-d606-4908-acc5-6efdccee3b48",
        "tags" : [
        ]
      },
      {
        "id" : "85474d20-d772-4a10-9b01-3d71c634200b",
        "parentId" : "5f7561c5-2769-430a-8759-b106f6bad386",
        "authorId" : "284bb4ad-6403-4762-bb03-b2a921d26492",
        "body" : "Instead of checking `if existing_source_type and existing_source:` after `source: default`, I think it would make more sense to add this after Line 285.",
        "createdAt" : "2018-04-24T16:58:04Z",
        "updatedAt" : "2018-04-25T16:41:28Z",
        "lastEditedBy" : "284bb4ad-6403-4762-bb03-b2a921d26492",
        "tags" : [
        ]
      },
      {
        "id" : "d11c2655-6af5-4b2c-8937-4e9ca13b7ee6",
        "parentId" : "5f7561c5-2769-430a-8759-b106f6bad386",
        "authorId" : "fa79aa34-d606-4908-acc5-6efdccee3b48",
        "body" : "@trishnaguha I am not able to follow what you are asking. I believe we still need to check if existing source and source type are null or not in both cases. This is what I am thinking, see below. If it is not, please let me know. I will make changes after you reply.\r\n```\r\nif source:\r\n        existing_source_type = existing.get('source_type')\r\n        existing_source = existing.get('source')\r\n        if existing_source_type and source_type != existing_source_type:\r\n            if existing_source:\r\n                ntp_cmds.append('no ntp {0} {1}'.format(existing_source_type, existing_source))\r\n        if source == 'default':\r\n            if existing_source_type and existing_source:\r\n                ntp_cmds.append('no ntp {0} {1}'.format(existing_source_type, existing_source))\r\n        else:\r\n            ntp_cmds.append('ntp {0} {1}'.format(source_type, source))\r\n```",
        "createdAt" : "2018-04-24T17:07:45Z",
        "updatedAt" : "2018-04-25T16:41:28Z",
        "lastEditedBy" : "fa79aa34-d606-4908-acc5-6efdccee3b48",
        "tags" : [
        ]
      },
      {
        "id" : "a1ba2243-1df8-4d0d-8e82-3d6e99df741e",
        "parentId" : "5f7561c5-2769-430a-8759-b106f6bad386",
        "authorId" : "fa79aa34-d606-4908-acc5-6efdccee3b48",
        "body" : "@trishnaguha Actually after thinking a bit more, I am not sure if this is needed at all. Since source cannot be None if source_type is not None (basically the CLI cannot be run without specifying source), if we just check for source_type, it is good enough. I think my original code is correct for source/source_type case. For peer_type/address case, I agree with you. \r\nIf you disagree, can you just let me know the config you are using, I will try to replicate the problem.",
        "createdAt" : "2018-04-24T17:15:50Z",
        "updatedAt" : "2018-04-25T16:41:28Z",
        "lastEditedBy" : "fa79aa34-d606-4908-acc5-6efdccee3b48",
        "tags" : [
        ]
      },
      {
        "id" : "2e7ecd88-f003-4cfc-9488-b2786f9ef926",
        "parentId" : "5f7561c5-2769-430a-8759-b106f6bad386",
        "authorId" : "284bb4ad-6403-4762-bb03-b2a921d26492",
        "body" : "@saichint `no ntp None None` is now fixed, but the idempotence test is now failing https://github.com/saichint/ansible/blob/1873b5744b92d5cd23ce4df1f165113f6b340252/test/integration/targets/nxos_ntp/tests/common/sanity.yaml#L34.\r\nI think that is because `peer_type` key still is there in `delta` after configuring once, unlike `source` key deleted after configuration.\r\n\r\nPrior to config: `delta={'address': '1.2.3.4', 'key_id': '32', 'peer_type': 'server', 'prefer': 'enabled', 'source': '5.5.5.5', 'source_type': 'source', 'vrf_name': 'management'}`\r\n\r\nIdempotence run: `delta={'address': '1.2.3.4', 'key_id': '32', 'peer_type': 'server', 'prefer': 'enabled', 'vrf_name': 'management'}`, \r\n\r\nhence calling the function -> https://github.com/saichint/ansible/blob/1873b5744b92d5cd23ce4df1f165113f6b340252/lib/ansible/modules/network/nxos/nxos_ntp.py#L282",
        "createdAt" : "2018-04-25T08:48:32Z",
        "updatedAt" : "2018-04-25T16:41:28Z",
        "lastEditedBy" : "284bb4ad-6403-4762-bb03-b2a921d26492",
        "tags" : [
        ]
      }
    ],
    "commit" : "4dede8fdda77f65fa3429fa2350a9ca0b34edf50",
    "line" : 82,
    "diffHunk" : "@@ -1,1 +288,292 @@        if existing_source_type and source_type != existing_source_type:\n            ntp_cmds.append('no ntp {0} {1}'.format(existing_source_type, existing_source))\n        if source == 'default':\n            if existing_source_type and existing_source:\n                ntp_cmds.append('no ntp {0} {1}'.format(existing_source_type, existing_source))"
  }
]