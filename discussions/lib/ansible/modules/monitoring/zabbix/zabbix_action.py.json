[
  {
    "id" : "670e7b9e-1611-4362-9c58-b6f96442a79f",
    "prId" : 49189,
    "prUrl" : "https://github.com/ansible/ansible/pull/49189#pullrequestreview-180220400",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "8ee2932e-0132-45da-8bf9-630a1cc80193",
        "parentId" : null,
        "authorId" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "body" : "[recovery_operations](https://www.zabbix.com/documentation/3.2/manual/api/reference/action/create) supported since zbx-server 3.2, ignored on 3.0, fails on lower versions\r\n\r\n```\r\nfatal: [zbx-dev-node001 -> localhost]: FAILED! => changed=false\r\n  msg: 'Failed to create action ''Send alerts to Admin'': (u''Error -32602: Invalid params., Incorrect parameter for action \"Send alerts to Admin\". while sending {\"params\": {\"operations\": [{\"opmessage\": {\"mediatypeid\": \"1\", \"default_msg\": \"0\", \"message\": \"Come on, guys d\r\no something\", \"subject\": \"Something bad is happening\"}, \"opmessage_usr\": [{\"userid\": \"1\"}], \"operationtype\": \"0\"}], \"status\": \"0\", \"esc_period\": \"60\", \"r_shortdata\": null, \"r_longdata\": null, \"def_shortdata\": null, \"name\": \"Send alerts to Admin\", \"recovery_operations\": n\r\null, \"acknowledge_operations\": null, \"def_longdata\": null, \"filter\": {\"evaltype\": \"0\", \"conditions\": [{\"operator\": \"5\", \"conditiontype\": \"4\", \"value\": \"1\"}]}, \"ack_shortdata\": null, \"eventsource\": \"0\", \"ack_longdata\": null}, \"jsonrpc\": \"2.0\", \"method\": \"action.create\", \"\r\nauth\": \"1a63b4bb1d45604a5aec26aa43651adb\", \"id\": 4}'', -32602)'\r\n```",
        "createdAt" : "2018-11-30T11:40:44Z",
        "updatedAt" : "2018-12-01T14:29:56Z",
        "lastEditedBy" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "tags" : [
        ]
      }
    ],
    "commit" : "356ddf04dd93c1c8251006ec5887d74dd456685f",
    "line" : 1567,
    "diffHunk" : "@@ -1,1 +1565,1569 @@            formula=dict(type='str', required=False, default=None),\n            operations=dict(type='list', required=False, default=None),\n            recovery_operations=dict(type='list', required=False, default=None),\n            acknowledge_operations=dict(type='list', required=False, default=None)\n        ),"
  },
  {
    "id" : "b01ad949-f7f3-4d9f-8ee2-e126a21826f3",
    "prId" : 49189,
    "prUrl" : "https://github.com/ansible/ansible/pull/49189#pullrequestreview-180220400",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "a8143c00-6ba3-4483-801b-fa455a4bb274",
        "parentId" : null,
        "authorId" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "body" : "[acknowledge_operations](https://www.zabbix.com/documentation/3.4/manual/api/reference/action/create) supported since zbx-server 3.4, ignored in 3.2/3.0, fails in lower versions ",
        "createdAt" : "2018-11-30T11:41:18Z",
        "updatedAt" : "2018-12-01T14:29:56Z",
        "lastEditedBy" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "tags" : [
        ]
      }
    ],
    "commit" : "356ddf04dd93c1c8251006ec5887d74dd456685f",
    "line" : 1568,
    "diffHunk" : "@@ -1,1 +1566,1570 @@            operations=dict(type='list', required=False, default=None),\n            recovery_operations=dict(type='list', required=False, default=None),\n            acknowledge_operations=dict(type='list', required=False, default=None)\n        ),\n        supports_check_mode=True"
  },
  {
    "id" : "a87f95a6-c1e0-4ef6-8d9f-87e784eb74ee",
    "prId" : 49189,
    "prUrl" : "https://github.com/ansible/ansible/pull/49189#pullrequestreview-180220400",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "0c78021e-50bb-48b7-81d3-27203cb56742",
        "parentId" : null,
        "authorId" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "body" : "both [ack_longdata and ack_shortdata](https://www.zabbix.com/documentation/3.4/manual/api/reference/action/object#action) were introduced in zbx-server 3.4, adding them to API call doesn't break calls to 3.2 and 3.0 versions tho, < 3.0 versions are failing ",
        "createdAt" : "2018-11-30T11:46:41Z",
        "updatedAt" : "2018-12-01T14:29:56Z",
        "lastEditedBy" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "tags" : [
        ]
      }
    ],
    "commit" : "356ddf04dd93c1c8251006ec5887d74dd456685f",
    "line" : 746,
    "diffHunk" : "@@ -1,1 +744,748 @@            'r_longdata': kwargs['recovery_default_message'],\n            'r_shortdata': kwargs['recovery_default_subject'],\n            'ack_longdata': kwargs['acknowledge_default_message'],\n            'ack_shortdata': kwargs['acknowledge_default_subject'],\n            'operations': kwargs['operations'],"
  },
  {
    "id" : "a7b1a26e-fd45-4af1-b101-7727b8d24031",
    "prId" : 49189,
    "prUrl" : "https://github.com/ansible/ansible/pull/49189#pullrequestreview-180307420",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "3aa3affa-c0a3-4811-a4bf-0a960058b409",
        "parentId" : null,
        "authorId" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "body" : "Pasting whole example here so you can better understand me.\r\n\r\nusing recovery and acknowledge operations:\r\n* is not idempotent on zbx-server 3.4 and 4.0 (result always `changed=True`)\r\n* fails on 3.0 and lower releases (probably related to my comments above, that this was supported later)\r\n* Action configured with recovery and acknowledge operations cannot have these operations removed by update, this is possible only by deleting action first and recreating it again.\r\n\r\n```yaml\r\n- block:\r\n    - name: Deploy trigger action (new)\r\n      zabbix_action:\r\n        server_url: '{{ zbx_server_url }}'\r\n        login_user: '{{ zbx_user }}'\r\n        login_password: '{{ zbx_password }}'\r\n        validate_certs: False\r\n        name: \"Send alerts to Admin\"\r\n        event_source: 'trigger'\r\n        state: present\r\n        status: enabled\r\n        conditions:\r\n          - type: 'trigger_severity'\r\n            operator: '>='\r\n            value: 'Information'\r\n        operations:\r\n          - type: send_message\r\n            subject: \"Something bad is happening\"\r\n            message: \"Come on, guys do something\"\r\n            media_type: 'Email'\r\n            send_to_users:\r\n              - 'Admin'\r\n        recovery_operations:\r\n          - type: send_message\r\n            subject: \"Host is down\"\r\n            message: \"Come on, guys do something\"\r\n            media_type: 'Email'\r\n            send_to_users:\r\n              - 'Admin'\r\n        acknowledge_operations:\r\n          - type: send_message\r\n            media_type: 'Email'\r\n            send_to_users:\r\n              - 'Admin'\r\n      register: result\r\n\r\n    - assert:\r\n        that:\r\n          - \"result.changed\"\r\n      ignore_errors: True\r\n\r\n    - name: Deploy trigger action (existing)\r\n      zabbix_action:\r\n        server_url: '{{ zbx_server_url }}'\r\n        login_user: '{{ zbx_user }}'\r\n        login_password: '{{ zbx_password }}'\r\n        validate_certs: False\r\n        name: \"Send alerts to Admin\"\r\n        event_source: 'trigger'\r\n        state: present\r\n        status: enabled\r\n        conditions:\r\n          - type: 'trigger_severity'\r\n            operator: '>='\r\n            value: 'Information'\r\n        operations:\r\n          - type: send_message\r\n            subject: \"Something bad is happening\"\r\n            message: \"Come on, guys do something\"\r\n            media_type: 'Email'\r\n            send_to_users:\r\n              - 'Admin'\r\n        recovery_operations:\r\n          - type: send_message\r\n            subject: \"Host is down\"\r\n            message: \"Come on, guys do something\"\r\n            media_type: 'Email'\r\n            send_to_users:\r\n              - 'Admin'\r\n        acknowledge_operations:\r\n          - type: send_message\r\n            media_type: 'Email'\r\n            send_to_users:\r\n              - 'Admin'\r\n      register: result\r\n\r\n    - assert:\r\n        that:\r\n          - \"not result.changed\"\r\n      ignore_errors: True\r\n\r\n    - name: Deploy trigger action (remove rec&ack)\r\n      zabbix_action:\r\n        server_url: '{{ zbx_server_url }}'\r\n        login_user: '{{ zbx_user }}'\r\n        login_password: '{{ zbx_password }}'\r\n        validate_certs: False\r\n        name: \"Send alerts to Admin\"\r\n        event_source: 'trigger'\r\n        state: present\r\n        status: enabled\r\n        conditions:\r\n          - type: 'trigger_severity'\r\n            operator: '>='\r\n            value: 'Information'\r\n        operations:\r\n          - type: send_message\r\n            subject: \"Something bad is happening\"\r\n            message: \"Come on, guys do something\"\r\n            media_type: 'Email'\r\n            send_to_users:\r\n              - 'Admin'\r\n      register: result\r\n\r\n    - assert:\r\n        that:\r\n          - \"result.changed\"\r\n      ignore_errors: True\r\n\r\n  delegate_to: localhost\r\n```\r\n\r\n```\r\nTASK [Deploy trigger action (new)] ********************************************************************************************************************************************************************************************************************************************\r\nchanged: [zbx-dev-node002 -> localhost]\r\nchanged: [zbx-dev-node003 -> localhost]\r\n\r\nTASK [assert] *****************************************************************************************************************************************************************************************************************************************************************\r\nok: [zbx-dev-node002 -> localhost] => changed=false\r\n  msg: All assertions passed\r\nok: [zbx-dev-node003 -> localhost] => changed=false\r\n  msg: All assertions passed\r\n\r\nTASK [Deploy trigger action (existing)] ***************************************************************************************************************************************************************************************************************************************\r\nchanged: [zbx-dev-node002 -> localhost]\r\nchanged: [zbx-dev-node003 -> localhost]\r\n\r\nTASK [assert] *****************************************************************************************************************************************************************************************************************************************************************\r\nfatal: [zbx-dev-node002 -> localhost]: FAILED! => changed=false\r\n  assertion: not result.changed\r\n  evaluated_to: false\r\n  msg: Assertion failed\r\n...ignoring\r\nfatal: [zbx-dev-node003 -> localhost]: FAILED! => changed=false\r\n  assertion: not result.changed\r\n  evaluated_to: false\r\n  msg: Assertion failed\r\n...ignoring\r\n\r\nTASK [Deploy trigger action (remove rec&ack)] *********************************************************************************************************************************************************************************************************************************\r\nok: [zbx-dev-node002 -> localhost]\r\nok: [zbx-dev-node003 -> localhost]\r\n\r\nTASK [assert] *****************************************************************************************************************************************************************************************************************************************************************\r\nfatal: [zbx-dev-node002 -> localhost]: FAILED! => changed=false\r\n  assertion: result.changed\r\n  evaluated_to: false\r\n  msg: Assertion failed\r\n...ignoring\r\nfatal: [zbx-dev-node003 -> localhost]: FAILED! => changed=false\r\n  assertion: result.changed\r\n  evaluated_to: false\r\n  msg: Assertion failed\r\n...ignoring\r\n```",
        "createdAt" : "2018-11-30T11:56:28Z",
        "updatedAt" : "2018-12-01T14:29:56Z",
        "lastEditedBy" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "tags" : [
        ]
      },
      {
        "id" : "a17b1d79-224f-42b1-a909-ffdf8732141d",
        "parentId" : "3aa3affa-c0a3-4811-a4bf-0a960058b409",
        "authorId" : "c724caba-6754-4575-a34c-070264941ede",
        "body" : "Found the idempotency issue. Zabbix API uses `recovery_operations` key when you **create** an action and `recoveryOperations` when you **get** an action. I need to do some transformation before comparing the data.",
        "createdAt" : "2018-11-30T15:11:36Z",
        "updatedAt" : "2018-12-01T14:29:56Z",
        "lastEditedBy" : "c724caba-6754-4575-a34c-070264941ede",
        "tags" : [
        ]
      }
    ],
    "commit" : "356ddf04dd93c1c8251006ec5887d74dd456685f",
    "line" : 350,
    "diffHunk" : "@@ -1,1 +348,352 @@\n# Trigger action with recovery and aknowledge operations\n- name: Deploy trigger action\n  zabbix_action:\n    server_url: \"http://zabbix.example.com/zabbix/\""
  },
  {
    "id" : "68c29f0e-0bea-4abc-8be9-60add5809150",
    "prId" : 49189,
    "prUrl" : "https://github.com/ansible/ansible/pull/49189#pullrequestreview-180220400",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "b88365bb-67fc-4f0a-91d9-4bbc79351093",
        "parentId" : null,
        "authorId" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "body" : "Add \"- Works only with >= Zabbix 3.2\" same probably goes for other arguments related to `recovery_*`",
        "createdAt" : "2018-11-30T12:24:52Z",
        "updatedAt" : "2018-12-01T14:29:56Z",
        "lastEditedBy" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "tags" : [
        ]
      }
    ],
    "commit" : "356ddf04dd93c1c8251006ec5887d74dd456685f",
    "line" : 279,
    "diffHunk" : "@@ -1,1 +277,281 @@        description:\n            - List of recovery operations\n            - C(Suboptions) are the same as I(operations)\n            - Works only with >= Zabbix 3.2\n    acknowledge_operations:"
  },
  {
    "id" : "9a6843e3-63cf-45f4-a5e2-308237dd4655",
    "prId" : 49189,
    "prUrl" : "https://github.com/ansible/ansible/pull/49189#pullrequestreview-180220400",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "5ce250c9-2930-4ebf-bacb-95dc7bf4fb5f",
        "parentId" : null,
        "authorId" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "body" : "Add \"- Works only with >= Zabbix 3.4\" same probably goes for other arguments related to `acknowledge_*`",
        "createdAt" : "2018-11-30T12:25:11Z",
        "updatedAt" : "2018-12-01T14:29:56Z",
        "lastEditedBy" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "tags" : [
        ]
      }
    ],
    "commit" : "356ddf04dd93c1c8251006ec5887d74dd456685f",
    "line" : 285,
    "diffHunk" : "@@ -1,1 +283,287 @@        description:\n            - List of acknowledge operations\n            - C(Suboptions) are the same as I(operations)\n            - Works only with >= Zabbix 3.4\n"
  },
  {
    "id" : "ee4561a4-a2cf-4083-8653-b5ae11920d92",
    "prId" : 58379,
    "prUrl" : "https://github.com/ansible/ansible/pull/58379#pullrequestreview-259435377",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "b7606f5f-c7ba-4747-9420-ef650a5cfeeb",
        "parentId" : null,
        "authorId" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "body" : "There are 2 places where `esc_period` is defined in argument_spec, but none of it has `required=True`, so this change would make and inconsistency between module documentation and actual argument definition.",
        "createdAt" : "2019-07-08T17:06:47Z",
        "updatedAt" : "2019-07-11T07:41:32Z",
        "lastEditedBy" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "tags" : [
        ]
      },
      {
        "id" : "1bc668aa-cac4-45e9-829a-2cb24ad1a4e3",
        "parentId" : "b7606f5f-c7ba-4747-9420-ef650a5cfeeb",
        "authorId" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "body" : "This is a valid change as it is specified in [Zabbix API action object documentation](https://www.zabbix.com/documentation/3.2/manual/api/reference/action/object) as well. Please adjust [this line](https://github.com/ansible/ansible/blob/62b3fec7055cfb1eef6b95cace8dd324a16fd97b/lib/ansible/modules/monitoring/zabbix/zabbix_action.py#L1677) to reflect this documentation change - `required=True`.",
        "createdAt" : "2019-07-09T11:24:35Z",
        "updatedAt" : "2019-07-11T07:41:32Z",
        "lastEditedBy" : "9ef24942-7dd8-4c83-a114-f7f81ff1071b",
        "tags" : [
        ]
      }
    ],
    "commit" : "38b42322c8e3a5c53b67bc4f4a653fe18d1ea52a",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +64,68 @@        description:\n            - Default operation step duration. Must be greater than 60 seconds. Accepts seconds, time unit with suffix and user macro.\n        required: true\n    conditions:\n        type: list"
  }
]