[
  {
    "id" : "9cbd1af0-c6fb-408f-8613-f4c71c53d8e2",
    "prId" : 66517,
    "prUrl" : "https://github.com/ansible/ansible/pull/66517#pullrequestreview-343946834",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "89dd95e4-652f-4651-9674-129f9739a661",
        "parentId" : null,
        "authorId" : "3374b5c2-684a-46fc-8052-1e21707ac879",
        "body" : "@GomathiselviS code changes LGTM, can u add on 1 test covering the use case.",
        "createdAt" : "2020-01-16T06:25:31Z",
        "updatedAt" : "2020-01-23T16:04:57Z",
        "lastEditedBy" : "3374b5c2-684a-46fc-8052-1e21707ac879",
        "tags" : [
        ]
      },
      {
        "id" : "7349c77a-3011-4336-99ae-f2602dffc478",
        "parentId" : "89dd95e4-652f-4651-9674-129f9739a661",
        "authorId" : "5de09262-58b9-4c49-922e-6a6b668cf343",
        "body" : "Added testcase",
        "createdAt" : "2020-01-16T14:22:58Z",
        "updatedAt" : "2020-01-23T16:04:57Z",
        "lastEditedBy" : "5de09262-58b9-4c49-922e-6a6b668cf343",
        "tags" : [
        ]
      }
    ],
    "commit" : "bd9276599bfdb9842485fd7fd27dd209af575022",
    "line" : 38,
    "diffHunk" : "@@ -1,1 +256,260 @@            commands.append(cmd + 'access vlan ' + str(d['vlan']))\n        if 'allowed_vlans' in d:\n            if vlan_exists:\n                commands.append(cmd + 'trunk allowed vlan add ' + str(d['allowed_vlans']))\n            else:"
  },
  {
    "id" : "db70d8c4-e073-4508-bdeb-efcadb0ee854",
    "prId" : 66517,
    "prUrl" : "https://github.com/ansible/ansible/pull/66517#pullrequestreview-344955687",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "8526ae3a-8d69-4eb4-a19d-376f586d25ec",
        "parentId" : null,
        "authorId" : "590c0c9f-420c-41b0-8f5d-dc6889d70e93",
        "body" : "I just ran a test and discovered that adding vlans using a range to an already existing list is not idempotent.  Logic should be added to expand a range if provided to match what is in the running config.\r\n\r\nFirst I applied this playbook:\r\n\r\n```yaml\r\n    - name: Merge with existing vlans\r\n      nxos_l2_interfaces:\r\n        config:\r\n          - name: \"Ethernet1/3\"\r\n            trunk:\r\n              native_vlan: 10\r\n              allowed_vlans: 35-40 \r\n            #access:\r\n            #  vlan: 30\r\n        state:  merged\r\n```\r\n\r\nRe-running this playbook is idempotent.\r\n\r\nI then tried to add a few more vlans using the following playbook.\r\n\r\n```yaml\r\n    - name: Merge with existing vlans\r\n      nxos_l2_interfaces:\r\n        config:\r\n          - name: \"Ethernet1/3\"\r\n            trunk:\r\n              native_vlan: 10\r\n              allowed_vlans: 50-60 \r\n            #access:\r\n            #  vlan: 30\r\n        state:  merged\r\n\r\n```\r\n\r\nIt adds them but it's not idempotent.\r\n\r\n```shell\r\n    \"after\": [\r\n        {\r\n            \"name\": \"Ethernet1/3\", \r\n            \"trunk\": {\r\n                \"allowed_vlans\": \"35-40,50-60\", \r\n                \"native_vlan\": 10\r\n            }\r\n        }\r\n    ], \r\n    \"ansible_facts\": {\r\n        \"discovered_interpreter_python\": \"/usr/bin/python\"\r\n    }, \r\n    \"before\": [\r\n        {\r\n            \"name\": \"Ethernet1/3\", \r\n            \"trunk\": {\r\n                \"allowed_vlans\": \"35,36,37,38,39,40,50,51,52,53,54,55,56,57,58,59,60\", \r\n                \"native_vlan\": 10\r\n            }\r\n        }\r\n    ], \r\n    \"changed\": true, \r\n    \"commands\": [\r\n        \"interface Ethernet1/3\", \r\n        \"switchport trunk allowed vlan add 50,51,52,53,54,55,56,57,58,59,60\"\r\n    ], \r\n    \"invocation\": {\r\n        \"module_args\": {\r\n            \"config\": [\r\n                {\r\n                    \"access\": null, \r\n                    \"name\": \"Ethernet1/3\", \r\n                    \"trunk\": {\r\n                        \"allowed_vlans\": \"50,51,52,53,54,55,56,57,58,59,60\", \r\n                        \"native_vlan\": 10\r\n                    }\r\n                }\r\n            ], \r\n            \"state\": \"merged\"\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nIf the state is merged we should only send commands to add the new vlans if they are not already part of the list.  If I include the entire list of configured vlans it's idempotent but it should be idempotent if I only provide a partial list but that list is already configured.",
        "createdAt" : "2020-01-17T21:20:33Z",
        "updatedAt" : "2020-01-23T16:04:57Z",
        "lastEditedBy" : "590c0c9f-420c-41b0-8f5d-dc6889d70e93",
        "tags" : [
        ]
      },
      {
        "id" : "53359129-010a-47c0-8f8b-0010355ff23a",
        "parentId" : "8526ae3a-8d69-4eb4-a19d-376f586d25ec",
        "authorId" : "590c0c9f-420c-41b0-8f5d-dc6889d70e93",
        "body" : "**Another problem** \r\n\r\nThe `replaced` state does not appear to work properly.\r\n\r\nI start with the following config:\r\n\r\n```shell\r\ninterface Ethernet1/3\r\n  switchport\r\n  switchport trunk native vlan 40\r\n  switchport trunk allowed vlan 35-40,50-60\r\n```\r\n\r\nI run the following playbook:\r\n\r\n```yaml\r\n    - name: Merge with existing vlans\r\n      nxos_l2_interfaces:\r\n        config:\r\n          - name: \"Ethernet1/3\"\r\n            trunk:\r\n              native_vlan: 50\r\n              allowed_vlans: 45-70\r\n        state: replaced\r\n```\r\n\r\nHere is my config after running the playbook.\r\n\r\n```shell\r\ninterface Ethernet1/3\r\n  switchport\r\n  switchport trunk native vlan 50\r\n  switchport trunk allowed vlan 35-40,45-70\r\n```\r\n\r\nThe `replaced` state should replace my running config with whatever is defined in the playbook but as you can see it left behind 35-40.\r\n\r\n",
        "createdAt" : "2020-01-17T21:28:13Z",
        "updatedAt" : "2020-01-23T16:04:57Z",
        "lastEditedBy" : "590c0c9f-420c-41b0-8f5d-dc6889d70e93",
        "tags" : [
        ]
      },
      {
        "id" : "cad025db-3127-4448-b417-d435ee859975",
        "parentId" : "8526ae3a-8d69-4eb4-a19d-376f586d25ec",
        "authorId" : "590c0c9f-420c-41b0-8f5d-dc6889d70e93",
        "body" : "**NOTE: ** Same problem with `state: overridden`\r\n\r\nStart with the following configs:\r\n\r\n```\r\ninterface Ethernet1/3\r\n  switchport\r\n  switchport trunk native vlan 50\r\n  switchport trunk allowed vlan 35-40,45-70\r\n\r\n\r\ninterface Ethernet1/4\r\n  switchport\r\n  switchport trunk native vlan 60\r\n  switchport trunk allowed vlan 35-40\r\n\r\n```\r\n\r\nRun the following playbook\r\n\r\n```yaml\r\n    - name: Merge with existing vlans\r\n      nxos_l2_interfaces:\r\n        config:\r\n          - name: \"Ethernet1/3\"\r\n            trunk:\r\n              native_vlan: 50\r\n              allowed_vlans: 45-70 \r\n        state: overridden \r\n```\r\n\r\nState after running the playbook:\r\n\r\n```\r\ninterface Ethernet1/3\r\n  switchport\r\n  switchport trunk allowed vlan 35-40,45-70\r\n\r\ninterface Ethernet1/4\r\n  switchport\r\n\r\n```\r\n\r\nState of Ethernet1/4 is correct but like state replaced Ethernet1/3 should only have vlans 45-70",
        "createdAt" : "2020-01-17T21:35:24Z",
        "updatedAt" : "2020-01-23T16:04:57Z",
        "lastEditedBy" : "590c0c9f-420c-41b0-8f5d-dc6889d70e93",
        "tags" : [
        ]
      },
      {
        "id" : "a16e60df-2c63-4897-8810-e759c1290830",
        "parentId" : "8526ae3a-8d69-4eb4-a19d-376f586d25ec",
        "authorId" : "5de09262-58b9-4c49-922e-6a6b668cf343",
        "body" : "@mikewiebe : I have made few changes. I tested with various combinations. Can you please take a look? I will work on adding necessary testcases and documentation.",
        "createdAt" : "2020-01-18T18:16:27Z",
        "updatedAt" : "2020-01-23T16:04:57Z",
        "lastEditedBy" : "5de09262-58b9-4c49-922e-6a6b668cf343",
        "tags" : [
        ]
      }
    ],
    "commit" : "bd9276599bfdb9842485fd7fd27dd209af575022",
    "line" : 38,
    "diffHunk" : "@@ -1,1 +256,260 @@            commands.append(cmd + 'access vlan ' + str(d['vlan']))\n        if 'allowed_vlans' in d:\n            if vlan_exists:\n                commands.append(cmd + 'trunk allowed vlan add ' + str(d['allowed_vlans']))\n            else:"
  }
]