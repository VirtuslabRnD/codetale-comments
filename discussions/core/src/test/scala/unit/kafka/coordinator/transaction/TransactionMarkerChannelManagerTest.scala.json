[
  {
    "id" : "dbdea241-3e37-402c-9a44-ddd6513a039b",
    "prId" : 8782,
    "prUrl" : "https://github.com/apache/kafka/pull/8782#pullrequestreview-423716087",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "b8caf64d-a4bf-498c-93cc-3dd3d57fd804",
        "parentId" : null,
        "authorId" : "eba565e8-e1d5-4749-9c9a-5d117de6c96c",
        "body" : "Does this test cover concurrent calls to `maybeWriteTxnCompletion`?",
        "createdAt" : "2020-06-02T21:01:36Z",
        "updatedAt" : "2020-06-02T21:06:08Z",
        "lastEditedBy" : "eba565e8-e1d5-4749-9c9a-5d117de6c96c",
        "tags" : [
        ]
      },
      {
        "id" : "7571d9db-0a37-4f8e-9d61-a1ad7e405493",
        "parentId" : "b8caf64d-a4bf-498c-93cc-3dd3d57fd804",
        "authorId" : "5c21df64-97d8-46ab-9722-a7e9ba1d7c49",
        "body" : "It does. I was trying to setup this test to fit how we're likely hitting this in practice. In the call to `addTxnMarkersToSend`, before calling `maybeWriteTxnCompletion`, we have to acquire the lock. It is possible that the caller fails to acquire the lock before the markers finish getting written and the transaction gets completed in the request completion handler.",
        "createdAt" : "2020-06-02T22:54:05Z",
        "updatedAt" : "2020-06-02T22:54:06Z",
        "lastEditedBy" : "5c21df64-97d8-46ab-9722-a7e9ba1d7c49",
        "tags" : [
        ]
      },
      {
        "id" : "29668cac-8ff1-4199-a930-8f51054dcc80",
        "parentId" : "b8caf64d-a4bf-498c-93cc-3dd3d57fd804",
        "authorId" : "eba565e8-e1d5-4749-9c9a-5d117de6c96c",
        "body" : "Got it, so when the bug still exist this test would probably not fail consistently, but would be flaky, right?",
        "createdAt" : "2020-06-03T01:23:15Z",
        "updatedAt" : "2020-06-03T01:23:15Z",
        "lastEditedBy" : "eba565e8-e1d5-4749-9c9a-5d117de6c96c",
        "tags" : [
        ]
      },
      {
        "id" : "ea751a15-ee34-41f1-9ed7-eb7c3811d7fe",
        "parentId" : "b8caf64d-a4bf-498c-93cc-3dd3d57fd804",
        "authorId" : "5c21df64-97d8-46ab-9722-a7e9ba1d7c49",
        "body" : "It fails deterministically without the fix.",
        "createdAt" : "2020-06-03T04:52:21Z",
        "updatedAt" : "2020-06-03T04:52:22Z",
        "lastEditedBy" : "5c21df64-97d8-46ab-9722-a7e9ba1d7c49",
        "tags" : [
        ]
      },
      {
        "id" : "ea179b9a-e8d6-48fb-aa85-20f335238ca1",
        "parentId" : "b8caf64d-a4bf-498c-93cc-3dd3d57fd804",
        "authorId" : "eba565e8-e1d5-4749-9c9a-5d117de6c96c",
        "body" : "Ah yes, I missed the `txnMetadata2.lock.lock()` before starting the scheduler, thanks.",
        "createdAt" : "2020-06-03T16:12:15Z",
        "updatedAt" : "2020-06-03T16:12:16Z",
        "lastEditedBy" : "eba565e8-e1d5-4749-9c9a-5d117de6c96c",
        "tags" : [
        ]
      }
    ],
    "commit" : "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f",
    "line" : 30,
    "diffHunk" : "@@ -1,1 +92,96 @@\n  @Test\n  def shouldOnlyWriteTxnCompletionOnce(): Unit = {\n    mockCache()\n"
  },
  {
    "id" : "6c58148a-596c-4343-9496-aa8fe672043f",
    "prId" : 8782,
    "prUrl" : "https://github.com/apache/kafka/pull/8782#pullrequestreview-423054665",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "18112d7b-12c4-4ab2-bc75-f0cb4f5ee20a",
        "parentId" : null,
        "authorId" : "eba565e8-e1d5-4749-9c9a-5d117de6c96c",
        "body" : "Nice catch. Not sure why they did not fail before :)",
        "createdAt" : "2020-06-02T21:02:03Z",
        "updatedAt" : "2020-06-02T21:06:08Z",
        "lastEditedBy" : "eba565e8-e1d5-4749-9c9a-5d117de6c96c",
        "tags" : [
        ]
      }
    ],
    "commit" : "c52dc75c8e7a970d2bd8708dbdccb8cf44d8dd0f",
    "line" : 109,
    "diffHunk" : "@@ -1,1 +359,363 @@    val response = new WriteTxnMarkersResponse(createPidErrorMap(Errors.NONE))\n    for (requestAndHandler <- requestAndHandlers) {\n      requestAndHandler.handler.onComplete(new ClientResponse(new RequestHeader(ApiKeys.WRITE_TXN_MARKERS, 0, \"client\", 1),\n        null, null, 0, 0, false, null, null, response))\n    }"
  }
]