[
  {
    "id" : "90f35e23-0327-40ea-a1a3-43f2d31034fa",
    "prId" : 423,
    "prUrl" : "https://github.com/zio/zio/pull/423#pullrequestreview-182275788",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "76092a60-0d54-4f48-8731-5b94bac0ef15",
        "parentId" : null,
        "authorId" : "94a9bd21-bc51-4681-8e4e-61d5917ea48f",
        "body" : "I was surprised to see that backpressured benchmark showed much higher throughput than parallel, even for fs2:\r\n```\r\nBackpressure\r\n[info] Benchmark                             Mode  Cnt     Score       Error  Units\r\n[info] QueueBackPressureBenchmark.fs2Queue  thrpt    3    51.871 ±     2.813  ops/s\r\n[info] QueueBackPressureBenchmark.zioQueue  thrpt    3  3658.171 ± 13240.533  ops/s\r\n\r\nParallel\r\n[info] Benchmark                         Mode  Cnt    Score     Error  Units\r\n[info] QueueParallelBenchmark.fs2Queue  thrpt    3    1.354 ±   0.101  ops/s\r\n[info] QueueParallelBenchmark.zioQueue  thrpt    3  452.826 ± 106.976  ops/s\r\n```\r\nDo you have an ideas why it could be so?",
        "createdAt" : "2018-12-06T13:04:37Z",
        "updatedAt" : "2018-12-06T14:54:39Z",
        "lastEditedBy" : "94a9bd21-bc51-4681-8e4e-61d5917ea48f",
        "tags" : [
        ]
      },
      {
        "id" : "20847561-40a8-4796-afbd-6161be42632b",
        "parentId" : "76092a60-0d54-4f48-8731-5b94bac0ef15",
        "authorId" : "73db9f28-01ba-4a29-946b-7a2ae5ac5350",
        "body" : "Yeah there is something wrong. I had the following results before:\r\n```\r\nBenchmark                                 Mode    Cnt    Score    Error  Units\r\n\r\nQueueSequentialBenchmark.fs2Queue         thrpt    3    1.223 ±   0.140  ops/s\r\nQueueSequentialBenchmark.zioQueue[OLD]    thrpt    3    1.648 ±   1.382  ops/s\r\nQueueSequentialBenchmark.zioQueue[NEW]    thrpt    3  252.721 ±  15.430  ops/s\r\n\r\nQueueParallelBenchmark.fs2Queue           thrpt    3    1.022 ±   0.077  ops/s\r\nQueueParallelBenchmark.zioQueue[OLD]      thrpt    3  149.937 ±   8.778  ops/s\r\nQueueParallelBenchmark.zioQueue[NEW]      thrpt    3  685.956 ± 129.736  ops/s\r\n\r\nQueueBackPressureBenchmark.fs2Queue       thrpt    3   30.665 ±  68.346  ops/s\r\nQueueBackPressureBenchmark.zioQueue[OLD]  thrpt    3   66.530 ±  15.322  ops/s\r\nQueueBackPressureBenchmark.zioQueue[NEW]  thrpt    3   80.792 ±   9.859  ops/s\r\n```\r\nI'll try to find what caused that difference.",
        "createdAt" : "2018-12-06T13:43:10Z",
        "updatedAt" : "2018-12-06T14:54:39Z",
        "lastEditedBy" : "73db9f28-01ba-4a29-946b-7a2ae5ac5350",
        "tags" : [
        ]
      },
      {
        "id" : "d15b08b6-c3f4-4213-b216-1b6eac73f1d3",
        "parentId" : "76092a60-0d54-4f48-8731-5b94bac0ef15",
        "authorId" : "73db9f28-01ba-4a29-946b-7a2ae5ac5350",
        "body" : "OK it's the RTS override. Without it I get normal results. Any idea what's wrong with it?",
        "createdAt" : "2018-12-06T13:49:16Z",
        "updatedAt" : "2018-12-06T14:54:39Z",
        "lastEditedBy" : "73db9f28-01ba-4a29-946b-7a2ae5ac5350",
        "tags" : [
        ]
      },
      {
        "id" : "e84634f7-f2da-46ab-8adc-380ba6e09543",
        "parentId" : "76092a60-0d54-4f48-8731-5b94bac0ef15",
        "authorId" : "94a9bd21-bc51-4681-8e4e-61d5917ea48f",
        "body" : "Probably `threadPool.allowCoreThreadTimeOut(true)` - might be doing something funny and mess with the benchmark.\r\n\r\n*Edit:* nope, not it, just ran and results are still weird.",
        "createdAt" : "2018-12-06T14:06:11Z",
        "updatedAt" : "2018-12-06T14:54:39Z",
        "lastEditedBy" : "94a9bd21-bc51-4681-8e4e-61d5917ea48f",
        "tags" : [
        ]
      },
      {
        "id" : "087f3030-c311-44f8-aafd-a6a8ae2b5664",
        "parentId" : "76092a60-0d54-4f48-8731-5b94bac0ef15",
        "authorId" : "73db9f28-01ba-4a29-946b-7a2ae5ac5350",
        "body" : "Yeah, it seems it's the fact I override `threadPool` that causes the problem. I tried to override it with the exact same content as `newDefaultThreadPool` in RTS and there's the same problem. If I remove that override it works well.",
        "createdAt" : "2018-12-06T14:16:05Z",
        "updatedAt" : "2018-12-06T14:54:39Z",
        "lastEditedBy" : "73db9f28-01ba-4a29-946b-7a2ae5ac5350",
        "tags" : [
        ]
      },
      {
        "id" : "e4ae76f1-85ec-4463-bbeb-56dacf1f2306",
        "parentId" : "76092a60-0d54-4f48-8731-5b94bac0ef15",
        "authorId" : "94a9bd21-bc51-4681-8e4e-61d5917ea48f",
        "body" : "BTW I see in your message above in results for fs2: BackPressure.fs2 = 30 > Parallel.fs2 = 1. Do you have an idea why backpressured fs2 scores lower?",
        "createdAt" : "2018-12-06T14:32:39Z",
        "updatedAt" : "2018-12-06T14:54:39Z",
        "lastEditedBy" : "94a9bd21-bc51-4681-8e4e-61d5917ea48f",
        "tags" : [
        ]
      },
      {
        "id" : "35796b00-3a96-4386-b0de-c18491955f1f",
        "parentId" : "76092a60-0d54-4f48-8731-5b94bac0ef15",
        "authorId" : "73db9f28-01ba-4a29-946b-7a2ae5ac5350",
        "body" : "No I haven't looked at their implementation. Overall I imagine it's not designed for atomic operations like we do here and is probably more efficient with the stream methods.",
        "createdAt" : "2018-12-06T14:52:40Z",
        "updatedAt" : "2018-12-06T14:54:39Z",
        "lastEditedBy" : "73db9f28-01ba-4a29-946b-7a2ae5ac5350",
        "tags" : [
        ]
      }
    ],
    "commit" : "57b3224b484dde4a808693756f679de5f3696a93",
    "line" : 54,
    "diffHunk" : "@@ -1,1 +52,56 @@\n  @Benchmark\n  def fs2Queue(): Int = {\n\n    def repeat(task: CIO[Unit], max: Int): CIO[Unit] ="
  }
]