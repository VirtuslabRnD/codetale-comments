[
  {
    "id" : "69bd1b30-3718-44a0-bbd6-16de1631c52b",
    "prId" : 10899,
    "prUrl" : "https://github.com/apache/kafka/pull/10899#pullrequestreview-688665997",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "a22aeddf-0139-47e9-bef4-b2c83b37321a",
        "parentId" : null,
        "authorId" : "4a7c311c-0954-4671-a0d2-266cb67437ad",
        "body" : "I think we need to do this before appending the batches above.",
        "createdAt" : "2021-06-18T23:11:52Z",
        "updatedAt" : "2021-06-18T23:12:38Z",
        "lastEditedBy" : "4a7c311c-0954-4671-a0d2-266cb67437ad",
        "tags" : [
        ]
      },
      {
        "id" : "fb6b3923-c8d1-4962-80d2-443a758b03e9",
        "parentId" : "a22aeddf-0139-47e9-bef4-b2c83b37321a",
        "authorId" : "a4dbaf80-7a7c-4314-af6e-b4cf858a6ce2",
        "body" : "Would we not want to drain the pipe (here accumulator) before finalizing it (by stamping the footer). I guess your point is that the footer is yet another record which we can append and then just do one final drain?\r\nPS right now in the code the finalize method is also forcing a drain on the accumulator. We could remove that too then. \r\n\r\nLet me do it that way.",
        "createdAt" : "2021-06-21T16:44:46Z",
        "updatedAt" : "2021-06-21T16:44:46Z",
        "lastEditedBy" : "a4dbaf80-7a7c-4314-af6e-b4cf858a6ce2",
        "tags" : [
        ]
      },
      {
        "id" : "ed0c9fa0-635a-4541-9f98-007bec96d54c",
        "parentId" : "a22aeddf-0139-47e9-bef4-b2c83b37321a",
        "authorId" : "4a7c311c-0954-4671-a0d2-266cb67437ad",
        "body" : "When `freeze` is called it is possible that the `accumulator` has batches. When freezing the `SnapshotWriter`, it needs to:\r\n1. Add the footer batch to the accumulator\r\n2. Drain any pending batches in the accumulator including the control batch appended in 1.\r\n3. Append those batches to the underlying `RawSnapshotWriter`.",
        "createdAt" : "2021-06-21T16:51:21Z",
        "updatedAt" : "2021-06-21T16:51:21Z",
        "lastEditedBy" : "4a7c311c-0954-4671-a0d2-266cb67437ad",
        "tags" : [
        ]
      },
      {
        "id" : "7c46c043-5c86-499d-857c-56f3889e955f",
        "parentId" : "a22aeddf-0139-47e9-bef4-b2c83b37321a",
        "authorId" : "a4dbaf80-7a7c-4314-af6e-b4cf858a6ce2",
        "body" : "Ahh. I was missing point 3. Understood your point. Will make the change.",
        "createdAt" : "2021-06-21T16:53:34Z",
        "updatedAt" : "2021-06-21T16:53:34Z",
        "lastEditedBy" : "a4dbaf80-7a7c-4314-af6e-b4cf858a6ce2",
        "tags" : [
        ]
      }
    ],
    "commit" : "9a924cbd5919c5a7faf3f57cfc5d054575305e10",
    "line" : 130,
    "diffHunk" : "@@ -1,1 +207,211 @@     */\n    public void freeze() {\n        finalizeSnapshotWithFooter();\n        appendBatches(accumulator.drain());\n        snapshot.freeze();"
  }
]