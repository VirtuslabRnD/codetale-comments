[
  {
    "id" : "c75922fc-ac15-4b63-9225-0560b77e7834",
    "prId" : 10569,
    "prUrl" : "https://github.com/conda-forge/staged-recipes/pull/10569#pullrequestreview-345316075",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "parentId" : null,
        "authorId" : "93a361c3-34f7-4e52-a7f9-28c8ec69c910",
        "body" : "This is a potentially dangerous thing to do in a patch BTW. If you are an expert in this code base and openmp, then ignore me. Otherwise, i'd hold off on defaulting variables to shared for far of a race condition.",
        "createdAt" : "2020-01-20T12:47:43Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "93a361c3-34f7-4e52-a7f9-28c8ec69c910",
        "tags" : [
        ]
      },
      {
        "id" : "96c5bf48-4361-47c8-b85b-2f7952ec8b56",
        "parentId" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "authorId" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "body" : "This seems to be a problem with imported constants in OMP and GCC7 when `default(none)` is used. The only way to fix this is using a newer GCC version or by switching from `default(none)` to `default(shared)`, I chose the latter here.",
        "createdAt" : "2020-01-20T13:13:43Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "tags" : [
        ]
      },
      {
        "id" : "de0915a5-f7ea-481e-b27d-8fda3e36149c",
        "parentId" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "authorId" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "body" : "Not the optimal solution but better than no OMP.",
        "createdAt" : "2020-01-20T13:18:29Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "tags" : [
        ]
      },
      {
        "id" : "b8e31bcf-61ea-4f16-9cac-dbdc30014a96",
        "parentId" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "authorId" : "93a361c3-34f7-4e52-a7f9-28c8ec69c910",
        "body" : "I don't agree. As an experience openmp user, this is a bad idea. Let's change the patch to explicitly add the constants not listed to the shared directive.",
        "createdAt" : "2020-01-20T13:22:15Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "93a361c3-34f7-4e52-a7f9-28c8ec69c910",
        "tags" : [
        ]
      },
      {
        "id" : "d53c0fd5-ce99-42e1-b5be-76c98154db9a",
        "parentId" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "authorId" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "body" : "This is actually the point, you can't add the constants explicitly. Compiling with `default(none)` and GCC7 gives:\r\n```\r\n../source/dftd4.f90:2232:0:\r\n\r\n             cij  = par%a1*sqrt(3._wp*r4r2(at(iat))*r4r2(at(jat)))+par%a2\r\n \r\nError: ‘sqrt_z_r4_over_r2’ not specified in enclosing ‘parallel’\r\n```\r\nadding it explicitly returns an error as well:\r\n```\r\n../source/dftd4.f90:2210:52:\r\n\r\n !$omp shared(nat,xyz,c6ab,rep,par,at,dlat,dc6ab,thr,r4r2) &\r\n                                                    1\r\nError: Object ‘sqrt_z_r4_over_r2’ is not a variable at (1)\r\n```",
        "createdAt" : "2020-01-20T13:30:32Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "tags" : [
        ]
      },
      {
        "id" : "c8017c84-2413-4275-ae2d-66067f777c03",
        "parentId" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "authorId" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "body" : "The constant is renamed with `r4r2 => sqrt_z_r4_over_r2` in the use statement, but the same happens when not renaming it (just tried it again to be sure).",
        "createdAt" : "2020-01-20T13:35:06Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "tags" : [
        ]
      },
      {
        "id" : "83ed24ee-1678-45b1-9e44-5e0943b2ba01",
        "parentId" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "authorId" : "93a361c3-34f7-4e52-a7f9-28c8ec69c910",
        "body" : "Can we try adding them as firstprivate? \r\n\r\nhttps://gcc.gnu.org/gcc-9/porting_to.html#ompdatasharing\r\n\r\nThen i'll give up.",
        "createdAt" : "2020-01-20T13:39:31Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "93a361c3-34f7-4e52-a7f9-28c8ec69c910",
        "tags" : [
        ]
      },
      {
        "id" : "9e1e0093-e970-4aef-a57c-c1cdc443c0c0",
        "parentId" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "authorId" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "body" : "Doesn't work either. It only happens with GCC7 and lower, GCC8 and Intel have it fixed.\r\n```\r\n../source/dftd4.f90:2211:19:\r\n\r\n !$omp firstprivate(r4r2) &\r\n                   1\r\nError: Object ‘sqrt_z_r4_over_r2’ is not a variable at (1)\r\n```",
        "createdAt" : "2020-01-20T13:43:27Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "13fc8ac3-304e-4b2d-b62d-f479c4eee931",
        "tags" : [
        ]
      },
      {
        "id" : "20dc54c6-c40c-4437-af45-b645cff914d5",
        "parentId" : "880f0093-af84-492c-bfd8-ae6697436d87",
        "authorId" : "93a361c3-34f7-4e52-a7f9-28c8ec69c910",
        "body" : "frack ok",
        "createdAt" : "2020-01-20T13:44:04Z",
        "updatedAt" : "2020-01-20T14:00:38Z",
        "lastEditedBy" : "93a361c3-34f7-4e52-a7f9-28c8ec69c910",
        "tags" : [
        ]
      }
    ],
    "commit" : "e0980dd93ad4a05ff545e916f3e1840a445c36f4",
    "line" : 46,
    "diffHunk" : "@@ -1,1 +44,48 @@ \n-!$OMP parallel default(none) &\n+!$OMP parallel default(shared) &\n !$omp private(i,ia,j,ja,ij,r2ij,c6ij,k,l,r)  &\n !$omp shared (mol,dispm,itbl,refc6,zvec) &"
  }
]