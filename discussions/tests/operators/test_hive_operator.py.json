[
  {
    "id" : "31ac458b-a098-49b5-b0ca-4c538121e3bb",
    "prId" : 6733,
    "prUrl" : "https://github.com/apache/airflow/pull/6733#pullrequestreview-327488332",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "a79567c8-142d-46bc-a377-2975a213c2ee",
        "parentId" : null,
        "authorId" : "e29ffafb-ac51-434b-b9e0-af262caae1ee",
        "body" : "@nuclearpinguin maybe you hadn't set `AIRFLOW_RUNALL_TESTS` ?",
        "createdAt" : "2019-12-05T11:25:23Z",
        "updatedAt" : "2019-12-05T13:36:06Z",
        "lastEditedBy" : "e29ffafb-ac51-434b-b9e0-af262caae1ee",
        "tags" : [
        ]
      },
      {
        "id" : "9da5ed73-8f5d-4416-aa17-ea413908718b",
        "parentId" : "a79567c8-142d-46bc-a377-2975a213c2ee",
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "No. It's not this. The AIRFLOW_RUNALL_TESTS is not set anyway (and never was in CI). It is something that we should handle separately as part of AIP-4 (support for system tests)  - this is a way by someone to skip running system tests on a CI build but have a way to run them locally (but it's not consistent/standardized as AIP-4 is supposed to do).\r\n\r\nI tracked it down and It is a bug in the Dockerfile in the way how dependencies are treated in the CI optimised build. I will create a JIRA ticket for that in a moment.  \r\n\r\nIt was supposed to be handled by this: \r\n\r\n```\r\n# Increase the value here to force reinstalling Apache Airflow pip dependencies\r\nARG PIP_DEPENDENCIES_EPOCH_NUMBER=\"2\"\r\nENV PIP_DEPENDENCIES_EPOCH_NUMBER=${PIP_DEPENDENCIES_EPOCH_NUMBER}\r\n```\r\n\r\nThis should trigger reinstallation of all dependencies from the scratch in case we know we deleted some dependencies (nose in this case). This is done via:\r\n\r\n```\r\npip install \\\r\n\"https://github.com/apache/airflow/archive/${AIRFLOW_BRANCH}.tar.gz#egg=apache-airflow[${AIRFLOW_EXTRAS}]\" \\\r\n        && pip uninstall --yes apache-airflow;\r\n```\r\nHowever in case of PR from another repo, AIRFLOW_BRANCH is still set to \"master\" (this is the TARGET branch) and it uses \"airflow\" Github organisation/user. \r\n\r\nThis means that in the PR, dependencies will be installed first from the master branch of Airflow. Which (at the time of PR) included nose.\r\n\r\nWhat it SHOULD happen instead - in case of PR, it should be something like:\r\n\r\n```\r\npip install \\\r\n\"https://github.com/apache/${SOURCE_GITHUB_USER}/archive/${SOURCE_BRANCH}.tar.gz#egg=apache-airflow[${AIRFLOW_EXTRAS}]\" \\\r\n        && pip uninstall --yes apache-airflow;\r\n```\r\n\r\nThis perfectly explains what happened.\r\n\r\n\r\n",
        "createdAt" : "2019-12-05T11:38:30Z",
        "updatedAt" : "2019-12-05T13:36:06Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "33166823-2abe-4153-bb65-81ccb1210ad1",
        "parentId" : "a79567c8-142d-46bc-a377-2975a213c2ee",
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "Created: https://issues.apache.org/jira/browse/AIRFLOW-6178\r\n",
        "createdAt" : "2019-12-05T11:41:12Z",
        "updatedAt" : "2019-12-05T13:36:06Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      }
    ],
    "commit" : "2293d35b45111973288bf3b06d3655c1baca9f18",
    "line" : 14,
    "diffHunk" : "@@ -1,1 +154,158 @@\n\nif 'AIRFLOW_RUNALL_TESTS' in os.environ:\n\n    class TestHivePresto(TestHiveEnvironment):"
  }
]