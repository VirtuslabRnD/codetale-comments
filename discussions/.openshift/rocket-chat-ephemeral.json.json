[
  {
    "id" : "988d5f3e-0b0f-429a-a67e-f5d88825b198",
    "prId" : 7184,
    "prUrl" : "https://github.com/RocketChat/Rocket.Chat/pull/7184#pullrequestreview-43242917",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "1fd3a417-06ba-4bb5-b1f4-5c2406279aaa",
        "parentId" : null,
        "authorId" : "beb0c9ad-a917-4bb6-948e-12669fdc6784",
        "body" : "So on larger servers it takes longer for instances to start up.  Might need to add some variation in here.\r\n\r\nI'm actually struggling with this a bit my self. Our demo server takes 3-4 minutes on initial load because of all of the users and channels it has to load into cache.  Also a bit depending on hardware underneath.\r\n\r\nwhen I threw our demo server on k8s I had to actually adjust the readiness check to something like:\r\n```\r\n                        \"livenessProbe\": {\r\n                            \"failureThreshold\": 3,\r\n                            \"httpGet\": {\r\n                                \"path\": \"/api/info\",\r\n                                \"port\": 3000,\r\n                                \"scheme\": \"HTTP\"\r\n                            },\r\n                            \"initialDelaySeconds\": 300,\r\n                            \"periodSeconds\": 10,\r\n                            \"successThreshold\": 1,\r\n                            \"timeoutSeconds\": 1\r\n                        },\r\n                        \"readinessProbe\": {\r\n                            \"failureThreshold\": 32,\r\n                            \"httpGet\": {\r\n                                \"path\": \"/api/info\",\r\n                                \"port\": 3000,\r\n                                \"scheme\": \"HTTP\"\r\n                            },\r\n                            \"initialDelaySeconds\": 10,\r\n                            \"periodSeconds\": 10,\r\n                            \"successThreshold\": 1,\r\n                            \"timeoutSeconds\": 1\r\n                        },\r\n```\r\n\r\nMy thoughts here were readiness probe needs to be agressive.  We want to serve traffic to the instance as fast as possible.  But pushing the liveness check back a bit to keep it from killing an instance that is still in the process of starting up.\r\n\r\nWhat are your thoughts here?",
        "createdAt" : "2017-06-08T17:18:36Z",
        "updatedAt" : "2017-06-08T17:20:36Z",
        "lastEditedBy" : "beb0c9ad-a917-4bb6-948e-12669fdc6784",
        "tags" : [
        ]
      },
      {
        "id" : "4870bd4f-6aa1-4439-bbc8-01287d856c37",
        "parentId" : "1fd3a417-06ba-4bb5-b1f4-5c2406279aaa",
        "authorId" : "b04f8fdc-d4b6-4dc3-9a20-b4473de9857c",
        "body" : "@geekgonecrazy I didn't know it is 'normal' for RocketChat to take many seconds (minutes??) to start on larger servers. If this is indeed the norm, I agree that the numbers I submitted in my PR are too low (they are the kubernetes defaults).\r\n\r\nThe readiness probe is the one that checks if the pod is ready on startup. It is common to see a larger delay on this one because of situations like the one you describe. That would be the one we would increase. The liveness probe ensures the app passes a check every X seconds to ensure it hasn't transited into a bad state.\r\n\r\nI assume that on small-medium sized instances, the startup time is relatively short. I'm not sure if 300 seconds is a sane default for most people. Then if you manage a very large instance on kubernetes I would assume that you know you can increase these numbers. How about a delay of 15 seconds? Would that be suitable for most people?",
        "createdAt" : "2017-06-08T20:42:26Z",
        "updatedAt" : "2017-06-08T20:42:26Z",
        "lastEditedBy" : "b04f8fdc-d4b6-4dc3-9a20-b4473de9857c",
        "tags" : [
        ]
      },
      {
        "id" : "c0f84bda-8c6d-44e7-9652-f60cb2216201",
        "parentId" : "1fd3a417-06ba-4bb5-b1f4-5c2406279aaa",
        "authorId" : "beb0c9ad-a917-4bb6-948e-12669fdc6784",
        "body" : "@jfchevrette I've been digging in the documentation recently and couldn't tell does the liveness check wait to start until after readiness check?\r\n\r\nhttps://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/\r\n\r\nIf it does wait, the defaults for liveness are probably just fine.",
        "createdAt" : "2017-06-08T21:13:18Z",
        "updatedAt" : "2017-06-08T21:16:58Z",
        "lastEditedBy" : "beb0c9ad-a917-4bb6-948e-12669fdc6784",
        "tags" : [
        ]
      },
      {
        "id" : "d2f2d8d1-e4c1-4fd0-81b2-21a3a37f4cd9",
        "parentId" : "1fd3a417-06ba-4bb5-b1f4-5c2406279aaa",
        "authorId" : "beb0c9ad-a917-4bb6-948e-12669fdc6784",
        "body" : "@jfchevrette did a little verifying.  So it does not wait on readiness check to pass.  Which is a bit unfortunate.  In the future might be able to substitute this for a command in the container that would know that it was still in the process of starting.  I'll go ahead and approve this and we can tweak this as time goes on based on feedback.  \r\n\r\nThanks!",
        "createdAt" : "2017-06-09T19:32:22Z",
        "updatedAt" : "2017-06-09T19:32:23Z",
        "lastEditedBy" : "beb0c9ad-a917-4bb6-948e-12669fdc6784",
        "tags" : [
        ]
      }
    ],
    "commit" : "5fb79559f29b56ec4aae3e97c90fdc04056a1ca3",
    "line" : 14,
    "diffHunk" : "@@ -1,1 +273,277 @@                                    \"periodSeconds\": 10,\n                                    \"successThreshold\": 1,\n                                    \"failureThreshold\": 3\n                                },\n                                \"livenessProbe\": {"
  }
]