[
  {
    "id" : "4e3db0b2-6f25-4148-8198-e8615bbce49b",
    "prId" : 6045,
    "prUrl" : "https://github.com/apache/kafka/pull/6045#pullrequestreview-193165036",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "008d0efe-2f6b-47ad-8b45-813959dbcbf8",
        "parentId" : null,
        "authorId" : "5c21df64-97d8-46ab-9722-a7e9ba1d7c49",
        "body" : "Just double-checking if the intent is to keep this in sync with the map above. Now the `Cluster` is only computed on construction.",
        "createdAt" : "2019-01-16T01:48:34Z",
        "updatedAt" : "2019-01-17T15:43:00Z",
        "lastEditedBy" : "5c21df64-97d8-46ab-9722-a7e9ba1d7c49",
        "tags" : [
        ]
      },
      {
        "id" : "eff47d42-48a8-490d-9f7a-3cd766f227ef",
        "parentId" : "008d0efe-2f6b-47ad-8b45-813959dbcbf8",
        "authorId" : "083f2f03-ca7e-48a1-9781-482564dfdf53",
        "body" : "Right, I previously had the logic to recompute the Cluster when the partition was removed, but took that out since it made the partition count inaccurate. Now we are only removing partitions when the topic subscription has changed.\r\n\r\nI'll add the Cluster refresh back.\r\n\r\nHow about I change `MetadataCache#removePartitionInfo(TopicPartition)` to `MetadataCache#removePartitionInfosForTopic(String)` so we only remove an entire topic rather than a single partition. This should avoid the situation where the partition count in Cluster is inaccurate. That would change the behavior to be like:\r\n\r\n```\r\nmetadata.setTopics(Collections.singletonList(\"topic-2\"));\r\n\r\n// now metadata for other topics is unavailable\r\nassertNull(metadata.fetch().partition(tp));\r\nassertNull(metadata.fetch().partitionCountForTopic(\"topic-1\"));\r\nassertFalse(metadata.partitionInfoIfCurrent(tp).isPresent());\r\n```",
        "createdAt" : "2019-01-16T14:35:05Z",
        "updatedAt" : "2019-01-17T15:43:00Z",
        "lastEditedBy" : "083f2f03-ca7e-48a1-9781-482564dfdf53",
        "tags" : [
        ]
      }
    ],
    "commit" : "7ba0768420c04aa546906895016671fd544ff38f",
    "line" : 49,
    "diffHunk" : "@@ -1,1 +47,51 @@    private final Map<TopicPartition, PartitionInfoAndEpoch> metadataByPartition;\n\n    private Cluster clusterInstance;\n\n    MetadataCache(String clusterId,"
  },
  {
    "id" : "387d78a8-3ace-4b56-bc1a-5fd119f1a939",
    "prId" : 6879,
    "prUrl" : "https://github.com/apache/kafka/pull/6879#pullrequestreview-245592005",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f0156ba5-5d44-4445-8981-592751e24d47",
        "parentId" : null,
        "authorId" : "083f2f03-ca7e-48a1-9781-482564dfdf53",
        "body" : "This collection includes PartitionInfo and the leader epoch.",
        "createdAt" : "2019-06-04T17:27:13Z",
        "updatedAt" : "2019-06-04T17:27:13Z",
        "lastEditedBy" : "083f2f03-ca7e-48a1-9781-482564dfdf53",
        "tags" : [
        ]
      }
    ],
    "commit" : "406edb7a6dd6995a75436ee58d0021afa5ff8570",
    "line" : 7,
    "diffHunk" : "@@ -1,1 +140,144 @@                \"clusterId='\" + clusterId + '\\'' +\n                \", nodes=\" + nodes +\n                \", partitions=\" + metadataByPartition.values() +\n                \", controller=\" + controller +\n                '}';"
  }
]