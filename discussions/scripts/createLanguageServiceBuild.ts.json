[
  {
    "id" : "d5b4143a-7298-4862-84ef-4dca8fe07090",
    "prId" : 33584,
    "prUrl" : "https://github.com/microsoft/TypeScript/pull/33584#pullrequestreview-295097094",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "parentId" : null,
        "authorId" : "7b7aae27-4774-41a7-bce2-94c871708547",
        "body" : "Do we have any other scripts that auto-publish? I don‚Äôt know what our publish process is like, but I assume it runs in CI. I would lean toward adding automation there rather than scripted into `postpublish`, as principle of least surprise.",
        "createdAt" : "2019-09-27T17:04:31Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "7b7aae27-4774-41a7-bce2-94c871708547",
        "tags" : [
        ]
      },
      {
        "id" : "c7fca5e7-9fa9-4386-8f59-9b682bc6dbc4",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "7b7aae27-4774-41a7-bce2-94c871708547",
        "body" : "IOW, the code seems fine (but I‚Äôve never looked at our packing process before either, so I‚Äôm not the best one to review), but I‚Äôm skeptical of the trigger",
        "createdAt" : "2019-09-27T17:05:47Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "7b7aae27-4774-41a7-bce2-94c871708547",
        "tags" : [
        ]
      },
      {
        "id" : "e2ae05fd-7cf8-49e9-9ba4-b4034036db13",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "9302e396-f4ae-400e-962a-ed2cd3258fdf",
        "body" : "Nope, it doesn't happen on CI (I am happy to move it to a new step in there) and/or look at moving to deploy _on_ CI ( e.g https://github.com/microsoft/types-publisher/pull/659 ) and all we do is ship a tag to indicate we want a release",
        "createdAt" : "2019-09-27T18:06:06Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "9302e396-f4ae-400e-962a-ed2cd3258fdf",
        "tags" : [
        ]
      },
      {
        "id" : "6f6f47d3-fd1e-46d3-a6ea-826698e8d42a",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "7b7aae27-4774-41a7-bce2-94c871708547",
        "body" : "Oh really? I figured we publish from here: https://dev.azure.com/typescript/TypeScript/_release?definitionId=1&view=mine&_a=releases",
        "createdAt" : "2019-09-27T20:24:59Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "7b7aae27-4774-41a7-bce2-94c871708547",
        "tags" : [
        ]
      },
      {
        "id" : "31300118-8de9-4300-9a12-17f0c2919463",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "body" : "We do! It definitely happens on CI! Anyone caught not publishing on CI will be [redacted]!",
        "createdAt" : "2019-09-27T20:45:27Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "tags" : [
        ]
      },
      {
        "id" : "f78bccc2-2088-4437-a5b4-1a6e28437034",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "body" : "Specifically: For all `release-x` branches, the node 12 build always produces a tarball based on the branch. Any one of those tarballs can be promoted (from the build UI) and published as a full release, which then triggers `npm publish`es and `github` releases. So the workflow is to prep the release branch, bump it's version, do an LKG, then fire off that generated tarball as the release.\r\n\r\nAt no point is an `npm publish` ever run on a folder in our repo ;)",
        "createdAt" : "2019-09-27T20:49:27Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "tags" : [
        ]
      },
      {
        "id" : "d2e05607-5760-423f-8e34-c2280edebc45",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "body" : "Specifically, we publish a prepared tarball _directly_, using `npm publish $(System.ArtifactsDirectory)/typescript.tgz --tag $(PUBLISH_TAG)`",
        "createdAt" : "2019-09-27T20:51:20Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "tags" : [
        ]
      },
      {
        "id" : "fa205c41-222a-42f6-bb58-993be425a467",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "body" : "So a `postpublish` script is actually wholly nonfunctional, since we don't even publish in a clone of our repo üòÑ ",
        "createdAt" : "2019-09-27T20:52:24Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "tags" : [
        ]
      },
      {
        "id" : "78c64310-e935-49af-bfe6-875db7b5c3d8",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "9302e396-f4ae-400e-962a-ed2cd3258fdf",
        "body" : "Hah! OK cool, perfect!\r\n\r\nI'll that and add the extra step on CI üëØ‚Äç‚ôÇ ",
        "createdAt" : "2019-09-29T12:33:56Z",
        "updatedAt" : "2019-09-30T12:42:18Z",
        "lastEditedBy" : "9302e396-f4ae-400e-962a-ed2cd3258fdf",
        "tags" : [
        ]
      },
      {
        "id" : "8b07a6fd-2ca3-4a37-8f49-709fe7bb6407",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "9302e396-f4ae-400e-962a-ed2cd3258fdf",
        "body" : "Cool - updated the deployment docs, and removed the auto-publish. Will give this a few hours for last feedback and merge today. Then once that's in I'll add the step to the pipeline.",
        "createdAt" : "2019-09-30T12:45:07Z",
        "updatedAt" : "2019-09-30T12:45:07Z",
        "lastEditedBy" : "9302e396-f4ae-400e-962a-ed2cd3258fdf",
        "tags" : [
        ]
      },
      {
        "id" : "8ec76198-6141-434b-ac9e-e7d5999d1552",
        "parentId" : "319c1ceb-4e29-45fa-b161-53482d67a1ff",
        "authorId" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "body" : "This script is _not executable_ in the release pipeline, as far as I'm aware. Releases are not executed within the context of the repo. (There's good reason for this, too, it means at no point does potentially malicious code get a chance to execute in a context where we have our publishing key set!) The code in the repo _does not exist_ in the release pipeline. To publish a second package, you would need to publish a _second_ pipeline artifact with the secondary tarball (which is just done with a few commands in the build pipeline, but I imagine you'll need to add a call to the `configure` script in addition to replicating those), and publish in a similar way as we do the first (with the `npm publish` release pipeline task). ",
        "createdAt" : "2019-09-30T16:23:47Z",
        "updatedAt" : "2019-09-30T16:23:47Z",
        "lastEditedBy" : "f7813195-22a2-4200-9f53-7aadb83a2cc9",
        "tags" : [
        ]
      }
    ],
    "commit" : "4c4a683d03f2141416cba1815231dded366bf259",
    "line" : 43,
    "diffHunk" : "@@ -1,1 +41,45 @@\n    step(`Deploying the language service`);\n    exec(\"npm publish --access public\", { cwd: packagePath });\n}\n"
  }
]