[
  {
    "id" : "96777b2a-e1f6-4b6a-8351-227e51d5a106",
    "prId" : 41471,
    "prUrl" : "https://github.com/tensorflow/tensorflow/pull/41471#pullrequestreview-450271496",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "8501ffb4-7e97-4eba-a2b3-e368b7216f4f",
        "parentId" : null,
        "authorId" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "body" : "`build_time` is not measured correct here. It should be started right after `strategy_scope`.",
        "createdAt" : "2020-07-16T23:01:48Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "tags" : [
        ]
      }
    ],
    "commit" : "d3459ca009e1185cbc15bf7724d0245601659847",
    "line" : 36,
    "diffHunk" : "@@ -1,1 +123,127 @@      t0 = timer()\n      model = model_fn()\n      build_time = timer() - t0\n\n      t1 = timer()"
  },
  {
    "id" : "9b6811c2-8b13-4b0b-ab73-eebe4b62026b",
    "prId" : 41471,
    "prUrl" : "https://github.com/tensorflow/tensorflow/pull/41471#pullrequestreview-450296334",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "312016c9-e1a4-42f4-981e-25def12d5b93",
        "parentId" : null,
        "authorId" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "body" : "Does compile need to be within strategy scope? IIUC, putting model_fn into it should work.",
        "createdAt" : "2020-07-16T23:38:44Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "tags" : [
        ]
      },
      {
        "id" : "524accd2-00f1-445d-b16c-e81b17700d63",
        "parentId" : "312016c9-e1a4-42f4-981e-25def12d5b93",
        "authorId" : "bf4831f2-82b5-4a18-8f91-f0f5386f60f7",
        "body" : "We should place `complie()` into the scope. I checked with [this post](https://keras.io/guides/distributed_training/#singlehost-multidevice-synchronous-training)  \r\n```\r\nwith strategy.scope():\r\n  # Everything that creates variables should be under the strategy scope.\r\n  # In general this is only model construction & `compile()`.\r\n  model = Model(...)\r\n  model.compile(...)\r\n```",
        "createdAt" : "2020-07-16T23:48:53Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "bf4831f2-82b5-4a18-8f91-f0f5386f60f7",
        "tags" : [
        ]
      },
      {
        "id" : "6a93c261-1e68-4b48-b4f2-9b9e2477e4c5",
        "parentId" : "312016c9-e1a4-42f4-981e-25def12d5b93",
        "authorId" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "body" : "Yeah, that's right! Both might have variable creations... I got the incorrect expression.",
        "createdAt" : "2020-07-17T00:14:13Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "tags" : [
        ]
      }
    ],
    "commit" : "d3459ca009e1185cbc15bf7724d0245601659847",
    "line" : 39,
    "diffHunk" : "@@ -1,1 +126,130 @@\n      t1 = timer()\n      model.compile(\n          optimizer=optimizer,\n          loss=loss,"
  },
  {
    "id" : "c9932c8f-4674-4ccb-b908-67ed168a00f9",
    "prId" : 41471,
    "prUrl" : "https://github.com/tensorflow/tensorflow/pull/41471#pullrequestreview-450296334",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "8598bb08-e3a8-4a18-9da7-06f0acc8bf62",
        "parentId" : null,
        "authorId" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "body" : "If you put `t0` here, the computation of`wall_time` below is wrong. Let's make a new variable to record the build time, so it won't affect the wall_time.",
        "createdAt" : "2020-07-17T00:16:28Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "tags" : [
        ]
      }
    ],
    "commit" : "d3459ca009e1185cbc15bf7724d0245601659847",
    "line" : 34,
    "diffHunk" : "@@ -1,1 +121,125 @@    strategy_scope = distribution_util.get_strategy_scope(strategy)\n    with strategy_scope:\n      t0 = timer()\n      model = model_fn()\n      build_time = timer() - t0"
  },
  {
    "id" : "c47fb309-3381-4311-8863-d327a8ae873c",
    "prId" : 41471,
    "prUrl" : "https://github.com/tensorflow/tensorflow/pull/41471#pullrequestreview-450882104",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "90e52474-fc44-4d61-8ba2-ff51d407c3db",
        "parentId" : null,
        "authorId" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "body" : "Currently, the distribution_strategy is made to be off by default. But it will go through all the checking of dist-strat. This might be not some overhead for the current benchmark tests with no dist-strat.\r\n\r\nI think either we preprocess strategy only when the arg `distribution_strategy` is not off, or we make some of our benchmark tests use dist-strat, so it's fine to leave the checking in the main branch. WDYT?",
        "createdAt" : "2020-07-17T00:20:25Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "tags" : [
        ]
      },
      {
        "id" : "ff019312-864f-4dab-ab1c-7e1f87ebeef9",
        "parentId" : "90e52474-fc44-4d61-8ba2-ff51d407c3db",
        "authorId" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "body" : "Probably it's also good to have one or two benchmark tests using dist-strat with gpus. The gpu number is not necessary to be large, like one or two, as our model is not that large.\r\n\r\nSome references: https://github.com/tensorflow/models/blob/0069c9328721f4f0aecb4de16d276d320f21876b/official/benchmark/keras_cifar_benchmark.py#L166\r\n",
        "createdAt" : "2020-07-17T00:24:19Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "tags" : [
        ]
      },
      {
        "id" : "f10cb337-d020-4452-b5f7-8e75e3369724",
        "parentId" : "90e52474-fc44-4d61-8ba2-ff51d407c3db",
        "authorId" : "bf4831f2-82b5-4a18-8f91-f0f5386f60f7",
        "body" : "> I think either we preprocess strategy only when the arg `distribution_strategy` is not off, or we make some of our benchmark tests use dist-strat, so it's fine to leave the checking in the main branch. WDYT?\r\n\r\nI think we can set default value of `distribution_strategy` as `mirrored` and if there is no gpu, it will use[ CPU instead](https://github.com/tensorflow/tensorflow/pull/41471/files#diff-9fb2f51ac75dc0b35e5e0a75bdaf9516R126), . So, it should be fine.",
        "createdAt" : "2020-07-17T00:38:13Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "bf4831f2-82b5-4a18-8f91-f0f5386f60f7",
        "tags" : [
        ]
      },
      {
        "id" : "8b44954f-0375-4e54-97fd-80d29b69c5e6",
        "parentId" : "90e52474-fc44-4d61-8ba2-ff51d407c3db",
        "authorId" : "bf4831f2-82b5-4a18-8f91-f0f5386f60f7",
        "body" : "> Probably it's also good to have one or two benchmark tests using dist-strat with gpus. The gpu number is not necessary to be large, like one or two, as our model is not that large.\r\n\r\nYeah, we can change the current benchmark tests later and use gpu.\r\n",
        "createdAt" : "2020-07-17T00:39:12Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "bf4831f2-82b5-4a18-8f91-f0f5386f60f7",
        "tags" : [
        ]
      },
      {
        "id" : "5ddb50de-cc55-4064-8f27-be3303fa3015",
        "parentId" : "90e52474-fc44-4d61-8ba2-ff51d407c3db",
        "authorId" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "body" : "For now, as there is no benchmark test using dist-strat, it's okay to set it as off. Now num_gpus is also set as 0, so let's keep it as off.\r\n\r\nIf in the following PR we do have benchmarks running with dist-strat, it's okay to have dist-strat checking in the main branch. Let's make sure this will happen in next PRs then.",
        "createdAt" : "2020-07-17T05:16:10Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "tags" : [
        ]
      },
      {
        "id" : "cb5641f1-2ba2-4dac-be52-a4fb251d5a0f",
        "parentId" : "90e52474-fc44-4d61-8ba2-ff51d407c3db",
        "authorId" : "bf4831f2-82b5-4a18-8f91-f0f5386f60f7",
        "body" : "Yes, we will add/change examples that will use dist-strat. Also, I checked code and if it is `off`, it returns None (and return dummy context), so it will not go through all checks in `distribution_util`.",
        "createdAt" : "2020-07-17T14:31:33Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "bf4831f2-82b5-4a18-8f91-f0f5386f60f7",
        "tags" : [
        ]
      },
      {
        "id" : "ce947f67-4820-42f4-aedd-78bea96c8efd",
        "parentId" : "90e52474-fc44-4d61-8ba2-ff51d407c3db",
        "authorId" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "body" : "SGTM. Let's target dist-strat in next PR then.",
        "createdAt" : "2020-07-17T18:45:12Z",
        "updatedAt" : "2020-07-20T19:39:38Z",
        "lastEditedBy" : "c5f7f69a-d6ad-4ba9-936a-dacb422dc71b",
        "tags" : [
        ]
      }
    ],
    "commit" : "d3459ca009e1185cbc15bf7724d0245601659847",
    "line" : 13,
    "diffHunk" : "@@ -1,1 +111,115 @@  total_num_examples = epochs * num_examples\n\n  strategy = distribution_util.get_distribution_strategy(\n      distribution_strategy=distribution_strategy,\n      num_gpus=num_gpus)"
  }
]