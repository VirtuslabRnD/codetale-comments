[
  {
    "id" : "38fa2fb4-d93d-484b-8537-094493b32510",
    "prId" : 17171,
    "prUrl" : "https://github.com/tensorflow/tensorflow/pull/17171#pullrequestreview-99008462",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f7ccaebb-c8d5-4e59-b9e3-dab13656a95a",
        "parentId" : null,
        "authorId" : "28fabc34-a1ac-4aba-988b-9c9e03232122",
        "body" : "What if we guard the include with \"ifdef GOOGLE_CUDA\" ?",
        "createdAt" : "2018-02-22T18:24:23Z",
        "updatedAt" : "2018-02-22T18:24:34Z",
        "lastEditedBy" : "28fabc34-a1ac-4aba-988b-9c9e03232122",
        "tags" : [
        ]
      },
      {
        "id" : "46fc573f-d64e-4182-9a43-8d4db326533b",
        "parentId" : "f7ccaebb-c8d5-4e59-b9e3-dab13656a95a",
        "authorId" : "2e2bd1af-4904-4ba3-aa3c-2ec5ad220327",
        "body" : "I tried doing that, but discovered that CPU builds also set GOOGLE_CUDA (see [tensorflow.bzl#1](https://github.com/tensorflow/tensorflow/blob/9054c9b2ac303cbd1538166d0821f389cbc75894/tensorflow/tensorflow.bzl#L913) and [tensorflow.bzl#2](https://github.com/tensorflow/tensorflow/blob/9054c9b2ac303cbd1538166d0821f389cbc75894/tensorflow/tensorflow.bzl#L203), both seem to propagate to '.cc' files as well as '.cu.cc' files)\r\nProbably `tensorflow.bzl` shouldn't set `GOOGLE_CUDA`, as this define is handled by the [GPU crosstool] (https://github.com/tensorflow/tensorflow/blob/9054c9b2ac303cbd1538166d0821f389cbc75894/third_party/gpus/cuda/build_defs.bzl.tpl#L18).\r\n\r\nHowever when I tried removing '-DGOOGLE_CUDA=1' from `tensorflow.bzl`, but I got a bunch of link errors and didn't investigate any further. Even if we want to dig deeper into this, it would be nice to have a workaround to unbreak cuda_clang while we investigate.",
        "createdAt" : "2018-02-23T09:34:09Z",
        "updatedAt" : "2018-02-23T09:34:09Z",
        "lastEditedBy" : "2e2bd1af-4904-4ba3-aa3c-2ec5ad220327",
        "tags" : [
        ]
      },
      {
        "id" : "facb4f69-db4f-4887-9213-436448b6dd24",
        "parentId" : "f7ccaebb-c8d5-4e59-b9e3-dab13656a95a",
        "authorId" : "28fabc34-a1ac-4aba-988b-9c9e03232122",
        "body" : "You are right, that seems like a bug.\r\nIf this works as is now, I am OK with merging it.",
        "createdAt" : "2018-02-23T18:34:25Z",
        "updatedAt" : "2018-02-23T18:34:25Z",
        "lastEditedBy" : "28fabc34-a1ac-4aba-988b-9c9e03232122",
        "tags" : [
        ]
      }
    ],
    "commit" : "edd46dd1b3817c847a76bc3b7490e923037e62c2",
    "line" : 6,
    "diffHunk" : "@@ -1,1 +19,23 @@\n// This file requires the following include because it uses CudaAtomicMax:\n// #include \"tensorflow/core/util/cuda_kernel_helper.h\"\n\n// Unfortunately we can't add the #include, since it breaks compilation for"
  }
]