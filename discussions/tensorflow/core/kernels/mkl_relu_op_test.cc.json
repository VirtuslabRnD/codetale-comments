[
  {
    "id" : "f0ca47c0-c89d-495e-964a-861ea053e6ba",
    "prId" : 39563,
    "prUrl" : "https://github.com/tensorflow/tensorflow/pull/39563#pullrequestreview-429877802",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "b46d256f-fcc8-4325-962b-239eb14f2525",
        "parentId" : null,
        "authorId" : "72acf7f0-6473-4b57-a71f-2a44410818c5",
        "body" : "Let's set this for the user instead. We can add our own `main()` function, based on the template here\r\nhttps://github.com/tensorflow/tensorflow/blob/0317f64491ba42376d96b157983a02d8b31b679e/tensorflow/core/platform/test_main.cc#L29-L47\r\n\r\nWe can add the code to set the environment variables in the main function. Please put the main function at the end of this file (but move the headers to the top).\r\n```c++\r\n#include <string>\r\n\r\n#include \"absl/strings/match.h\"\r\n#include \"tensorflow/core/platform/cpu_info.h\"\r\n#include \"tensorflow/core/platform/env.h\"\r\n#include \"tensorflow/core/platform/stacktrace_handler.h\"\r\n#include \"tensorflow/core/platform/test.h\"\r\n#include \"tensorflow/core/platform/test_benchmark.h\"\r\n\r\nGTEST_API_ int main(int argc, char** argv) {\r\n  // Sets OpenMP environment variables.\r\n  // TODO(intel-tf): Remove this when OpenMP is removed.\r\n  tensorflow::setenv(\"KMP_BLOCKTIME\", \"0\", true /*overwrite*/);\r\n  tensorflow::setenv(\"OMP_NUM_THREADS\",\r\n                     std::to_string(tensorflow::port::MaxParallelism()).c_str(),\r\n                     true /*overwrite*/);\r\n\r\n  tensorflow::testing::InstallStacktraceHandler();\r\n  testing::InitGoogleTest(&argc, argv);\r\n  for (int i = 1; i < argc; i++) {\r\n    if (absl::StartsWith(argv[i], \"--benchmarks=\")) {\r\n      const char* pattern = argv[i] + strlen(\"--benchmarks=\");\r\n      tensorflow::testing::Benchmark::Run(pattern);\r\n      return 0;\r\n    }\r\n  }\r\n  return RUN_ALL_TESTS();\r\n}\r\n```\r\n\r\nPlease also remove `//tensorflow/core/platform:test_main` from the dependencies. (Otherwise, there will be two main functions.)",
        "createdAt" : "2020-06-06T07:50:14Z",
        "updatedAt" : "2020-06-10T19:53:01Z",
        "lastEditedBy" : "72acf7f0-6473-4b57-a71f-2a44410818c5",
        "tags" : [
        ]
      },
      {
        "id" : "b25c0f8f-d6d6-43ef-872b-a54e09dded03",
        "parentId" : "b46d256f-fcc8-4325-962b-239eb14f2525",
        "authorId" : "f1b3c014-4b6e-43e3-b9bc-45605cfc1356",
        "body" : "I tried to make this change. It works for MKL build, but fails for Eigen build since it cannot find `main` for building `mkl_relu_op_test` in eigen build. `tf_cc_test_mkl` build rule skips the source file containing `main` for eigen build completely. That leads to the problem.",
        "createdAt" : "2020-06-10T19:50:45Z",
        "updatedAt" : "2020-06-10T19:53:01Z",
        "lastEditedBy" : "f1b3c014-4b6e-43e3-b9bc-45605cfc1356",
        "tags" : [
        ]
      },
      {
        "id" : "ba92bf22-7bed-4b95-8c4b-23a73f4ce5da",
        "parentId" : "b46d256f-fcc8-4325-962b-239eb14f2525",
        "authorId" : "72acf7f0-6473-4b57-a71f-2a44410818c5",
        "body" : "Got it. I see that `mkl_conv_ops_test.cc` also has this problem. I'll fix them both later then. (If I can get to it before we fully switch to custom thread pool.)",
        "createdAt" : "2020-06-12T16:25:00Z",
        "updatedAt" : "2020-06-12T16:25:00Z",
        "lastEditedBy" : "72acf7f0-6473-4b57-a71f-2a44410818c5",
        "tags" : [
        ]
      }
    ],
    "commit" : "eef7be73987ab556e954260cbef3e82ccbcee8e8",
    "line" : 44,
    "diffHunk" : "@@ -1,1 +42,46 @@// Before running these benchmarks configure OpenMP environment variables:\n//   export KMP_BLOCKTIME=0\n//   export OMP_NUM_THREADS=${num_threads}\n\nnamespace tensorflow {"
  }
]