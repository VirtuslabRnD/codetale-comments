[
  {
    "id" : "bfcd80f2-9b98-4c72-aead-19797f16a9de",
    "prId" : 51608,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/51608#pullrequestreview-61109546",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "fff08d5f-5635-44d7-bc67-91121266f6a6",
        "parentId" : null,
        "authorId" : "a7f673a6-4b23-4df6-aa10-f123fa9dcd5f",
        "body" : "why error here?",
        "createdAt" : "2017-09-06T15:01:44Z",
        "updatedAt" : "2017-10-25T10:31:32Z",
        "lastEditedBy" : "a7f673a6-4b23-4df6-aa10-f123fa9dcd5f",
        "tags" : [
        ]
      },
      {
        "id" : "af029be0-1686-40a8-8c98-b603b171c271",
        "parentId" : "fff08d5f-5635-44d7-bc67-91121266f6a6",
        "authorId" : "e4e7c71f-23b5-4203-b65d-3f5f3c503b64",
        "body" : "In normal cases, `Detacher.UnmountDevice` [only be called once all bind mounts have been unmounted](https://github.com/kubernetes/kubernetes/blob/master/pkg/volume/volume.go#L201), `cnt` should always be 1 here. But if there is a bug or someone mount device on the node accidentally after [the check](https://github.com/kubernetes/kubernetes/blob/master/pkg/volume/util/operationexecutor/operation_generator.go#L579), `cnt` can be greater than 1, this is used to report this unexpected case.\r\n\r\nAlthough kubelet will [let the caller to retry if device is still in used](https://github.com/kubernetes/kubernetes/blob/master/pkg/volume/util/operationexecutor/operation_generator.go#L591) even if `Detacher.UnmountDevice` returns nil, I think reporting this error is better than not (at least it's not wrong) and makes this function idempotent, only returns nil if everything is going well.",
        "createdAt" : "2017-09-07T04:13:27Z",
        "updatedAt" : "2017-10-25T10:31:32Z",
        "lastEditedBy" : "e4e7c71f-23b5-4203-b65d-3f5f3c503b64",
        "tags" : [
        ]
      }
    ],
    "commit" : "f2af1af82fceacddf6958b31b1946d204c313574",
    "line" : 193,
    "diffHunk" : "@@ -1,1 +191,195 @@\t}\n\tif cnt > 1 {\n\t\treturn fmt.Errorf(\"rbd: more than 1 reference counts at %s\", deviceMountPath)\n\t}\n\tif cnt == 1 {"
  },
  {
    "id" : "00ca8996-f841-41c8-938b-1e3452ad1a7e",
    "prId" : 51608,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/51608#pullrequestreview-61103198",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "946253ae-a570-4455-932e-78b6c06be3aa",
        "parentId" : null,
        "authorId" : "a7f673a6-4b23-4df6-aa10-f123fa9dcd5f",
        "body" : "call `UnmountPath` to umount it",
        "createdAt" : "2017-09-06T15:03:14Z",
        "updatedAt" : "2017-10-25T10:31:32Z",
        "lastEditedBy" : "a7f673a6-4b23-4df6-aa10-f123fa9dcd5f",
        "tags" : [
        ]
      },
      {
        "id" : "5723de9c-3242-46f2-8e8e-efca1df3abc6",
        "parentId" : "946253ae-a570-4455-932e-78b6c06be3aa",
        "authorId" : "e4e7c71f-23b5-4203-b65d-3f5f3c503b64",
        "body" : "hi, it's because `rbdDetacher.UnmountDevice` cannot use it to unmount device mount point, because `util.UnmountPath` will [delete the remaining directory if successful](https://github.com/kubernetes/kubernetes/blob/master/pkg/volume/util/util.go#L80). `rbdDetacher.UnmountDevice` needs to load RBD info from underlying directory later and remove lock if found. Almost the same logic as in [iscsi](https://github.com/kubernetes/kubernetes/blob/master/pkg/volume/iscsi/iscsi_util.go#L351).",
        "createdAt" : "2017-09-07T03:00:07Z",
        "updatedAt" : "2017-10-25T10:31:32Z",
        "lastEditedBy" : "e4e7c71f-23b5-4203-b65d-3f5f3c503b64",
        "tags" : [
        ]
      }
    ],
    "commit" : "f2af1af82fceacddf6958b31b1946d204c313574",
    "line" : 192,
    "diffHunk" : "@@ -1,1 +190,194 @@\t\treturn err\n\t}\n\tif cnt > 1 {\n\t\treturn fmt.Errorf(\"rbd: more than 1 reference counts at %s\", deviceMountPath)\n\t}"
  }
]