[
  {
    "id" : "5b9fd32f-01b9-4406-9f0f-1a2119f05cec",
    "prId" : 77595,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/77595#pullrequestreview-244724433",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "491afcb0-3810-47b2-a04c-a17fe75aea5b",
        "parentId" : null,
        "authorId" : "d3e684d7-edd2-4290-a8bf-e8b698c97338",
        "body" : "So if driver is not installed on the node, we consider migration to be off on the node? Is that accurate - because this means that pods will still be scheduled on the node and volume operations will be handled by in-tree plugins but I thought that is not what we want to do. ",
        "createdAt" : "2019-05-31T14:45:58Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "d3e684d7-edd2-4290-a8bf-e8b698c97338",
        "tags" : [
        ]
      },
      {
        "id" : "238c96a7-6a1d-48b7-9f05-2cf2ef590197",
        "parentId" : "491afcb0-3810-47b2-a04c-a17fe75aea5b",
        "authorId" : "d3e684d7-edd2-4290-a8bf-e8b698c97338",
        "body" : "cc @davidz627 ",
        "createdAt" : "2019-05-31T14:46:12Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "d3e684d7-edd2-4290-a8bf-e8b698c97338",
        "tags" : [
        ]
      },
      {
        "id" : "a6d54fec-70e7-43f4-ba5e-674834a6c44f",
        "parentId" : "491afcb0-3810-47b2-a04c-a17fe75aea5b",
        "authorId" : "542e5d2f-2ff9-4674-ab44-78f31768e7a1",
        "body" : "> So if driver is not installed on the node, we consider migration to be off on the node\r\n\r\nThis is not accurate.\r\n\r\nDetermining whether migration is on for a plugin for Attach/Detach involves 2 things:\r\n1) Migration is \"on\" on the master (feature flags)\r\n2) Migration is \"on\" on the node which the volume is scheduled to (can be determined through the annotation \"storage.alpha.kubernetes.io/migrated-plugins\" on the CSINode API object for that node)\r\n\r\nFor all other operations determining whether migration is on for a plugin involves just:\r\n1) Migration is \"on\" on the master/node wherever the operation is performed (can just be determined by looking at the feature flags)\r\n\r\nDriver installed/not installed does not factor into the determination of migrated or not. If we determine a plugin is migrated with the above criteria, if the driver is not installed generally we throw an error mentioning that the driver was required but not installed.",
        "createdAt" : "2019-05-31T18:13:31Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "542e5d2f-2ff9-4674-ab44-78f31768e7a1",
        "tags" : [
        ]
      },
      {
        "id" : "2ae30235-53e7-42fa-8377-292eb8c40d7e",
        "parentId" : "491afcb0-3810-47b2-a04c-a17fe75aea5b",
        "authorId" : "d3e684d7-edd2-4290-a8bf-e8b698c97338",
        "body" : "okay thanks for clarifying. I think `isCSIMigrationOn` check is okay. But still we aren't doing anything in the code here to prevent scheduling of pods for which driver is not installed (and migration is on). This should be fixed. ",
        "createdAt" : "2019-05-31T18:31:51Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "d3e684d7-edd2-4290-a8bf-e8b698c97338",
        "tags" : [
        ]
      },
      {
        "id" : "b1cb6c6f-5758-48f5-b071-06191e959880",
        "parentId" : "491afcb0-3810-47b2-a04c-a17fe75aea5b",
        "authorId" : "255dd885-bee4-4c1f-baef-ba11f903dc5c",
        "body" : "Added check",
        "createdAt" : "2019-06-03T08:20:44Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "255dd885-bee4-4c1f-baef-ba11f903dc5c",
        "tags" : [
        ]
      }
    ],
    "commit" : "6abc04d059b42ffdc1b68f5b847f18e57ac0680d",
    "line" : 25,
    "diffHunk" : "@@ -1,1 +99,103 @@// the CSI migration has been enabled for a particular storage plugin.\nfunc isCSIMigrationOn(csiNode *storagev1beta1.CSINode, pluginName string) bool {\n\tif csiNode == nil || len(pluginName) == 0 {\n\t\treturn false\n\t}"
  },
  {
    "id" : "61a0bbfc-985c-4672-8fc1-9a803734b2ff",
    "prId" : 77595,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/77595#pullrequestreview-244723814",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "b558f929-5b0e-44ec-8528-386a35e66ee8",
        "parentId" : null,
        "authorId" : "542e5d2f-2ff9-4674-ab44-78f31768e7a1",
        "body" : "Is it possible to get the plugin itself and call the `IsMigratedToCSI()` function on the plugin interface? I want to avoid special casing these feature gates checking everywhere",
        "createdAt" : "2019-05-31T18:25:07Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "542e5d2f-2ff9-4674-ab44-78f31768e7a1",
        "tags" : [
        ]
      },
      {
        "id" : "5b6655c2-f0b6-4dd8-abd8-12b99727101f",
        "parentId" : "b558f929-5b0e-44ec-8528-386a35e66ee8",
        "authorId" : "8b64e744-955d-4523-a3b7-60fae9df0857",
        "body" : "No, scheduler does not import volume plugins. From some reason scheduler people are afraid of all their dependencies (incl. cloud providers and whatnot).",
        "createdAt" : "2019-06-03T07:49:57Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "8b64e744-955d-4523-a3b7-60fae9df0857",
        "tags" : [
        ]
      }
    ],
    "commit" : "6abc04d059b42ffdc1b68f5b847f18e57ac0680d",
    "line" : 48,
    "diffHunk" : "@@ -1,1 +122,126 @@\t\t\treturn false\n\t\t}\n\tcase csilibplugins.CinderInTreePluginName:\n\t\tif !utilfeature.DefaultFeatureGate.Enabled(features.CSIMigrationOpenStack) {\n\t\t\treturn false"
  },
  {
    "id" : "14c32758-18ea-4b8b-8365-209be58a4cbf",
    "prId" : 77595,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/77595#pullrequestreview-245263690",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "41a9687e-7675-4368-b22a-36d0f58b93df",
        "parentId" : null,
        "authorId" : "5f2c1de8-4266-42c0-b343-ba247af3578f",
        "body" : "This check is redundant, since trying to read from a nil map is the same as reading a non-existent key from a map.",
        "createdAt" : "2019-06-03T19:32:46Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "5f2c1de8-4266-42c0-b343-ba247af3578f",
        "tags" : [
        ]
      },
      {
        "id" : "426c72f3-6f4d-4004-ba8e-8a13677bb4e2",
        "parentId" : "41a9687e-7675-4368-b22a-36d0f58b93df",
        "authorId" : "255dd885-bee4-4c1f-baef-ba11f903dc5c",
        "body" : "I think the idea was to fail fast, i.e., avoiding creating a new empty set and checking if it contains an element.",
        "createdAt" : "2019-06-04T09:03:33Z",
        "updatedAt" : "2019-06-25T14:31:24Z",
        "lastEditedBy" : "255dd885-bee4-4c1f-baef-ba11f903dc5c",
        "tags" : [
        ]
      }
    ],
    "commit" : "6abc04d059b42ffdc1b68f5b847f18e57ac0680d",
    "line" : 59,
    "diffHunk" : "@@ -1,1 +133,137 @@\t// This indicates that the plugin has been migrated to a CSI driver in the node.\n\tcsiNodeAnn := csiNode.GetAnnotations()\n\tif csiNodeAnn == nil {\n\t\treturn false\n\t}"
  },
  {
    "id" : "da083df5-4705-4d77-b16b-2fbf858f8ab8",
    "prId" : 77595,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/77595#pullrequestreview-245081285",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "0a743855-f116-48d8-a316-c669296c05f0",
        "parentId" : null,
        "authorId" : "5f2c1de8-4266-42c0-b343-ba247af3578f",
        "body" : "I do not like that we check global state here, but that is not something that needs discussing on this PR.",
        "createdAt" : "2019-06-03T19:35:24Z",
        "updatedAt" : "2019-06-25T14:31:23Z",
        "lastEditedBy" : "5f2c1de8-4266-42c0-b343-ba247af3578f",
        "tags" : [
        ]
      }
    ],
    "commit" : "6abc04d059b42ffdc1b68f5b847f18e57ac0680d",
    "line" : 31,
    "diffHunk" : "@@ -1,1 +105,109 @@\t// In-tree storage to CSI driver migration feature should be enabled,\n\t// along with the plugin-specific one\n\tif !utilfeature.DefaultFeatureGate.Enabled(features.CSIMigration) {\n\t\treturn false\n\t}"
  }
]