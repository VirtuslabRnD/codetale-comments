[
  {
    "id" : "b5086581-63ce-4be6-bb57-c38800dcf555",
    "prId" : 100369,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/100369#pullrequestreview-660514314",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "491f089f-61b8-4c0c-9e65-355d0df30600",
        "parentId" : null,
        "authorId" : "db4d847e-0006-4342-9243-2f3f71f190b9",
        "body" : "when dbus will restart is it expected that busChan will return ok=false? ",
        "createdAt" : "2021-05-14T01:10:25Z",
        "updatedAt" : "2021-05-14T01:11:17Z",
        "lastEditedBy" : "db4d847e-0006-4342-9243-2f3f71f190b9",
        "tags" : [
        ]
      },
      {
        "id" : "d0931ffb-5958-4ffa-aec7-af7915c87c47",
        "parentId" : "491f089f-61b8-4c0c-9e65-355d0df30600",
        "authorId" : "32b8d25c-f21a-4ff1-a275-7dbf7672c31a",
        "body" : "Yes, The busChan will be closed when restart dbus.",
        "createdAt" : "2021-05-17T02:41:14Z",
        "updatedAt" : "2021-05-17T02:43:18Z",
        "lastEditedBy" : "32b8d25c-f21a-4ff1-a275-7dbf7672c31a",
        "tags" : [
        ]
      }
    ],
    "commit" : "202a0120937ef46cf7e9e8632b50f7bdc58f9d2a",
    "line" : 25,
    "diffHunk" : "@@ -1,1 +152,156 @@\t\t\tevent, ok := <-busChan\n\t\t\tif !ok {\n\t\t\t\tclose(shutdownChan)\n\t\t\t\treturn\n\t\t\t}"
  },
  {
    "id" : "35c4256d-a522-4432-a25a-8a7da1b4bde4",
    "prId" : 96129,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/96129#pullrequestreview-525587221",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "fdbc6f81-c0e1-47cb-8479-3e4f7af622a0",
        "parentId" : null,
        "authorId" : "85d51570-e06e-4b3f-a869-f5f820e49119",
        "body" : "what if somebody already have this file? Can there be more settings than just InhibitDelayMaxSec?",
        "createdAt" : "2020-11-05T20:07:05Z",
        "updatedAt" : "2020-11-12T21:48:27Z",
        "lastEditedBy" : "85d51570-e06e-4b3f-a869-f5f820e49119",
        "tags" : [
        ]
      },
      {
        "id" : "e93596fe-9b1c-4478-a225-d196aee3423e",
        "parentId" : "fdbc6f81-c0e1-47cb-8479-3e4f7af622a0",
        "authorId" : "db4d847e-0006-4342-9243-2f3f71f190b9",
        "body" : "The file written here will be `/etc/systemd/logind.conf.d/99-kubelet.conf`. Since it called `99-kubelet.conf` I would hope that it's reserved only for kubelet to write. \r\n\r\nThe idea here is that by default the `InhibitDelayMaxSec` defaults to 5 sec. If the user requested higher shutdown grace period via kubelet, kubelet will attempt to write this config file to override the system's `InhibitDelayMaxSec` setting.\r\n\r\nLogind will go to various directories to search for all the logind override config files. It could theoretically happen that some other process on the systemd could write a logind override config file and it would be precedence. From logind docs:\r\n\r\n> When multiple files specify the same option, for options which accept just a single value, the entry in the file with the lexicographically latest name takes precedence. \r\n\r\nAs a result, this is best effort. If the update was not successful, the shutdown manager will exit. That's the responsibility of the check in `nodeshutdown_manager_linux.go`:\r\n\r\n```\r\n// Read the current inhibitDelay again, if the override was successful, currentInhibitDelay will be equal to shutdownGracePeriodRequested.\r\nupdatedInhibitDelay, err := m.dbusCon.CurrentInhibitDelay()\r\nif err != nil {\r\n    return err\r\n}\r\n\r\nif updatedInhibitDelay != m.shutdownGracePeriodRequested {\r\n    return fmt.Errorf(\"node shutdown manager was unable to update logind InhibitDelayMaxSec to %v (ShutdownGracePeriod), current value of InhibitDelayMaxSec (%v) is less than requested ShutdownGracePeriod\", m.shutdownGracePeriodRequested, updatedInhibitDelay)\r\n}\r\n```  ",
        "createdAt" : "2020-11-07T03:04:18Z",
        "updatedAt" : "2020-11-12T21:48:27Z",
        "lastEditedBy" : "db4d847e-0006-4342-9243-2f3f71f190b9",
        "tags" : [
        ]
      }
    ],
    "commit" : "16f71c6d47843c359e78c0eea2f34814f4cf055b",
    "line" : 181,
    "diffHunk" : "@@ -1,1 +179,183 @@\n\tlogindOverridePath := filepath.Join(logindConfigDirectory, kubeletLogindConf)\n\tif err := ioutil.WriteFile(logindOverridePath, []byte(inhibitOverride), 0755); err != nil {\n\t\treturn fmt.Errorf(\"failed writing logind shutdown inhibit override file %v: %v\", logindOverridePath, err)\n\t}"
  },
  {
    "id" : "d16fe1e6-af94-40bc-b859-6d47e374f00c",
    "prId" : 96129,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/96129#pullrequestreview-526760582",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "c9875268-01e2-4b92-9ea7-86c82c1a763d",
        "parentId" : null,
        "authorId" : "85d51570-e06e-4b3f-a869-f5f820e49119",
        "body" : "I'm confused. This setting is `InhibitDelayMaxSec ` and there is also a property `InhibitDelayMaxUSec`. Is it how everything designed?",
        "createdAt" : "2020-11-05T20:08:58Z",
        "updatedAt" : "2020-11-12T21:48:27Z",
        "lastEditedBy" : "85d51570-e06e-4b3f-a869-f5f820e49119",
        "tags" : [
        ]
      },
      {
        "id" : "90d1d591-52f9-4c9f-99dc-3a99cadb81c6",
        "parentId" : "c9875268-01e2-4b92-9ea7-86c82c1a763d",
        "authorId" : "db4d847e-0006-4342-9243-2f3f71f190b9",
        "body" : "`InhibitDelayMaxSec` is the name of the field that you configure by writing the logind file (see here https://www.freedesktop.org/software/systemd/man/logind.conf.html). The config file only lets you set the InhibitDelay in second units. \r\n\r\n`InhibitDelayMaxUSec` is the name of the field when you query it via dbus. (documented here: https://www.freedesktop.org/wiki/Software/systemd/inhibit/). That should have the same value as configured in `InhibitDelayMaxSec` but it's measured in microseconds. \r\n\r\nIn terms of why the config file is measured in seconds but the dbus setting is exposed as microseconds, I'm not sure, it's a bit confusing, but it's what logind does :) ",
        "createdAt" : "2020-11-07T03:04:21Z",
        "updatedAt" : "2020-11-12T21:48:27Z",
        "lastEditedBy" : "db4d847e-0006-4342-9243-2f3f71f190b9",
        "tags" : [
        ]
      },
      {
        "id" : "9ae21be6-6249-47b6-bef5-691a60e85be5",
        "parentId" : "c9875268-01e2-4b92-9ea7-86c82c1a763d",
        "authorId" : "85d51570-e06e-4b3f-a869-f5f820e49119",
        "body" : "understood. Thank you. Adding this link https://www.freedesktop.org/software/systemd/man/logind.conf.html to code comment might help",
        "createdAt" : "2020-11-07T07:31:41Z",
        "updatedAt" : "2020-11-12T21:48:27Z",
        "lastEditedBy" : "85d51570-e06e-4b3f-a869-f5f820e49119",
        "tags" : [
        ]
      },
      {
        "id" : "3f7ad9a8-c218-48b8-a2c8-9b3c2823b514",
        "parentId" : "c9875268-01e2-4b92-9ea7-86c82c1a763d",
        "authorId" : "db4d847e-0006-4342-9243-2f3f71f190b9",
        "body" : "Done",
        "createdAt" : "2020-11-10T00:26:38Z",
        "updatedAt" : "2020-11-12T21:48:28Z",
        "lastEditedBy" : "db4d847e-0006-4342-9243-2f3f71f190b9",
        "tags" : [
        ]
      }
    ],
    "commit" : "16f71c6d47843c359e78c0eea2f34814f4cf055b",
    "line" : 178,
    "diffHunk" : "@@ -1,1 +176,180 @@[Login]\nInhibitDelayMaxSec=%.0f\n`, inhibitDelayMax.Seconds())\n\n\tlogindOverridePath := filepath.Join(logindConfigDirectory, kubeletLogindConf)"
  }
]