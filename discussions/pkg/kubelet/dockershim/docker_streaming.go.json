[
  {
    "id" : "25bdb836-9231-4675-97a0-b3c23d44ceab",
    "prId" : 96495,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/96495#pullrequestreview-531910681",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "494fed33-40f3-4096-9018-08205d3f8b25",
        "parentId" : null,
        "authorId" : "6dd71efb-88b1-4bb0-b30a-0df658362f14",
        "body" : "remote_runtime.go expects a grpc error with status code `DeadlineExceeded` if exec timed out:\r\n\r\nhttps://github.com/kubernetes/kubernetes/blob/4bb30c3b0e9167eb85b1e3b0c9a3bab3b351a3e2/pkg/kubelet/cri/remote/remote_runtime.go#L394-L397",
        "createdAt" : "2020-11-16T15:38:55Z",
        "updatedAt" : "2020-11-17T15:02:43Z",
        "lastEditedBy" : "6dd71efb-88b1-4bb0-b30a-0df658362f14",
        "tags" : [
        ]
      },
      {
        "id" : "02419135-0768-4379-b70d-e1697b3dbb23",
        "parentId" : "494fed33-40f3-4096-9018-08205d3f8b25",
        "authorId" : "85d51570-e06e-4b3f-a869-f5f820e49119",
        "body" : "maybe this comment can be added into the code. It is not very logical when you simply looking at this method",
        "createdAt" : "2020-11-16T23:39:45Z",
        "updatedAt" : "2020-11-17T15:02:43Z",
        "lastEditedBy" : "85d51570-e06e-4b3f-a869-f5f820e49119",
        "tags" : [
        ]
      }
    ],
    "commit" : "f5a82f70e5e4cb6b957961166533023d2c79b00e",
    "line" : 66,
    "diffHunk" : "@@ -1,1 +95,99 @@\t// kubelet's remote runtime expects a grpc error with status code DeadlineExceeded on time out.\n\tif errors.Is(err, context.DeadlineExceeded) {\n\t\treturn nil, status.Errorf(codes.DeadlineExceeded, err.Error())\n\t}\n"
  },
  {
    "id" : "8a82f69f-f4a8-426a-bfcf-21f2dbda576a",
    "prId" : 82514,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/82514#pullrequestreview-286387278",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "8b6e4d5a-eba2-4833-8bc8-e54167c1e198",
        "parentId" : null,
        "authorId" : "bd04f755-e62f-45fb-8771-4cc2b5db49d4",
        "body" : "@tallclair we cannot pass through a size parameter to `ExecSync` from `RunInContainer` as that would mean a change in signature of `ExecSync`. So i just set the LimitWriter to the same 16MB (that is the limit we set for GPRC for remote CRIs)",
        "createdAt" : "2019-09-10T19:31:19Z",
        "updatedAt" : "2019-09-11T14:15:51Z",
        "lastEditedBy" : "bd04f755-e62f-45fb-8771-4cc2b5db49d4",
        "tags" : [
        ]
      },
      {
        "id" : "1f8227b0-bddb-49ef-b1b5-a542e154606b",
        "parentId" : "8b6e4d5a-eba2-4833-8bc8-e54167c1e198",
        "authorId" : "9f030d50-62db-4b00-a28c-847709b74d97",
        "body" : "That makes sense to me.",
        "createdAt" : "2019-09-10T19:36:31Z",
        "updatedAt" : "2019-09-11T14:15:51Z",
        "lastEditedBy" : "9f030d50-62db-4b00-a28c-847709b74d97",
        "tags" : [
        ]
      }
    ],
    "commit" : "5706a13bd6f5444f7dbadf5478e4912a1c8b9937",
    "line" : 15,
    "diffHunk" : "@@ -1,1 +81,85 @@\terr := ds.streamingRuntime.exec(req.ContainerId, req.Cmd,\n\t\tnil, // in\n\t\tioutils.WriteCloserWrapper(ioutils.LimitWriter(&stdoutBuffer, maxMsgSize)),\n\t\tioutils.WriteCloserWrapper(ioutils.LimitWriter(&stderrBuffer, maxMsgSize)),\n\t\tfalse, // tty"
  },
  {
    "id" : "c16dd203-e9ec-40ca-b898-d13d5d75b678",
    "prId" : 35661,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/35661#pullrequestreview-6116761",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "81ddf013-46e6-44e9-9d0d-95225449088b",
        "parentId" : null,
        "authorId" : "0df1da34-610c-4ce5-b0cf-bbda668bf9c1",
        "body" : "nit: check container status here? just returns an error if container is not running. (container may exit just after the url is returned)\n",
        "createdAt" : "2016-10-27T02:01:51Z",
        "updatedAt" : "2016-10-28T18:32:45Z",
        "lastEditedBy" : "0df1da34-610c-4ce5-b0cf-bbda668bf9c1",
        "tags" : [
        ]
      },
      {
        "id" : "66b4c2f5-af22-47f0-bb95-6f7027362707",
        "parentId" : "81ddf013-46e6-44e9-9d0d-95225449088b",
        "authorId" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "body" : "done\n",
        "createdAt" : "2016-10-27T18:22:46Z",
        "updatedAt" : "2016-10-28T18:32:45Z",
        "lastEditedBy" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "tags" : [
        ]
      }
    ],
    "commit" : "c60db9953645f16de9ea922a3e62f84a371039f4",
    "line" : null,
    "diffHunk" : "@@ -1,1 +49,53 @@\t\treturn err\n\t}\n\n\t// TODO(timstclair): Clean this up once PR#33366 merges.\n\tif timeout <= 0 {"
  },
  {
    "id" : "f6b6e62c-35b7-4933-9320-207579c5c427",
    "prId" : 35661,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/35661#pullrequestreview-6402990",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "acbe3eda-83cf-413f-a06e-ea0e99263c3e",
        "parentId" : null,
        "authorId" : "1bd2d65a-7c93-4c22-b408-c7794d037dc5",
        "body" : "#33366 doesn't implement the timeout, are you going to move code below to `ExecInContainer`?\n",
        "createdAt" : "2016-10-27T19:22:22Z",
        "updatedAt" : "2016-10-28T18:32:45Z",
        "lastEditedBy" : "1bd2d65a-7c93-4c22-b408-c7794d037dc5",
        "tags" : [
        ]
      },
      {
        "id" : "aaec16a7-3e5e-4594-97a8-a1c664f9aebd",
        "parentId" : "acbe3eda-83cf-413f-a06e-ea0e99263c3e",
        "authorId" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "body" : "Oh yeah, I was thinking https://github.com/kubernetes/kubernetes/pull/27956/commits/d82bc859c8ffd612d0ec7c8eb4604d33f2502705 was part of #33366. I don't think this method should be responsible for underlying handling of the timeout, so I can implement it in the native exec handler in a separate PR. /cc @rhcarvalho \n",
        "createdAt" : "2016-10-28T01:45:33Z",
        "updatedAt" : "2016-10-28T18:32:45Z",
        "lastEditedBy" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "tags" : [
        ]
      },
      {
        "id" : "7d9d0cee-c121-4137-b9ef-77868a49abd4",
        "parentId" : "acbe3eda-83cf-413f-a06e-ea0e99263c3e",
        "authorId" : "e6e87a4e-1c04-47fc-b080-99a5c8b8b2ea",
        "body" : "#27956 has the code implementing the timeout, though we are not able to implement proper timeouts using the Docker API.\n\nTo speed up the discussion of timeout in the func signature vs. what respects the timeout, we extracted #33366 to do the former, then we can bring the actual implementations.\n\nFYI this is an effort to fix #26895.\n",
        "createdAt" : "2016-10-31T09:11:11Z",
        "updatedAt" : "2016-10-31T09:11:11Z",
        "lastEditedBy" : "e6e87a4e-1c04-47fc-b080-99a5c8b8b2ea",
        "tags" : [
        ]
      }
    ],
    "commit" : "c60db9953645f16de9ea922a3e62f84a371039f4",
    "line" : 52,
    "diffHunk" : "@@ -1,1 +50,54 @@\t}\n\n\t// TODO(timstclair): Clean this up once PR#33366 merges.\n\tif timeout <= 0 {\n\t\t// Run until command exits."
  },
  {
    "id" : "686e002d-e7b5-4c89-a5b9-8e1d21a61a10",
    "prId" : 35661,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/35661#pullrequestreview-6175724",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "4c0c2ac1-6b07-457b-8cca-5dd5684e053a",
        "parentId" : null,
        "authorId" : "1bd2d65a-7c93-4c22-b408-c7794d037dc5",
        "body" : "Hm...I checked the code again, `GetAttach` embeds the tty option in its URL, but `serveAttach` never uses. Seems redundant, no?\n",
        "createdAt" : "2016-10-27T22:45:17Z",
        "updatedAt" : "2016-10-28T18:32:45Z",
        "lastEditedBy" : "1bd2d65a-7c93-4c22-b408-c7794d037dc5",
        "tags" : [
        ]
      },
      {
        "id" : "875d9b0f-4ec7-4e44-9519-c9fdc69caa02",
        "parentId" : "4c0c2ac1-6b07-457b-8cca-5dd5684e053a",
        "authorId" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "body" : "It's used to establish the resize stream, here: https://github.com/kubernetes/kubernetes/blob/b98a990a315142ab52285e22cb63423419265606/pkg/kubelet/server/remotecommand/httpstream.go#L186\n",
        "createdAt" : "2016-10-28T01:50:57Z",
        "updatedAt" : "2016-10-28T18:32:45Z",
        "lastEditedBy" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "tags" : [
        ]
      }
    ],
    "commit" : "c60db9953645f16de9ea922a3e62f84a371039f4",
    "line" : 124,
    "diffHunk" : "@@ -1,1 +122,126 @@\t}\n\ttty := container.Config.Tty\n\treturn ds.streamingServer.GetAttach(req, tty)\n}\n"
  },
  {
    "id" : "6ec61d46-afae-4234-8e89-ac6013c548a2",
    "prId" : 35661,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/35661#pullrequestreview-6175724",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ad280a7e-4144-4c16-ba02-bbc615b2afd2",
        "parentId" : null,
        "authorId" : "1bd2d65a-7c93-4c22-b408-c7794d037dc5",
        "body" : "Hmm.....You check `tty` configuration on the container twice -- in `Attach` (line 117) and here. Is that necessary? I guess the real question is why don't we just pipe the option downstream to avoid the extra check, or simply not check until we have to perform the attach operation (i.e., here)?\n",
        "createdAt" : "2016-10-27T22:46:12Z",
        "updatedAt" : "2016-10-28T18:32:45Z",
        "lastEditedBy" : "1bd2d65a-7c93-4c22-b408-c7794d037dc5",
        "tags" : [
        ]
      },
      {
        "id" : "c35deb05-d833-4144-97c1-e7dd42013cd8",
        "parentId" : "ad280a7e-4144-4c16-ba02-bbc615b2afd2",
        "authorId" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "body" : "Yeah, we discussed that a bit here: https://github.com/kubernetes/kubernetes/pull/35330#discussion_r85011864  /cc @euank \n\nI'd like to just add the tty argument to the AttachRequest, and get the Kubelet to supply it. That would clean up a lot of the extra tty checking in here. Are you OK waiting for a follow up PR to clean up all the uses?\n",
        "createdAt" : "2016-10-28T01:54:16Z",
        "updatedAt" : "2016-10-28T18:32:45Z",
        "lastEditedBy" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "tags" : [
        ]
      }
    ],
    "commit" : "c60db9953645f16de9ea922a3e62f84a371039f4",
    "line" : null,
    "diffHunk" : "@@ -1,1 +75,79 @@\t}\n\n\ttty := container.Config.Tty\n\treturn dockertools.AttachContainer(r.client, containerID, in, out, errw, tty, resize)\n}"
  },
  {
    "id" : "6221466c-17d5-4483-a318-292750c5438e",
    "prId" : 35661,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/35661#pullrequestreview-6513141",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "052abde4-89e5-4708-9b38-ae4bcd56ec1c",
        "parentId" : null,
        "authorId" : "e6e87a4e-1c04-47fc-b080-99a5c8b8b2ea",
        "body" : "@timstclair this code path leaks a goroutine, because the send operation in line 60 will never succeed without a receive. This is a common pattern where we make errCh buffered, with size 1.\n\n``` go\nerrCh := make(chan error, 1)\n```\n\nAnd if we expect frequent calls (and I think we do, probes are executed often), then https://golang.org/pkg/time/#After is not very efficient because we don't cleanup until the timer fires (even though we might return before the timeout...)\n",
        "createdAt" : "2016-10-31T09:17:28Z",
        "updatedAt" : "2016-10-31T09:17:28Z",
        "lastEditedBy" : "e6e87a4e-1c04-47fc-b080-99a5c8b8b2ea",
        "tags" : [
        ]
      },
      {
        "id" : "69b007d3-2ae8-4ccd-84ee-8782e91f4bf3",
        "parentId" : "052abde4-89e5-4708-9b38-ae4bcd56ec1c",
        "authorId" : "0df1da34-610c-4ce5-b0cf-bbda668bf9c1",
        "body" : "@rhcarvalho File an issue for the bug?\n",
        "createdAt" : "2016-10-31T11:19:12Z",
        "updatedAt" : "2016-10-31T11:19:12Z",
        "lastEditedBy" : "0df1da34-610c-4ce5-b0cf-bbda668bf9c1",
        "tags" : [
        ]
      },
      {
        "id" : "839e4db3-2c58-4494-8a69-c9266a09b3fe",
        "parentId" : "052abde4-89e5-4708-9b38-ae4bcd56ec1c",
        "authorId" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "body" : "Good catch, I'll send a pr to fix it.\n",
        "createdAt" : "2016-10-31T19:57:24Z",
        "updatedAt" : "2016-10-31T19:57:24Z",
        "lastEditedBy" : "0adf587c-aaa2-4e47-be0f-a26d4fde14ac",
        "tags" : [
        ]
      }
    ],
    "commit" : "c60db9953645f16de9ea922a3e62f84a371039f4",
    "line" : 67,
    "diffHunk" : "@@ -1,1 +65,69 @@\t\treturn err\n\tcase <-time.After(timeout):\n\t\treturn streaming.ErrorTimeout(\"exec\", timeout)\n\t}\n}"
  }
]