[
  {
    "id" : "cb36111f-48b2-4a61-8249-ac4222ef793b",
    "prId" : 8997,
    "prUrl" : "https://github.com/apache/airflow/pull/8997#pullrequestreview-423648916",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "02dc5525-8128-4918-b16d-dff51956be73",
        "parentId" : null,
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "I think it will be much better to calculate hash of the files ? I  think mtime is a bad thing to use for multiple reasons - one of them is that in a number of situations you can get mtime modified when the file is not updated various sync solutions might do it). I always prefer to calculate hashes in those kind of checks.",
        "createdAt" : "2020-06-03T15:05:21Z",
        "updatedAt" : "2020-06-29T14:27:49Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      }
    ],
    "commit" : "5d58ffa2556442cc1dce3e93fcc63243ba21c8b8",
    "line" : 113,
    "diffHunk" : "@@ -1,1 +109,113 @@        all_filenames: List[str] = []\n        for (root, _, filenames) in os.walk(settings.PLUGINS_FOLDER):\n            all_filenames.extend(os.path.join(root, f) for f in filenames)\n        plugin_state = {f: self._get_file_hash(f) for f in sorted(all_filenames)}\n        return plugin_state"
  },
  {
    "id" : "7124d251-8726-4835-9cad-b946989adaf0",
    "prId" : 8997,
    "prUrl" : "https://github.com/apache/airflow/pull/8997#pullrequestreview-439050575",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "a3eb13de-3252-40ae-aaeb-3155f98b6672",
        "parentId" : null,
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "I think we should check if _last_plugin_state was actually set before and not restart everything then otherwise we will pretty much always restart everything immediately after starting. That will make the startup time longer for webserver.",
        "createdAt" : "2020-06-03T15:09:09Z",
        "updatedAt" : "2020-06-29T14:27:49Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "887751ef-1944-49e1-b4f0-2de48249cd6c",
        "parentId" : "a3eb13de-3252-40ae-aaeb-3155f98b6672",
        "authorId" : "07638d17-cc8b-40a4-abdc-7b39759362ab",
        "body" : "The value for field _last_plugin_state is always set in the constructor when observing changes in the plugin directory  is enabled.\r\nhttps://github.com/apache/airflow/pull/8997/files#diff-71e5f1bb6f81ad283bca26aad652ae12R97\r\n```\r\nself._last_plugin_state = self._generate_plugin_state() if reload_on_plugin_change else None\r\n```\r\nIt will not affect performance either, because it is run in a separate process.  We first run gunicorn as a separate process, and then we begin to observe workers. Once all workers are up, we start to observe the plugins directory and regularly restart workers.  In the meantime, when the workers start, we calculate the initial state of the directory.",
        "createdAt" : "2020-06-29T11:36:03Z",
        "updatedAt" : "2020-06-29T14:27:49Z",
        "lastEditedBy" : "07638d17-cc8b-40a4-abdc-7b39759362ab",
        "tags" : [
        ]
      }
    ],
    "commit" : "5d58ffa2556442cc1dce3e93fcc63243ba21c8b8",
    "line" : 364,
    "diffHunk" : "@@ -1,1 +289,293 @@            new_state = self._generate_plugin_state()\n            # If changed, wait until its content is fully saved.\n            if new_state != self._last_plugin_state:\n                self.log.debug(\n                    '[%d / %d] Plugins folder changed. The gunicorn will be restarted the next time the '"
  },
  {
    "id" : "deafd710-b920-402e-867e-02c9283d0817",
    "prId" : 8997,
    "prUrl" : "https://github.com/apache/airflow/pull/8997#pullrequestreview-423648916",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "10abe0dd-fc99-46b6-aed1-f9f4af51aba1",
        "parentId" : null,
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : ":heart: ",
        "createdAt" : "2020-06-03T15:10:01Z",
        "updatedAt" : "2020-06-29T14:27:49Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      }
    ],
    "commit" : "5d58ffa2556442cc1dce3e93fcc63243ba21c8b8",
    "line" : 394,
    "diffHunk" : "@@ -1,1 +362,366 @@        run_args = [\n            'gunicorn',\n            '--workers', str(num_workers),\n            '--worker-class', str(args.workerclass),\n            '--timeout', str(worker_timeout),"
  },
  {
    "id" : "b566c34d-e650-4798-b3dc-34f3b283192d",
    "prId" : 8997,
    "prUrl" : "https://github.com/apache/airflow/pull/8997#pullrequestreview-439266709",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "acd49c98-3062-465d-8a90-94855d57645a",
        "parentId" : null,
        "authorId" : "0d4fd7c4-f8ab-4371-acfe-b9cca6decaf5",
        "body" : "```suggestion\r\n        plugin_state = {}\r\n        for (root, _, filenames) in os.walk(settings.PLUGINS_FOLDER):\r\n            all_filenames.extend(os.path.join(root, f) for f in filenames)\r\n            plugin_state[f] = self._get_file_hash(f)\r\n```\r\nIs this sorted necessary? ",
        "createdAt" : "2020-06-29T13:14:37Z",
        "updatedAt" : "2020-06-29T14:27:49Z",
        "lastEditedBy" : "0d4fd7c4-f8ab-4371-acfe-b9cca6decaf5",
        "tags" : [
        ]
      },
      {
        "id" : "a116a09b-aad6-4bd3-b997-6faa2be16caa",
        "parentId" : "acd49c98-3062-465d-8a90-94855d57645a",
        "authorId" : "07638d17-cc8b-40a4-abdc-7b39759362ab",
        "body" : "In the next steps we compare two dictionaries, so yes.  I am not sure if os.walk returns items in a sorted manner. I am not sure if os.walk returns items in a sorted way in each case. The documentation does not describe this.",
        "createdAt" : "2020-06-29T13:25:13Z",
        "updatedAt" : "2020-06-29T14:27:49Z",
        "lastEditedBy" : "07638d17-cc8b-40a4-abdc-7b39759362ab",
        "tags" : [
        ]
      },
      {
        "id" : "d1fa2514-32e4-4b41-b47a-a2d8bf533474",
        "parentId" : "acd49c98-3062-465d-8a90-94855d57645a",
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "It's not sorted. It returns entries in the sequence stored in the filesystem directory index, so it's usually in order of creation of the directories but when you delete a dir/recreate another they might reuse empty slot so for all purposes it's essentially random.",
        "createdAt" : "2020-06-29T15:35:59Z",
        "updatedAt" : "2020-06-29T15:36:22Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      }
    ],
    "commit" : "5d58ffa2556442cc1dce3e93fcc63243ba21c8b8",
    "line" : 114,
    "diffHunk" : "@@ -1,1 +110,114 @@        for (root, _, filenames) in os.walk(settings.PLUGINS_FOLDER):\n            all_filenames.extend(os.path.join(root, f) for f in filenames)\n        plugin_state = {f: self._get_file_hash(f) for f in sorted(all_filenames)}\n        return plugin_state\n"
  },
  {
    "id" : "2836a409-43f8-4d2d-a067-efe98aa5ca08",
    "prId" : 8997,
    "prUrl" : "https://github.com/apache/airflow/pull/8997#pullrequestreview-439147423",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "7deebdee-ac92-44d2-9e47-6adadfc8c930",
        "parentId" : null,
        "authorId" : "0d4fd7c4-f8ab-4371-acfe-b9cca6decaf5",
        "body" : "Should we change the if clause order? \r\n```python\r\nif self._restart_on_next_plugin_check:\r\n...\r\nelif new_state != self._last_plugin_state:\r\n...\r\n```\r\nIf the plugins will be changing between each loop then we will never really restart workers. ",
        "createdAt" : "2020-06-29T13:26:40Z",
        "updatedAt" : "2020-06-29T14:27:49Z",
        "lastEditedBy" : "0d4fd7c4-f8ab-4371-acfe-b9cca6decaf5",
        "tags" : [
        ]
      },
      {
        "id" : "ce39fe3b-4421-4b31-97ae-496292fa54dc",
        "parentId" : "7deebdee-ac92-44d2-9e47-6adadfc8c930",
        "authorId" : "07638d17-cc8b-40a4-abdc-7b39759362ab",
        "body" : "This is expected behavior. Then the workers will probably be restarted according to the previous rules. After all, it is unlikely that the plugins will be modified more often than 1 per second.  This condition is intended to prevent the server from restarting while the synchronization process is in progress. This is a more likely problem.",
        "createdAt" : "2020-06-29T13:33:42Z",
        "updatedAt" : "2020-06-29T14:27:49Z",
        "lastEditedBy" : "07638d17-cc8b-40a4-abdc-7b39759362ab",
        "tags" : [
        ]
      }
    ],
    "commit" : "5d58ffa2556442cc1dce3e93fcc63243ba21c8b8",
    "line" : 372,
    "diffHunk" : "@@ -1,1 +297,301 @@                self._restart_on_next_plugin_check = True\n                self._last_plugin_state = new_state\n            elif self._restart_on_next_plugin_check:\n                self.log.debug(\n                    '[%d / %d] Starts reloading the gunicorn configuration.',"
  },
  {
    "id" : "f4095ea4-10fa-4a8c-9932-db66d5b4aaba",
    "prId" : 12747,
    "prUrl" : "https://github.com/apache/airflow/pull/12747#pullrequestreview-542280427",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "0a61a64d-d325-48c9-b724-bc9f4c4470c1",
        "parentId" : null,
        "authorId" : "f73f66ab-2657-4a50-be7a-2ca3ca98c202",
        "body" : "We don't have `rich` in 1.10, so should just use normal print there.",
        "createdAt" : "2020-12-01T20:43:58Z",
        "updatedAt" : "2020-12-01T20:43:58Z",
        "lastEditedBy" : "f73f66ab-2657-4a50-be7a-2ca3ca98c202",
        "tags" : [
        ]
      }
    ],
    "commit" : "23e024032ad8cfdcf47f3fb73d043a9d98a91d4b",
    "line" : 8,
    "diffHunk" : "@@ -1,1 +322,326 @@        from rich import print as rich_print\n\n        rich_print(\n            \"[red][bold]ERROR:[/bold] The `secret_key` setting under the webserver config has an insecure \"\n            \"value - Airflow has failed safe and refuses to start. Please change this value to a new, \""
  }
]