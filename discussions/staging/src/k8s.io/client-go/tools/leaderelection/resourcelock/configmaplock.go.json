[
  {
    "id" : "e2f90faa-e497-4453-9923-f10f81ca6321",
    "prId" : 87821,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/87821#pullrequestreview-387647074",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "0b499824-e158-4889-a06f-a8c8646ea67b",
        "parentId" : null,
        "authorId" : "ca7e5a52-cab7-4f09-8ff8-da79f43339d4",
        "body" : "Based on the comment on line 80, the method should return an error if annotation doesn't exist.\r\n\r\nOTOH, this won't happen because cml.cm is initialized at line 68, which populate the annotations.",
        "createdAt" : "2020-02-04T21:14:53Z",
        "updatedAt" : "2020-04-03T23:47:45Z",
        "lastEditedBy" : "ca7e5a52-cab7-4f09-8ff8-da79f43339d4",
        "tags" : [
        ]
      },
      {
        "id" : "59019418-4975-4a6c-b6c8-901056128619",
        "parentId" : "0b499824-e158-4889-a06f-a8c8646ea67b",
        "authorId" : "42b1e004-4fa7-4e43-84cf-5378839b49ad",
        "body" : "Looking at ConfigMapLock#Get :\r\n```\r\n\tcml.cm, err = cml.Client.ConfigMaps(cml.ConfigMapMeta.Namespace).Get(cml.ConfigMapMeta.Name, metav1.GetOptions{})\r\n\tif err != nil {\r\n\t\treturn nil, nil, err\r\n\t}\r\n\tif cml.cm.Annotations == nil {\r\n```\r\nIt seems if the Update runs in parallel to Get() which is checking cml.cm.Annotations against nil, the scenario described in #87800 may happen.",
        "createdAt" : "2020-02-04T21:26:42Z",
        "updatedAt" : "2020-04-03T23:47:45Z",
        "lastEditedBy" : "42b1e004-4fa7-4e43-84cf-5378839b49ad",
        "tags" : [
        ]
      },
      {
        "id" : "35bc8282-814a-475a-ad46-4289e6fa6a22",
        "parentId" : "0b499824-e158-4889-a06f-a8c8646ea67b",
        "authorId" : "42b1e004-4fa7-4e43-84cf-5378839b49ad",
        "body" : "In Update, it seems we can error out if cml.cm.Annotations == nil.",
        "createdAt" : "2020-02-04T21:27:26Z",
        "updatedAt" : "2020-04-03T23:47:45Z",
        "lastEditedBy" : "42b1e004-4fa7-4e43-84cf-5378839b49ad",
        "tags" : [
        ]
      },
      {
        "id" : "33e163d8-49ec-4c61-bf55-9d9913167a15",
        "parentId" : "0b499824-e158-4889-a06f-a8c8646ea67b",
        "authorId" : "2d9afee7-a404-4340-8fd9-d3187ed4f1da",
        "body" : "Per my comment in https://github.com/kubernetes/kubernetes/pull/84801#issuecomment-601905313, when `Update` fails, we store an empty `*v1.ConfigMap` in the \"cm\" field. It doesn't require a race or any concurrency. It's due to the mistaken assumption that `Update` would have returned a more complete struct value.",
        "createdAt" : "2020-04-04T00:42:31Z",
        "updatedAt" : "2020-04-04T00:42:31Z",
        "lastEditedBy" : "2d9afee7-a404-4340-8fd9-d3187ed4f1da",
        "tags" : [
        ]
      }
    ],
    "commit" : "086d6ae9bbbe95e0740e7dd44fa08c31409f8bec",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +88,92 @@\t}\n\tif cml.cm.Annotations == nil {\n\t\tcml.cm.Annotations = make(map[string]string)\n\t}\n\tcml.cm.Annotations[LeaderElectionRecordAnnotationKey] = string(recordBytes)"
  },
  {
    "id" : "684b3aa8-ebd1-4bac-8be1-0aaad44005a5",
    "prId" : 68215,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/68215#pullrequestreview-152308170",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "91967465-283d-4160-937e-657fbaf88e01",
        "parentId" : null,
        "authorId" : "2ce2b44c-9841-49e7-983e-fb7696974908",
        "body" : "looks like a copy paste error. :+1: ",
        "createdAt" : "2018-09-05T01:29:12Z",
        "updatedAt" : "2018-09-05T01:29:12Z",
        "lastEditedBy" : "2ce2b44c-9841-49e7-983e-fb7696974908",
        "tags" : [
        ]
      }
    ],
    "commit" : "19c9df95ad7812f3f5bab39211c82316e72f91b4",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +81,85 @@func (cml *ConfigMapLock) Update(ler LeaderElectionRecord) error {\n\tif cml.cm == nil {\n\t\treturn errors.New(\"configmap not initialized, call get or create first\")\n\t}\n\trecordBytes, err := json.Marshal(ler)"
  }
]