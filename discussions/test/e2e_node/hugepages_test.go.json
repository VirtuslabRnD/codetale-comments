[
  {
    "id" : "b5e40d3c-36cc-4196-b0f6-f1476939aed2",
    "prId" : 91243,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/91243#pullrequestreview-425797117",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "76f09688-8bde-40b8-beb0-5f6cf9aa0a38",
        "parentId" : null,
        "authorId" : "76d4ae26-41c7-401e-a5bf-29ddbb8e780a",
        "body" : "This is good improvement for different hugepage size. However, this make the program lose a little readability.\r\nIt will be nice to add some comments and example like\r\n//  Reserve number of  hugepages\r\n// e.g. /bin/sh -c \"echo 5 > /proc/sys/vm.nr_hugepages\"",
        "createdAt" : "2020-06-06T18:52:58Z",
        "updatedAt" : "2020-06-08T08:24:15Z",
        "lastEditedBy" : "76d4ae26-41c7-401e-a5bf-29ddbb8e780a",
        "tags" : [
        ]
      },
      {
        "id" : "41cfd8b1-faed-4102-aa16-d779884aae3c",
        "parentId" : "76f09688-8bde-40b8-beb0-5f6cf9aa0a38",
        "authorId" : "b15151c4-81af-487d-8c8f-a4f39690bd34",
        "body" : "done",
        "createdAt" : "2020-06-07T08:07:36Z",
        "updatedAt" : "2020-06-08T08:24:15Z",
        "lastEditedBy" : "b15151c4-81af-487d-8c8f-a4f39690bd34",
        "tags" : [
        ]
      }
    ],
    "commit" : "a4b367a6a315db6ccf3c40a4a0374372b4307acf",
    "line" : 95,
    "diffHunk" : "@@ -1,1 +131,135 @@\t// Reserve number of hugepages\n\t// e.g. /bin/sh -c \"echo 5 > /sys/kernel/mm/hugepages/hugepages-2048kB/vm.nr_hugepages\"\n\tcommand := fmt.Sprintf(\"echo %d > %s-%dkB/%s\", hugepagesCount, hugepagesDirPrefix, hugepagesSize, hugepagesCapacityFile)\n\tif err := exec.Command(\"/bin/sh\", \"-c\", command).Run(); err != nil {\n\t\treturn err"
  },
  {
    "id" : "5da35b21-930e-4b57-aa0f-a4be2fceb094",
    "prId" : 91243,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/91243#pullrequestreview-425797117",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "d497af12-c792-44c4-a8c8-b05ed5886b00",
        "parentId" : null,
        "authorId" : "76d4ae26-41c7-401e-a5bf-29ddbb8e780a",
        "body" : "Ditto",
        "createdAt" : "2020-06-06T18:53:26Z",
        "updatedAt" : "2020-06-08T08:24:15Z",
        "lastEditedBy" : "76d4ae26-41c7-401e-a5bf-29ddbb8e780a",
        "tags" : [
        ]
      },
      {
        "id" : "7378f00a-0136-411a-8944-1ee694e113b9",
        "parentId" : "d497af12-c792-44c4-a8c8-b05ed5886b00",
        "authorId" : "b15151c4-81af-487d-8c8f-a4f39690bd34",
        "body" : "done",
        "createdAt" : "2020-06-07T08:07:59Z",
        "updatedAt" : "2020-06-08T08:24:15Z",
        "lastEditedBy" : "b15151c4-81af-487d-8c8f-a4f39690bd34",
        "tags" : [
        ]
      }
    ],
    "commit" : "a4b367a6a315db6ccf3c40a4a0374372b4307acf",
    "line" : 103,
    "diffHunk" : "@@ -1,1 +138,142 @@\t// verify that the number of hugepages was updated\n\t// e.g. /bin/sh -c \"cat /sys/kernel/mm/hugepages/hugepages-2048kB/vm.nr_hugepages\"\n\tcommand = fmt.Sprintf(\"cat %s-%dkB/%s\", hugepagesDirPrefix, hugepagesSize, hugepagesCapacityFile)\n\toutData, err := exec.Command(\"/bin/sh\", \"-c\", command).Output()\n\tif err != nil {"
  },
  {
    "id" : "431ffef9-305a-4053-be4f-def3e30d1bb8",
    "prId" : 91243,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/91243#pullrequestreview-425797117",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "7e2447cf-b6f2-458a-a1a4-f12455f53489",
        "parentId" : null,
        "authorId" : "76d4ae26-41c7-401e-a5bf-29ddbb8e780a",
        "body" : "hugetlb.2MB ==> e.g hugetlb.2MB to illustrate the format ?",
        "createdAt" : "2020-06-06T19:07:48Z",
        "updatedAt" : "2020-06-08T08:24:15Z",
        "lastEditedBy" : "76d4ae26-41c7-401e-a5bf-29ddbb8e780a",
        "tags" : [
        ]
      },
      {
        "id" : "25983fc7-1e12-46d9-ba4e-2716f5556835",
        "parentId" : "7e2447cf-b6f2-458a-a1a4-f12455f53489",
        "authorId" : "b15151c4-81af-487d-8c8f-a4f39690bd34",
        "body" : "Can you please clarify, I unsure that I understand the comment?",
        "createdAt" : "2020-06-07T08:07:29Z",
        "updatedAt" : "2020-06-08T08:24:15Z",
        "lastEditedBy" : "b15151c4-81af-487d-8c8f-a4f39690bd34",
        "tags" : [
        ]
      }
    ],
    "commit" : "a4b367a6a315db6ccf3c40a4a0374372b4307acf",
    "line" : 59,
    "diffHunk" : "@@ -1,1 +77,81 @@\n\thugetlbLimitFile := \"\"\n\t// this command takes the expected value and compares it against the actual value for the pod cgroup hugetlb.2MB.<LIMIT>\n\tif IsCgroup2UnifiedMode() {\n\t\thugetlbLimitFile = fmt.Sprintf(\"/tmp/%s/%s.max\", cgroupFsName, hugepagesCgroup)"
  },
  {
    "id" : "1796028a-6ed9-4475-bbaa-b5bdffa1e02a",
    "prId" : 82656,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/82656#pullrequestreview-290467636",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "0564fd44-f0d1-42b2-8005-a0c07ebe2746",
        "parentId" : null,
        "authorId" : "d7870cae-47b0-4c8e-8527-be8fc4be86de",
        "body" : "Nit: If we wanted, we could extract this memoryCompaction to a helper function... up to you :)",
        "createdAt" : "2019-09-19T03:02:09Z",
        "updatedAt" : "2019-09-19T03:02:14Z",
        "lastEditedBy" : "d7870cae-47b0-4c8e-8527-be8fc4be86de",
        "tags" : [
        ]
      },
      {
        "id" : "aa75f475-d239-4dd0-a378-8f99c3acbbda",
        "parentId" : "0564fd44-f0d1-42b2-8005-a0c07ebe2746",
        "authorId" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "body" : ":+1: \r\nI think ill leave it like this to make it easier to read. :smile: ",
        "createdAt" : "2019-09-19T10:25:09Z",
        "updatedAt" : "2019-09-19T10:25:09Z",
        "lastEditedBy" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "tags" : [
        ]
      }
    ],
    "commit" : "b1308ed70abb4a6f0196c2b492da3df5951247c3",
    "line" : 12,
    "diffHunk" : "@@ -1,1 +87,91 @@// configureHugePages attempts to allocate 10Mi of 2Mi hugepages for testing purposes\nfunc configureHugePages() error {\n\t// Compact memory to make bigger contiguous blocks of memory available\n\t// before allocating huge pages.\n\t// https://www.kernel.org/doc/Documentation/sysctl/vm.txt"
  },
  {
    "id" : "536612e3-ea54-4532-8096-6c8f78122704",
    "prId" : 81727,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/81727#pullrequestreview-279876575",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "9d5adfca-b859-4978-ac32-60453bc1efc7",
        "parentId" : null,
        "authorId" : "d7870cae-47b0-4c8e-8527-be8fc4be86de",
        "body" : "Nit: I may be missing something obvious, but how come this is `6Mi` instead of `5Mi`?",
        "createdAt" : "2019-08-22T11:40:06Z",
        "updatedAt" : "2019-08-22T11:40:28Z",
        "lastEditedBy" : "d7870cae-47b0-4c8e-8527-be8fc4be86de",
        "tags" : [
        ]
      },
      {
        "id" : "c46729dd-9a4b-414c-80ef-cacfbcfedb95",
        "parentId" : "9d5adfca-b859-4978-ac32-60453bc1efc7",
        "authorId" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "body" : "`5Mi` will work, but imo. it is a bit strange to say that we want 2.5 huge pages (since their size is 2Mi). k8s will not complain, same with the kernel. In reality you can then only use `4Mi`, since the kernel will floor the page count.",
        "createdAt" : "2019-08-22T11:54:54Z",
        "updatedAt" : "2019-08-22T11:54:55Z",
        "lastEditedBy" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "tags" : [
        ]
      },
      {
        "id" : "feae9069-922f-403e-8938-09a9b25dadd7",
        "parentId" : "9d5adfca-b859-4978-ac32-60453bc1efc7",
        "authorId" : "c2df03b8-26df-4018-9f8f-4ddea7f8f6cc",
        "body" : "Yeah, we need to set multiplication of 2MiB which is a single hugepage on x86 architecture.\r\nOn the above, the test sets 10MiB(2MiB * 5) as hugepage.\r\nIn addition, the corresponding issue says the test could not allocated 100MiB hugepage but it was 84Mib(2MiB*42).\r\nI guess 10MiB is not invalid here based on the failure case.\r\nAnyways, I am fine for current change.",
        "createdAt" : "2019-08-26T22:47:04Z",
        "updatedAt" : "2019-08-26T22:50:08Z",
        "lastEditedBy" : "c2df03b8-26df-4018-9f8f-4ddea7f8f6cc",
        "tags" : [
        ]
      }
    ],
    "commit" : "7df6a849023c088d8090730c163cb71f87837577",
    "line" : 30,
    "diffHunk" : "@@ -1,1 +155,159 @@\t\t\t\t\t\t\t\tv1.ResourceName(\"cpu\"):           resource.MustParse(\"10m\"),\n\t\t\t\t\t\t\t\tv1.ResourceName(\"memory\"):        resource.MustParse(\"100Mi\"),\n\t\t\t\t\t\t\t\tv1.ResourceName(\"hugepages-2Mi\"): resource.MustParse(\"6Mi\"),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},"
  },
  {
    "id" : "bc307439-3588-4584-a987-275c72ca6e9f",
    "prId" : 80831,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/80831#pullrequestreview-332417738",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "db09af08-f185-491e-8641-ac1d7e698533",
        "parentId" : null,
        "authorId" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "body" : "> @bart0sh where this function is used and how is it related to this PR?\r\n\r\nIt is used here",
        "createdAt" : "2019-12-05T12:11:04Z",
        "updatedAt" : "2020-03-19T12:08:55Z",
        "lastEditedBy" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "tags" : [
        ]
      },
      {
        "id" : "97df1cc8-7b18-4abf-9e00-00e96786056e",
        "parentId" : "db09af08-f185-491e-8641-ac1d7e698533",
        "authorId" : "f46daf11-7000-4650-ae5b-dd25c29b4e29",
        "body" : "Can you explain why stopKubelet function returns another function that starts Kubelet? It doesn't look very clear and logical to me to be honest.",
        "createdAt" : "2019-12-05T12:42:49Z",
        "updatedAt" : "2020-03-19T12:08:55Z",
        "lastEditedBy" : "f46daf11-7000-4650-ae5b-dd25c29b4e29",
        "tags" : [
        ]
      },
      {
        "id" : "c646f30f-f399-4589-8604-c8a8980d69dd",
        "parentId" : "db09af08-f185-491e-8641-ac1d7e698533",
        "authorId" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "body" : "If you look at the func it make more sense. We have to store the name of the service somewhere, and imo. it is cleaner to use a closure like this instead of returning the name, or even storing it in a var.\r\n\r\nIf you have a better idea ill be happy to change the behavior! :) ",
        "createdAt" : "2019-12-05T12:57:40Z",
        "updatedAt" : "2020-03-19T12:08:55Z",
        "lastEditedBy" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "tags" : [
        ]
      },
      {
        "id" : "28428c55-7a1f-4040-be5f-8dbc71dab2c0",
        "parentId" : "db09af08-f185-491e-8641-ac1d7e698533",
        "authorId" : "f46daf11-7000-4650-ae5b-dd25c29b4e29",
        "body" : "I'd say storing it in var is much more clear, readable and allows to check if the action succeeded:\r\n```\r\nkubeletServiceName := findRunningKubletServiceName()\r\nerr := killKubelet(kubeletServiceName)\r\n...\r\nerr := startKubelet(kubeletServiceName)\r\n```",
        "createdAt" : "2019-12-05T13:35:09Z",
        "updatedAt" : "2020-03-19T12:08:55Z",
        "lastEditedBy" : "f46daf11-7000-4650-ae5b-dd25c29b4e29",
        "tags" : [
        ]
      },
      {
        "id" : "a490bfec-edfe-42d0-806b-2bb8ca4c72c4",
        "parentId" : "db09af08-f185-491e-8641-ac1d7e698533",
        "authorId" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "body" : "I guess we can do that, but then we will have to check with the folks from `sig-testing`. \r\n\r\nDoing that will move the logic for handling the different background services into the test, making it hard to refactor the code later. In case we start supporting other ways to run kubelet in the tests than `systemd`, we will have to change the tests too, not just the utilities.\r\n\r\nI do think I prefer to separate the two concerns, but ill defer the decision to `sig-testing`.\r\n\r\ncc @oomichi ",
        "createdAt" : "2019-12-05T13:46:52Z",
        "updatedAt" : "2020-03-19T12:08:55Z",
        "lastEditedBy" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "tags" : [
        ]
      },
      {
        "id" : "5c78e30e-3c70-4406-bd6d-8aee6e7df843",
        "parentId" : "db09af08-f185-491e-8641-ac1d7e698533",
        "authorId" : "f46daf11-7000-4650-ae5b-dd25c29b4e29",
        "body" : "I think either me or you misunderstood something. I'm not proposing to support other ways to run kubelet. My proposal is to get rid of closure.\r\nHere is how killKubelet functions would look like:\r\n\r\n```\r\nfunc killKubelet(kubeletServiceName string) error {\r\n\tstdout, err := exec.Command(\"sudo\", \"systemctl\", \"kill\", kubeletServiceName).CombinedOutput()\r\n        framework.ExpectNoError(err, \"Failed to kill kubelet with systemctl: %v, %v\", err, stdout)\r\n        return err\r\n}\r\n\r\n```\r\n",
        "createdAt" : "2019-12-05T13:57:14Z",
        "updatedAt" : "2020-03-19T12:08:55Z",
        "lastEditedBy" : "f46daf11-7000-4650-ae5b-dd25c29b4e29",
        "tags" : [
        ]
      },
      {
        "id" : "e9d68af1-7700-418b-89cc-447becdb08b4",
        "parentId" : "db09af08-f185-491e-8641-ac1d7e698533",
        "authorId" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "body" : "> I'm not proposing to support other ways to run kubelet. My proposal is to get rid of closure.\r\n\r\nAdding this code to the test will imo. move the logic of handlig the liveness of kubelet into the test, instead of a central & reusable place.\r\n```go\r\nkubeletServiceName := findRunningKubletServiceName()\r\nerr := killKubelet(kubeletServiceName)\r\n...\r\nerr := startKubelet(kubeletServiceName)\r\n````\r\n\r\nI do agree that `no closure  > closure`, but I am not that happy with moving the systemd-logic into the test. But again, ill defer to sig-testing.\r\n\r\nLong term the best solution would be to expose these `cmd`s into the `e2e_node/utils`, but that is outside the scope of this PR.\r\nhttps://github.com/kubernetes/kubernetes/blob/master/test/e2e_node/services/kubelet.go#L183-L210",
        "createdAt" : "2019-12-05T14:17:37Z",
        "updatedAt" : "2020-03-19T12:08:55Z",
        "lastEditedBy" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "tags" : [
        ]
      },
      {
        "id" : "904c55d8-32fe-481f-bd98-823d8e065878",
        "parentId" : "db09af08-f185-491e-8641-ac1d7e698533",
        "authorId" : "f46daf11-7000-4650-ae5b-dd25c29b4e29",
        "body" : "I'm still not sure I fully understand the concern, i.e. why this code doesn't expose handling liveness of kubelet into the test:\r\n```\r\nstartKubelet := killKubelet()\r\n...\r\nstartKubelet()\r\n```\r\n\r\nbut this one does:\r\n```\r\nkubeletServiceName := findRunningKubletServiceName()\r\nerr := killKubelet(kubeletServiceName)\r\n...\r\nerr := startKubelet(kubeletServiceName)\r\n```\r\n\r\nHowever, I still think the latter is much more readable and understandable than the former.",
        "createdAt" : "2019-12-16T09:03:53Z",
        "updatedAt" : "2020-03-19T12:08:55Z",
        "lastEditedBy" : "f46daf11-7000-4650-ae5b-dd25c29b4e29",
        "tags" : [
        ]
      }
    ],
    "commit" : "a233b9aab0d2ea595a08000d1c94564af8cd8e94",
    "line" : 15,
    "diffHunk" : "@@ -1,1 +183,187 @@\tginkgo.It(\"should add resources for new huge page sizes on kubelet restart\", func() {\n\t\tginkgo.By(\"Stopping kubelet\")\n\t\tstartKubelet := stopKubelet()\n\t\tginkgo.By(`Patching away support for hugepage resource \"hugepages-2Mi\"`)\n\t\tpatch := []byte(`[{\"op\": \"remove\", \"path\": \"/status/capacity/hugepages-2Mi\"}, {\"op\": \"remove\", \"path\": \"/status/allocatable/hugepages-2Mi\"}]`)"
  },
  {
    "id" : "176cb6b0-20ea-4a4c-8f39-508fc97215f5",
    "prId" : 80831,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/80831#pullrequestreview-398920471",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "60d0abd6-188f-4a9d-b110-739881801fa2",
        "parentId" : null,
        "authorId" : "6eca0ade-9879-4dd7-ad14-547e16f5c041",
        "body" : "this is a rare test that we can exercise with hugepages in shared testing infrastructure as it does not depend on native support in the test environment.",
        "createdAt" : "2020-04-21T05:14:29Z",
        "updatedAt" : "2020-04-21T05:15:03Z",
        "lastEditedBy" : "6eca0ade-9879-4dd7-ad14-547e16f5c041",
        "tags" : [
        ]
      },
      {
        "id" : "0a85e6ca-fb21-4b70-9e14-e7294f55a3ca",
        "parentId" : "60d0abd6-188f-4a9d-b110-739881801fa2",
        "authorId" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "body" : "Hmm. This test require a restart of the kubelet (https://github.com/kubernetes/kubernetes/pull/80831/files#diff-c50317a607de218aa9893a10fb6e0fb1R223), so I think we need to keep it a serial node e2e test, or?",
        "createdAt" : "2020-04-23T09:27:03Z",
        "updatedAt" : "2020-04-23T11:26:09Z",
        "lastEditedBy" : "b7c04289-77b0-4d05-90b7-3bde23e2b0bf",
        "tags" : [
        ]
      }
    ],
    "commit" : "a233b9aab0d2ea595a08000d1c94564af8cd8e94",
    "line" : 38,
    "diffHunk" : "@@ -1,1 +206,210 @@\tf := framework.NewDefaultFramework(\"hugepages-test\")\n\n\tginkgo.It(\"should remove resources for huge page sizes no longer supported\", func() {\n\t\tginkgo.By(\"mimicking support for 9Mi of 3Mi huge page memory by patching the node status\")\n\t\tpatch := []byte(`[{\"op\": \"add\", \"path\": \"/status/capacity/hugepages-3Mi\", \"value\": \"9Mi\"}, {\"op\": \"add\", \"path\": \"/status/allocatable/hugepages-3Mi\", \"value\": \"9Mi\"}]`)"
  },
  {
    "id" : "39ecea34-2553-4a50-938d-de705829f5fe",
    "prId" : 59511,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/59511#pullrequestreview-95148886",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "8101200d-5c9d-462d-85da-b81f0c648f85",
        "parentId" : null,
        "authorId" : "bd04f755-e62f-45fb-8771-4cc2b5db49d4",
        "body" : "@derekwaynecarr would the `tempSetCurrentKubeletConfig` stuff useful here? seems to be used in many places (http://dims.dynu.net/hound/?q=tempSetCurrentKubeletConfig&i=nope&files=&repos=kubernetes)",
        "createdAt" : "2018-02-08T15:24:34Z",
        "updatedAt" : "2018-02-08T15:37:18Z",
        "lastEditedBy" : "bd04f755-e62f-45fb-8771-4cc2b5db49d4",
        "tags" : [
        ]
      },
      {
        "id" : "aedcb2bc-df0f-4758-a10c-e805848eaa12",
        "parentId" : "8101200d-5c9d-462d-85da-b81f0c648f85",
        "authorId" : "6eca0ade-9879-4dd7-ad14-547e16f5c041",
        "body" : "i had tried to look at using that, but ran into ordering problems with multiple BeforeEach clauses.",
        "createdAt" : "2018-02-08T16:46:22Z",
        "updatedAt" : "2018-02-08T16:46:22Z",
        "lastEditedBy" : "6eca0ade-9879-4dd7-ad14-547e16f5c041",
        "tags" : [
        ]
      },
      {
        "id" : "92d6b007-0d02-40a5-a762-ebbe5b4e3ac3",
        "parentId" : "8101200d-5c9d-462d-85da-b81f0c648f85",
        "authorId" : "bd04f755-e62f-45fb-8771-4cc2b5db49d4",
        "body" : "ack thanks!",
        "createdAt" : "2018-02-08T16:50:08Z",
        "updatedAt" : "2018-02-08T16:50:08Z",
        "lastEditedBy" : "bd04f755-e62f-45fb-8771-4cc2b5db49d4",
        "tags" : [
        ]
      }
    ],
    "commit" : "6e0a52e7ff7ba73557400a0a4b8a1c7209516ebe",
    "line" : 215,
    "diffHunk" : "@@ -1,1 +213,217 @@\t\t\t\treturn nil\n\t\t\t}, 30*time.Second, framework.Poll).Should(BeNil())\n\t\t\tBy(\"enabling hugepages in kubelet\")\n\t\t\toldCfg = enableHugePagesInKubelet(f)\n\t\t\tBy(\"restarting kubelet to pick up pre-allocated hugepages\")"
  }
]