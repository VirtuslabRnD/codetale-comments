[
  {
    "id" : "f7562bc3-48d8-475a-98ab-33fe44912d5b",
    "prId" : 37465,
    "prUrl" : "https://github.com/ansible/ansible/pull/37465#pullrequestreview-105791149",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "7d8306d1-4051-4dc4-b00e-62c26154ec7d",
        "parentId" : null,
        "authorId" : "6b7e4265-ae86-4269-9bd7-f8ffa9085df6",
        "body" : "Can you use iam_role_facts instead of the sleep to ensure the role exists? You could try until iam_roles in the results is truthy. Besides that, looks great to me.",
        "createdAt" : "2018-03-19T16:41:13Z",
        "updatedAt" : "2018-03-19T16:41:29Z",
        "lastEditedBy" : "6b7e4265-ae86-4269-9bd7-f8ffa9085df6",
        "tags" : [
        ]
      },
      {
        "id" : "77fe8ae9-7339-4df8-b21f-47ea5108b72a",
        "parentId" : "7d8306d1-4051-4dc4-b00e-62c26154ec7d",
        "authorId" : "95642230-737d-4884-807e-e7b21d9570ee",
        "body" : "Sure! Didn't thought about that :)",
        "createdAt" : "2018-03-19T16:47:11Z",
        "updatedAt" : "2018-03-19T16:47:11Z",
        "lastEditedBy" : "95642230-737d-4884-807e-e7b21d9570ee",
        "tags" : [
        ]
      },
      {
        "id" : "a92c7fba-6d5a-4549-989c-c0d88891d5c0",
        "parentId" : "7d8306d1-4051-4dc4-b00e-62c26154ec7d",
        "authorId" : "95642230-737d-4884-807e-e7b21d9570ee",
        "body" : "So, I've tried to use the `iam_role_facts` before making the `ec2_instance` call. \r\nAnd it doesn't help in this case, because `iam_role_facts` returns right away with the correct values (I've even updated the modules to also fetch information for instance profiles, and it is correct)\r\n\r\nMy guess is that even if it's visible in IAM, it's not visible right away in ec2.\r\n\r\nI'm not really sure if there is a better way to solve this, than the `sleep` command. I've looked at the ec2 boto methods, and there is none that checks the existence of an instance_profile",
        "createdAt" : "2018-03-20T11:38:18Z",
        "updatedAt" : "2018-03-20T11:38:18Z",
        "lastEditedBy" : "95642230-737d-4884-807e-e7b21d9570ee",
        "tags" : [
        ]
      },
      {
        "id" : "fe570938-ab29-41c8-bde1-61f0bc9689c3",
        "parentId" : "7d8306d1-4051-4dc4-b00e-62c26154ec7d",
        "authorId" : "6b7e4265-ae86-4269-9bd7-f8ffa9085df6",
        "body" : "~Ah, I see. Possible solution would be to make a customer waiter for iam_role, in that case (https://github.com/ansible/ansible/blob/devel/lib/ansible/module_utils/aws/waiters.py) but this looks good to me as it is.~ <- err, ignore that. That won't work if IAM can access it but ec2 can't. ec2_instance could maybe use a customer waiter but ¯\\_ツ_/¯. LGTM.",
        "createdAt" : "2018-03-21T16:05:39Z",
        "updatedAt" : "2018-03-21T16:10:04Z",
        "lastEditedBy" : "6b7e4265-ae86-4269-9bd7-f8ffa9085df6",
        "tags" : [
        ]
      }
    ],
    "commit" : "27929d28105f9c494d4944edf84500c412671155",
    "line" : 23,
    "diffHunk" : "@@ -1,1 +21,25 @@\n    - name: Wait for IAM role to be available, otherwise the next step will fail (Invalid IAM Instance Profile name)\n      command: sleep 10\n\n    - name: Make instance with an instance_role"
  },
  {
    "id" : "2769784b-8da4-4867-b724-1bf02128f700",
    "prId" : 56313,
    "prUrl" : "https://github.com/ansible/ansible/pull/56313#pullrequestreview-256782224",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "227178cc-6827-482e-997b-43da9a785b2b",
        "parentId" : null,
        "authorId" : "6b7e4265-ae86-4269-9bd7-f8ffa9085df6",
        "body" : "This probably was renamed so it would pass CI, but if I see a role with this name I'm going to assume it's being used for the sts_assume_role tests (since that's when I added the resource restriction). I wonder if the resource restriction should either be made more general, or if this should get its own resource restriction added. Maybe it's fine as it is. I think I hoped the role name for those tests would make it readily apparent which tests could be responsible for leaked resources, but perhaps it's as fitting here.",
        "createdAt" : "2019-07-02T01:01:38Z",
        "updatedAt" : "2019-07-02T19:44:28Z",
        "lastEditedBy" : "6b7e4265-ae86-4269-9bd7-f8ffa9085df6",
        "tags" : [
        ]
      },
      {
        "id" : "420af7dc-bbf3-4abe-ac98-bd420b20b7cb",
        "parentId" : "227178cc-6827-482e-997b-43da9a785b2b",
        "authorId" : "183d9a20-6a5e-4432-9fe9-9fd6fe9514fb",
        "body" : "Up to you @s-hertel. The policies for automation only allow CreateRole on `ansible-test-sts-*` - I don't mind whether that's loosened so that we can tidy these tests.\r\n\r\n\r\n",
        "createdAt" : "2019-07-02T09:46:32Z",
        "updatedAt" : "2019-07-02T19:44:28Z",
        "lastEditedBy" : "183d9a20-6a5e-4432-9fe9-9fd6fe9514fb",
        "tags" : [
        ]
      }
    ],
    "commit" : "003e08310d1a882dc29e8f0cf6f559914ef4c296",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +11,15 @@    - name: Create IAM role for test\n      iam_role:\n        name: \"ansible-test-sts-{{ resource_prefix }}-test-policy\"\n        assume_role_policy_document: \"{{ lookup('file','assume-role-policy.json') }}\"\n        state: present"
  }
]