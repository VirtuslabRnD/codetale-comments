[
  {
    "id" : "cc425f4d-15e1-48a9-bc89-8ccef202989f",
    "prId" : 65541,
    "prUrl" : "https://github.com/ansible/ansible/pull/65541#pullrequestreview-335590805",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "4fd6d8a3-0474-482d-a5ea-e0a102ed2125",
        "parentId" : null,
        "authorId" : "96aeecbb-c275-402c-b904-a795c82efb48",
        "body" : "I think this test case is not correct. Since `set_fact` does not set environment variable in system. The second shell task echoes empty `$UNICODE_VAR` and registering it in `unicode_var_value` and last task is just checking `test_unicode_val == unicode_var_value.stdout` which is true (evaluates as `'' == ''`).",
        "createdAt" : "2019-12-21T04:27:18Z",
        "updatedAt" : "2019-12-21T05:40:57Z",
        "lastEditedBy" : "96aeecbb-c275-402c-b904-a795c82efb48",
        "tags" : [
        ]
      },
      {
        "id" : "62a918dd-85c5-48a7-a216-117fc6d820de",
        "parentId" : "4fd6d8a3-0474-482d-a5ea-e0a102ed2125",
        "authorId" : "96aeecbb-c275-402c-b904-a795c82efb48",
        "body" : "```\r\nTASK [set variable that has unicode characters] **************************************************************\r\nok: [127.0.0.1] => {\"ansible_facts\": {\"UNICODE_VAR\": \"ð–†ð–“ð–˜ð–Žð–‡ð–‘ð–Š\"}, \"changed\": false}\r\n\r\nTASK [confirm env lookup works with unicode values] **********************************************************\r\nchanged: [127.0.0.1] => {\"changed\": true, \"cmd\": \"echo $UNICODE_VAR\", \"delta\": \"0:00:00.004343\", \"end\": \"2019-12-21 08:58:19.570958\", \"rc\": 0, \"start\": \"2019-12-21 08:58:19.566615\", \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []}\r\n\r\nTASK [use env lookup to get UNICODE_VAR value] ***************************************************************\r\nok: [127.0.0.1] => {\"ansible_facts\": {\"test_unicode_val\": \"\"}, \"changed\": false}\r\n\r\nTASK [compare unicode values] ********************************************************************************\r\nok: [127.0.0.1] => {\r\n    \"changed\": false,\r\n    \"msg\": \"All assertions passed\"\r\n}\r\n```\r\nSee `test_unicode_val` and `unicode_var_value.stdout`",
        "createdAt" : "2019-12-21T04:30:43Z",
        "updatedAt" : "2019-12-21T05:40:57Z",
        "lastEditedBy" : "96aeecbb-c275-402c-b904-a795c82efb48",
        "tags" : [
        ]
      },
      {
        "id" : "72d47af8-d797-41db-a244-236653dc0973",
        "parentId" : "4fd6d8a3-0474-482d-a5ea-e0a102ed2125",
        "authorId" : "3e9725aa-a97f-4e4d-bf20-0110b9c20249",
        "body" : "i changed the code to following:\r\n\r\n```yml\r\n# https://github.com/ansible/ansible/issues/65297\r\n- name: set variable that has unicode characters\r\n  set_fact:\r\n    UNICODE_VAR: \"ð–†ð–“ð–˜ð–Žð–‡ð–‘ð–Š\"\r\n\r\n- name: confirm env lookup works with unicode values\r\n  shell: \"echo $UNICODE_VAR\"\r\n  register: unicode_var_value\r\n  environment:\r\n    UNICODE_VAR: \"ð–†ð–“ð–˜ð–Žð–‡ð–‘ð–Š\"\r\n\r\n- name: use env lookup to get UNICODE_VAR value\r\n  set_fact:\r\n    test_unicode_val: \"{{ lookup('env', 'UNICODE_VAR') }}\"\r\n  environment:\r\n    UNICODE_VAR: \"ð–†ð–“ð–˜ð–Žð–‡ð–‘ð–Š\"\r\n\r\n- debug: var=unicode_var_value\r\n- debug: var=test_unicode_val\r\n\r\n- name: compare unicode values\r\n  assert:\r\n    that:\r\n      - \"test_unicode_val == unicode_var_value.stdout\"\r\n```\r\n\r\nthough, the `unicode_var_value` gets the correct value for `UNICODE_VAR`, `test_unicode_val` doesn't:\r\n\r\n```bash\r\n\r\nTASK [lookups : set variable that has unicode characters] **********************\r\nok: [localhost]\r\n\r\nTASK [lookups : confirm env lookup works with unicode values] ******************\r\nchanged: [localhost]\r\n\r\nTASK [lookups : use env lookup to get UNICODE_VAR value] ***********************\r\nok: [localhost]\r\n\r\nTASK [lookups : debug] *********************************************************\r\nok: [localhost] => {\r\n    \"unicode_var_value\": {\r\n        \"changed\": true,\r\n        \"cmd\": \"echo $UNICODE_VAR\",\r\n        \"delta\": \"0:00:00.003674\",\r\n        \"end\": \"2019-12-21 04:48:43.307554\",\r\n        \"failed\": false,\r\n        \"rc\": 0,\r\n        \"start\": \"2019-12-21 04:48:43.303880\",\r\n        \"stderr\": \"\",\r\n        \"stderr_lines\": [],\r\n        \"stdout\": \"ð–†ð–“ð–˜ð–Žð–‡ð–‘ð–Š\",\r\n        \"stdout_lines\": [\r\n            \"ansible\"\r\n        ]\r\n    }\r\n}\r\n\r\nTASK [lookups : debug] *********************************************************\r\nok: [localhost] => {\r\n    \"test_unicode_val\": \"\"\r\n}\r\n\r\nTASK [lookups : compare unicode values] ****************************************\r\nfatal: [localhost]: FAILED! => {\r\n    \"assertion\": \"test_unicode_val == unicode_var_value.stdout\",\r\n    \"changed\": false,\r\n    \"evaluated_to\": false,\r\n    \"msg\": \"Assertion failed\"\r\n}\r\n```",
        "createdAt" : "2019-12-21T05:03:13Z",
        "updatedAt" : "2019-12-21T05:40:57Z",
        "lastEditedBy" : "3e9725aa-a97f-4e4d-bf20-0110b9c20249",
        "tags" : [
        ]
      },
      {
        "id" : "2eab44e7-498b-4e42-a694-dc1bab56f688",
        "parentId" : "4fd6d8a3-0474-482d-a5ea-e0a102ed2125",
        "authorId" : "96aeecbb-c275-402c-b904-a795c82efb48",
        "body" : "@abhaykadam Could you please try adding `export UNICODE_VAR=ð–†ð–“ð–˜ð–Žð–‡ð–‘ð–Š` in `runme.sh` located in ` test/integration/targets/lookups/` and re-run?",
        "createdAt" : "2019-12-21T05:37:19Z",
        "updatedAt" : "2019-12-21T05:40:57Z",
        "lastEditedBy" : "96aeecbb-c275-402c-b904-a795c82efb48",
        "tags" : [
        ]
      },
      {
        "id" : "0fb89317-a3a8-4748-83a0-9f0dabb943a6",
        "parentId" : "4fd6d8a3-0474-482d-a5ea-e0a102ed2125",
        "authorId" : "3e9725aa-a97f-4e4d-bf20-0110b9c20249",
        "body" : "ðŸ˜‚ was just testing that... have pushed the changes... and it's working!",
        "createdAt" : "2019-12-21T05:42:00Z",
        "updatedAt" : "2019-12-21T05:42:00Z",
        "lastEditedBy" : "3e9725aa-a97f-4e4d-bf20-0110b9c20249",
        "tags" : [
        ]
      },
      {
        "id" : "22c9180d-ee03-4ceb-8d25-4ed5bbeadad3",
        "parentId" : "4fd6d8a3-0474-482d-a5ea-e0a102ed2125",
        "authorId" : "3e9725aa-a97f-4e4d-bf20-0110b9c20249",
        "body" : "```bash\r\nTASK [lookups : get UNICODE_VAR environment var value] *************************                                                                                                     \r\nchanged: [localhost]                                                                                                                                                                 \r\n                                                                                          \r\nTASK [lookups : use env lookup to get UNICODE_VAR value] ***********************          \r\nok: [localhost]                              \r\n                                                                                          \r\nTASK [lookups : debug] *********************************************************          \r\nok: [localhost] => {                                                                                                                                                                 \r\n    \"unicode_var_value\": {        \r\n        \"changed\": true,                     \r\n        \"cmd\": \"echo $UNICODE_VAR\",\r\n        \"delta\": \"0:00:00.005369\",\r\n        \"end\": \"2019-12-21 05:41:44.396259\",\r\n        \"failed\": false,\r\n        \"rc\": 0,\r\n        \"start\": \"2019-12-21 05:41:44.390890\",\r\n        \"stderr\": \"\",\r\n        \"stderr_lines\": [],\r\n        \"stdout\": \"cafÃ©\",\r\n        \"stdout_lines\": [\r\n            \"cafÃ©\"\r\n        ]\r\n    }\r\n}\r\n\r\nTASK [lookups : debug] *********************************************************\r\nok: [localhost] => {\r\n    \"test_unicode_val\": \"cafÃ©\"\r\n}\r\n\r\nTASK [lookups : compare unicode values] ****************************************\r\nok: [localhost] => {\r\n    \"changed\": false,\r\n    \"msg\": \"All assertions passed\"\r\n}\r\n```",
        "createdAt" : "2019-12-21T05:45:13Z",
        "updatedAt" : "2019-12-21T05:45:13Z",
        "lastEditedBy" : "3e9725aa-a97f-4e4d-bf20-0110b9c20249",
        "tags" : [
        ]
      }
    ],
    "commit" : "0e8256754c79791493e565ddb6362fd69794d0d7",
    "line" : 9,
    "diffHunk" : "@@ -1,1 +160,164 @@- name: get UNICODE_VAR environment var value\n  shell: \"echo $UNICODE_VAR\"\n  register: unicode_var_value\n\n- name: use env lookup to get UNICODE_VAR value"
  }
]