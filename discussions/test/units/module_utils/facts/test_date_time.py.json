[
  {
    "id" : "8a0f1afb-73e8-465a-be61-e8c380ab8db9",
    "prId" : 70665,
    "prUrl" : "https://github.com/ansible/ansible/pull/70665#pullrequestreview-450254534",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ea482f71-c9b5-4ae6-8be1-c51fd56a6db4",
        "parentId" : null,
        "authorId" : "fd767403-a078-44f2-b3d3-75cd3faab948",
        "body" : "I think we don't need to patch `datetime.datetime.fromtimestamp()` and `datetime.datetime.utcfromtimestamp()` methods as they just return a datetime object from patched `time.time()`.",
        "createdAt" : "2020-07-16T21:48:02Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "fd767403-a078-44f2-b3d3-75cd3faab948",
        "tags" : [
        ]
      },
      {
        "id" : "5bce577c-8866-40a4-90f1-3932900c6cce",
        "parentId" : "ea482f71-c9b5-4ae6-8be1-c51fd56a6db4",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "+1 it's better to just patch `time.time`",
        "createdAt" : "2020-07-16T21:55:16Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "074ce947-2690-4d7b-87ac-4d042ad7c7f5",
        "parentId" : "ea482f71-c9b5-4ae6-8be1-c51fd56a6db4",
        "authorId" : "2f8132dc-12f8-44dc-8b97-1cf4c1616b68",
        "body" : "I tried not patching those but ended up incorrect `datetime` objects. For example:\r\n```\r\n>       assert date_facts['date_time'][fact_name] == fact_value\r\nE       AssertionError: assert '2020-07-11T06:34:56.123456Z' == '2020-07-11T02:34:56.124356Z'\r\nE         - 2020-07-11T02:34:56.124356Z\r\nE         ?             ^          -\r\nE         + 2020-07-11T06:34:56.123456Z\r\nE         ?             ^         +\r\n\r\n```\r\n\r\n```\r\n================================================ short test summary info =================================================\r\nFAILED test/units/module_utils/facts/test_date_time.py::test_date_time_facts[hour-12]\r\nFAILED test/units/module_utils/facts/test_date_time.py::test_date_time_facts[epoch-1594434896]\r\nFAILED test/units/module_utils/facts/test_date_time.py::test_date_time_facts[time-12:34:56]\r\nFAILED test/units/module_utils/facts/test_date_time.py::test_date_time_facts[iso8601_basic-20200711T123456124356]\r\nFAILED test/units/module_utils/facts/test_date_time.py::test_date_time_facts[iso8601_basic_short-20200711T123456]\r\nFAILED test/units/module_utils/facts/test_date_time.py::test_date_time_facts[iso8601_micro-2020-07-11T02:34:56.124356Z]\r\nFAILED test/units/module_utils/facts/test_date_time.py::test_date_time_facts[iso8601-2020-07-11T02:34:56Z]\r\n```",
        "createdAt" : "2020-07-16T21:55:22Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "2f8132dc-12f8-44dc-8b97-1cf4c1616b68",
        "tags" : [
        ]
      },
      {
        "id" : "51ac655a-94c0-40c4-a1ed-51473d7f6ab0",
        "parentId" : "ea482f71-c9b5-4ae6-8be1-c51fd56a6db4",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "@samdoran then, I'd say that there's something wrong with the setup and TZ should be adjusted somewhere.",
        "createdAt" : "2020-07-16T21:58:38Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "868700cf-b4e6-4f9e-8b2a-ae797710c1b9",
        "parentId" : "ea482f71-c9b5-4ae6-8be1-c51fd56a6db4",
        "authorId" : "2f8132dc-12f8-44dc-8b97-1cf4c1616b68",
        "body" : "That's what I was thinking. I tried moving the application of the TZ around, but didn't have any luck. I'll keep working on it.",
        "createdAt" : "2020-07-16T22:00:10Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "2f8132dc-12f8-44dc-8b97-1cf4c1616b68",
        "tags" : [
        ]
      },
      {
        "id" : "da19eac3-566b-46b3-8755-92bfe954b9d5",
        "parentId" : "ea482f71-c9b5-4ae6-8be1-c51fd56a6db4",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "So I looked it up and it seems that it hits `time.localtime()` which internals are buried in C:\r\n\r\nhttps://github.com/python/cpython/blob/0275e04/Lib/datetime.py#L829 -> https://github.com/python/cpython/blob/0275e04/Modules/timemodule.c#L497 -> https://github.com/python/cpython/blob/0275e04/Python/pytime.c#L1053 -> https://en.cppreference.com/w/c/chrono/localtime.\r\n\r\nIt says that `tzset()` will set up internal structures based on `TZ` env var but this seems dangerous and you risk poisoning the entire interpreter state, hence influence other tests if you don't figure out how to clean it up properly.\r\n\r\nLooks like it's really safer to monkey-patch methods in the Python-land...",
        "createdAt" : "2020-07-16T22:18:13Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      }
    ],
    "commit" : "544a3bfc06bab9b933c7fc49ac132fdce17998bf",
    "line" : 23,
    "diffHunk" : "@@ -1,1 +21,25 @@def fake_now(monkeypatch):\n    \"\"\"\n    Patch `datetime.datetime.fromtimestamp()`, `datetime.datetime.utcfromtimestamp()`,\n    and `time.time()` to return deterministic values.\n    \"\"\""
  },
  {
    "id" : "cde92bb6-01e0-4031-b2f5-e8953c5ec98e",
    "prId" : 70665,
    "prUrl" : "https://github.com/ansible/ansible/pull/70665#pullrequestreview-452074571",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "d7afd4e8-88e0-4a67-bb0f-d9f847cf7ae3",
        "parentId" : null,
        "authorId" : "fd767403-a078-44f2-b3d3-75cd3faab948",
        "body" : "```suggestion\r\nEPOCH_TS = 1594449296.124356\r\n```",
        "createdAt" : "2020-07-16T22:44:20Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "fd767403-a078-44f2-b3d3-75cd3faab948",
        "tags" : [
        ]
      },
      {
        "id" : "630fc0b4-6d9d-4f9f-b068-5c6334ef8f28",
        "parentId" : "d7afd4e8-88e0-4a67-bb0f-d9f847cf7ae3",
        "authorId" : "2f8132dc-12f8-44dc-8b97-1cf4c1616b68",
        "body" : "I'm not sure I understand why this change is necessary. Could you enlighten me? ðŸ˜„ ",
        "createdAt" : "2020-07-20T20:54:17Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "2f8132dc-12f8-44dc-8b97-1cf4c1616b68",
        "tags" : [
        ]
      },
      {
        "id" : "1a10023f-5853-4c19-ba08-29b9738d0947",
        "parentId" : "d7afd4e8-88e0-4a67-bb0f-d9f847cf7ae3",
        "authorId" : "4b69a0b5-ac6f-45e9-9507-dd1385182f29",
        "body" : "Looks like values below in `DT` and `DT_UTC` are 124356, instead of 123456.",
        "createdAt" : "2020-07-20T21:03:09Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "4b69a0b5-ac6f-45e9-9507-dd1385182f29",
        "tags" : [
        ]
      },
      {
        "id" : "e9cae9ea-02ee-4482-aa43-209dc318a85f",
        "parentId" : "d7afd4e8-88e0-4a67-bb0f-d9f847cf7ae3",
        "authorId" : "fd767403-a078-44f2-b3d3-75cd3faab948",
        "body" : "Originally, there was `124356` microseconds in unit tests, instead of `123456`. At least two tests are rely on this figure.",
        "createdAt" : "2020-07-21T02:00:40Z",
        "updatedAt" : "2020-07-29T15:52:44Z",
        "lastEditedBy" : "fd767403-a078-44f2-b3d3-75cd3faab948",
        "tags" : [
        ]
      }
    ],
    "commit" : "544a3bfc06bab9b933c7fc49ac132fdce17998bf",
    "line" : 15,
    "diffHunk" : "@@ -1,1 +13,17 @@from ansible.module_utils.facts.system import date_time\n\nEPOCH_TS = 1594449296.123456\nDT = datetime.datetime(2020, 7, 11, 12, 34, 56, 124356)\nDT_UTC = datetime.datetime(2020, 7, 11, 2, 34, 56, 124356)"
  }
]