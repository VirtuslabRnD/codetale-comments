[
  {
    "id" : "bac1a140-7998-428c-bf0b-953025298864",
    "prId" : 68723,
    "prUrl" : "https://github.com/ansible/ansible/pull/68723#pullrequestreview-389202435",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "1aa486e7-7222-4c94-8bb8-e8a58ffdf71a",
        "parentId" : null,
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "I'd use equality which would be more precise and replace that check that you had earlier with calls count == 1.",
        "createdAt" : "2020-04-07T14:31:30Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "9bc3307b-44c7-43a1-a4fd-03341f2e7c51",
        "parentId" : "1aa486e7-7222-4c94-8bb8-e8a58ffdf71a",
        "authorId" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "body" : "I was using IN here because it seems the capsys output contains color-coding chars and newlines so IN was easier to use for confirming the main data here (warning + collection name) is present.",
        "createdAt" : "2020-04-07T14:40:55Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "tags" : [
        ]
      },
      {
        "id" : "2ed1885d-fab1-497d-bc4d-4c62d3407c37",
        "parentId" : "1aa486e7-7222-4c94-8bb8-e8a58ffdf71a",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "Right, you could probably monkeypatch `ANSIBLE_COLOR`: https://github.com/ansible/ansible/blob/598ead965dd0ed1db9a554e8a02c8fcc693ffdd8/lib/ansible/utils/color.py#L91.\r\n\r\nBut I looked closer at the display function and it looks like it uses an actual logger from `logging` stdlib module (https://github.com/ansible/ansible/blob/598ead965dd0ed1db9a554e8a02c8fcc693ffdd8/lib/ansible/utils/display.py#L216). So it's even easier than I thought initially.\r\n\r\nYou should be able to use the [`caplog` fixture](https://docs.pytest.org/en/latest/logging.html#caplog-fixture). Let me see if I can quickly come up with a patch.",
        "createdAt" : "2020-04-07T14:57:42Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      }
    ],
    "commit" : "5c7b52d0d4a94c70a759154510837cfc56813f6b",
    "line" : 37,
    "diffHunk" : "@@ -1,1 +35,39 @@\n    std_out, std_err = capsys.readouterr()\n    assert '[WARNING]: \"collections\" is not templatable, but we found: %s' % collection_name in std_err\n    assert '' == std_out"
  },
  {
    "id" : "0ba8399b-58c0-4afa-8851-996f6329ff1d",
    "prId" : 68723,
    "prUrl" : "https://github.com/ansible/ansible/pull/68723#pullrequestreview-389409485",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "10c8d0de-6505-4944-899a-81d90deab795",
        "parentId" : null,
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "What does that method return? Can we have an equality check here?\r\nAlso, is there a public method that could be called instead of the private one?",
        "createdAt" : "2020-04-07T14:34:14Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "b72596d3-9fef-402a-9f0c-e5fb24abc75a",
        "parentId" : "10c8d0de-6505-4944-899a-81d90deab795",
        "authorId" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "body" : "It returns a list of collection names and is adding 'ansible.legacy' to that list. I'm not aware of a public method to call instead.",
        "createdAt" : "2020-04-07T14:36:53Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "tags" : [
        ]
      },
      {
        "id" : "aa067408-b2f4-4df6-a303-923fc9b1754e",
        "parentId" : "10c8d0de-6505-4944-899a-81d90deab795",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "If the order is deterministic, you could have a more precise check here.",
        "createdAt" : "2020-04-07T14:38:36Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "72b3e754-7975-4382-a930-8de2bc52ed62",
        "parentId" : "10c8d0de-6505-4944-899a-81d90deab795",
        "authorId" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "body" : "Well, in this test case, it should always be the first element based on the current code. But in this case, we don't actually care about positioning, just that it appears anywhere in the list, independent of which other collections are inserted. Do you feel always checking against the first element is better? That could open it up to test failures if we later decide to alter the ordering for some reason that I cannot yet foresee.",
        "createdAt" : "2020-04-07T19:03:26Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "tags" : [
        ]
      },
      {
        "id" : "d87c5564-a4bd-4788-baeb-fcc6fcc9627c",
        "parentId" : "10c8d0de-6505-4944-899a-81d90deab795",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "I think either way is fine. But in general, I prefer tests to be as precise as possible to prevent some buggy behavior from squeezing in just because it has similar properties.",
        "createdAt" : "2020-04-07T19:06:19Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      }
    ],
    "commit" : "5c7b52d0d4a94c70a759154510837cfc56813f6b",
    "line" : 34,
    "diffHunk" : "@@ -1,1 +32,36 @@    collection_name = 'foo.{{bar}}'\n    cs = CollectionSearch()\n    assert collection_name in cs._load_collections(None, [collection_name])\n\n    std_out, std_err = capsys.readouterr()"
  },
  {
    "id" : "8b6177f9-f9ae-46eb-b0ba-dcc16becf926",
    "prId" : 68723,
    "prUrl" : "https://github.com/ansible/ansible/pull/68723#pullrequestreview-389419684",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "e53a2786-8633-411c-acb2-f7fc83063011",
        "parentId" : null,
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "@Shrews hope this works:\r\n```suggestion\r\nimport logging\r\n\r\nfrom ansible.playbook.collectionsearch import CollectionSearch\r\n\r\nimport pytest\r\n\r\n\r\ndef test_collection_static_warning(caplog):\r\n    \"\"\"Test that collection name is not templated.\r\n\r\n    Also, make sure that users see the warning message for the referenced name.\r\n    \"\"\"\r\n\r\n    collection_name = 'foo.{{bar}}'\r\n    cs = CollectionSearch()\r\n    with caplog.at_level(logging.WARNING, logger='ansible'):\r\n        assert collection_name in cs._load_collections(None, [collection_name])\r\n\r\n    expected_log_msg = '[WARNING]: \"collections\" is not templatable, but we found: %s' % collection_name\r\n    assert caplog.record_tuples == [('ansible', logging.WARNING, expected_log_msg)]\r\n```",
        "createdAt" : "2020-04-07T15:04:25Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "2674af38-53b3-4d83-9534-23a01af59038",
        "parentId" : "e53a2786-8633-411c-acb2-f7fc83063011",
        "authorId" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "body" : "I cannot make this work. caplog is always empty.",
        "createdAt" : "2020-04-07T18:42:26Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "tags" : [
        ]
      },
      {
        "id" : "e18b0a2a-20ee-4a66-bbba-740a51084376",
        "parentId" : "e53a2786-8633-411c-acb2-f7fc83063011",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "Weird, maybe logging is disabled in tests. Oh, it looks like it's only activated if the config points to a writable path: https://github.com/ansible/ansible/blob/devel/lib/ansible/utils/display.py#L79.",
        "createdAt" : "2020-04-07T19:08:42Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "0034016f-5baf-4d59-afff-7ba191fa0c46",
        "parentId" : "e53a2786-8633-411c-acb2-f7fc83063011",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "But then it seems to default to `~` which should always be writable: https://github.com/ansible/ansible/blob/f921b1e3bd38d66c193b814c060ca1c6e97adc48/lib/ansible/config/base.yml#L810",
        "createdAt" : "2020-04-07T19:09:58Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "ae31638d-76ff-4875-9352-82e3b38b9662",
        "parentId" : "e53a2786-8633-411c-acb2-f7fc83063011",
        "authorId" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "body" : "I guess it may be configurable by an env var but I don't know if `ansible-test` provisions it. Best to ask @mattclay.",
        "createdAt" : "2020-04-07T19:11:41Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "4ffac6b8-d7eb-449a-8c43-463d9fd5587a",
        "tags" : [
        ]
      },
      {
        "id" : "b177c59a-2645-4319-9d24-36aa9ab05557",
        "parentId" : "e53a2786-8633-411c-acb2-f7fc83063011",
        "authorId" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "body" : "Per our discussion, keeping use of capsys for now.",
        "createdAt" : "2020-04-07T19:21:11Z",
        "updatedAt" : "2020-04-09T16:49:23Z",
        "lastEditedBy" : "af2d6e2a-7e69-40a5-acbd-ee141feb19f6",
        "tags" : [
        ]
      }
    ],
    "commit" : "5c7b52d0d4a94c70a759154510837cfc56813f6b",
    "line" : 38,
    "diffHunk" : "@@ -1,1 +36,40 @@    std_out, std_err = capsys.readouterr()\n    assert '[WARNING]: \"collections\" is not templatable, but we found: %s' % collection_name in std_err\n    assert '' == std_out"
  }
]