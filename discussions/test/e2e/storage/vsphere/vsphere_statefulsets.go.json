[
  {
    "id" : "b3c5d420-b7e8-4c4c-a071-107295f8539d",
    "prId" : 92787,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/92787#pullrequestreview-444089709",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "1836bc78-88b7-483a-9e5a-d179346faec4",
        "parentId" : null,
        "authorId" : "2ce2b44c-9841-49e7-983e-fb7696974908",
        "body" : "https://github.com/kubernetes/kubernetes/issues/92785\r\n\r\n> Issue-2 - After upgrading apiVersion from apps/v1. Test executed successfully but reported failure in the after each cleanup stage.\r\n> Jul  3 20:34:46.049: FAIL: Failed waiting for stateful set status.replicas updated to 0: statefulsets.apps \"web\" not found\r\n> ...\r\n> This is happening because of the incorrect usage of WaitForStatusReplicas after calling c.AppsV1().StatefulSets(ss.Namespace).Delete.\r\n\r\ntrying to understand more here and why this change matters.\r\n\r\nare you suggesting that DeleteAllStatefulSets() gets called before WaitForStatusReplicas() if the DeleteAllStatefulSets() call is inside AfterEach(...)? are these tests run in parallel when you saw the problem?\r\n\r\nhttps://github.com/kubernetes/kubernetes/blob/master/test/e2e/storage/vsphere/vsphere_statefulsets.go#L131\r\n\r\n/cc @SandeepPissay\r\nvSphere storage\r\n\r\n/cc @gnufied @pohly \r\nSIG Storage / e2e\r\n\r\n",
        "createdAt" : "2020-07-06T23:31:25Z",
        "updatedAt" : "2020-07-06T23:31:49Z",
        "lastEditedBy" : "2ce2b44c-9841-49e7-983e-fb7696974908",
        "tags" : [
        ]
      },
      {
        "id" : "e3242eac-b7f5-4da8-b1e3-8d83bc07319a",
        "parentId" : "1836bc78-88b7-483a-9e5a-d179346faec4",
        "authorId" : "c13045f9-cfc0-48e5-80df-ee48ddaa9fdc",
        "body" : "@neolit123 \r\n\r\n> why this change matters\r\n\r\nWe want to avoid printing below error message in the test for `AfterEach` call.\r\n\r\nThis could be because of the race between namespace deletion and AfterEach execution. I am not familiar with the framework. When `c.AppsV1().StatefulSets(ss.Namespace).Delete` is called, it is not finding a stateful set.\r\n\r\n```\r\n[AfterEach] [sig-storage] vsphere statefulset [Feature:vsphere]\r\n  /go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/test/e2e/storage/vsphere/vsphere_statefulsets.go:69\r\nJul  3 20:34:25.949: INFO: Deleting all statefulset in namespace: vsphere-statefulset-4079\r\nJul  3 20:34:25.964: INFO: Scaling statefulset web to 0\r\nJul  3 20:34:46.036: INFO: Waiting for statefulset status.replicas updated to 0\r\nJul  3 20:34:46.049: FAIL: Failed waiting for stateful set status.replicas updated to 0: statefulsets.apps \"web\" not found\r\n\r\nFull Stack Trace\r\nk8s.io/kubernetes/test/e2e/framework/statefulset.WaitForStatusReplicas(0x5e49f80, 0xc00083c6e0, 0xc000cf6f00, 0x0)\r\n\t/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/test/e2e/framework/statefulset/wait.go:145 +0x22e\r\nk8s.io/kubernetes/test/e2e/framework/statefulset.DeleteAllStatefulSets(0x5e49f80, 0xc00083c6e0, 0xc0035a80a0, 0x18)\r\n\t/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/test/e2e/framework/statefulset/rest.go:86 +0x3a9\r\nk8s.io/kubernetes/test/e2e/storage/vsphere.glob..func5.2()\r\n\t/go/src/k8s.io/kubernetes/_output/dockerized/go/src/k8s.io/kubernetes/test/e2e/storage/vsphere/vsphere_statefulsets.go:71 +0xe0\r\nk8s.io/kubernetes/test/e2e.RunE2ETests(0xc000124ea0)\r\n\t_output/dockerized/go/src/k8s.io/kubernetes/test/e2e/e2e.go:130 +0x337\r\nk8s.io/kubernetes/test/e2e.TestE2E(0xc000124ea0)\r\n\t_output/dockerized/go/src/k8s.io/kubernetes/test/e2e/e2e_test.go:145 +0x2b\r\ntesting.tRunner(0xc000124ea0, 0x55e7630)\r\n\t/usr/local/go/src/testing/testing.go:991 +0xdc\r\ncreated by testing.(*T).Run\r\n\t/usr/local/go/src/testing/testing.go:1042 +0x357\r\n\r\nâ€¢ Failure in Spec Teardown (AfterEach) [146.105 seconds]\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
        "createdAt" : "2020-07-07T17:07:49Z",
        "updatedAt" : "2020-07-07T17:07:49Z",
        "lastEditedBy" : "c13045f9-cfc0-48e5-80df-ee48ddaa9fdc",
        "tags" : [
        ]
      }
    ],
    "commit" : "c1335087e41cb43d00c347b9fd942a1f93b8cb8e",
    "line" : 15,
    "diffHunk" : "@@ -1,1 +80,84 @@\n\t\tstatefulset := e2estatefulset.CreateStatefulSet(client, manifestPath, namespace)\n\t\tdefer e2estatefulset.DeleteAllStatefulSets(client, namespace)\n\t\treplicas := *(statefulset.Spec.Replicas)\n\t\t// Waiting for pods status to be Ready"
  }
]