[
  {
    "id" : "1daf13a5-d511-401d-b5ef-799501338b3b",
    "prId" : 10054,
    "prUrl" : "https://github.com/RocketChat/Rocket.Chat/pull/10054#pullrequestreview-107441953",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "a8a861be-c4a7-4769-8166-9a5c6ea39d95",
        "parentId" : null,
        "authorId" : "409df6ab-3b03-4605-a9f9-90ba7bb0018e",
        "body" : "`this.bodyParams.visitor.token` doesn't work. You should use camelCased in the field names, such as `this.bodyParams.visitorToken`.",
        "createdAt" : "2018-03-27T18:13:00Z",
        "updatedAt" : "2018-03-27T18:16:33Z",
        "lastEditedBy" : "409df6ab-3b03-4605-a9f9-90ba7bb0018e",
        "tags" : [
        ]
      },
      {
        "id" : "08e0dcb9-37e6-4183-8da5-776f5b2c3f00",
        "parentId" : "a8a861be-c4a7-4769-8166-9a5c6ea39d95",
        "authorId" : "3acc9a56-77df-4d8b-9117-e05dc9ac7ba2",
        "body" : "@renatobecker the payload used in message post was based in the payload send to webhook.\r\n\r\nThis is the expected POST for this endpoint:\r\n```\r\ncurl -v -H \"Content-type: application/json\" -H \"${H_USERID}\" -H \"${H_AUTHTOKEN}\" \"http://localhost:3000/api/v1/livechat/messages\" -d'{\r\n  \"visitor\": {\r\n    \"token\":\"04aa15e2-31ed-11e8-ac97-93976ab3c67b\",\r\n    \"name\": \"Guest Name\",\r\n    \"email\": \"guest@mail.com\",\r\n    \"phone\": {\r\n        \"number\": \"+5511999999999\"\r\n    }\r\n  },\r\n  \"messages\": [\r\n    {\r\n       \"msg\": \"Hi!!\"\r\n    }\r\n  ]\r\n}'\r\n```\r\n\r\nWebhook payloads: https://rocket.chat/docs/administrator-guides/livechat/",
        "createdAt" : "2018-03-27T18:34:18Z",
        "updatedAt" : "2018-03-27T18:38:45Z",
        "lastEditedBy" : "3acc9a56-77df-4d8b-9117-e05dc9ac7ba2",
        "tags" : [
        ]
      },
      {
        "id" : "5fd3b165-b785-4cf8-bac6-03a7c2ab1cae",
        "parentId" : "a8a861be-c4a7-4769-8166-9a5c6ea39d95",
        "authorId" : "409df6ab-3b03-4605-a9f9-90ba7bb0018e",
        "body" : "Have you tried your code? We are talking about the name of a query parameter and the format you are using is not valid.",
        "createdAt" : "2018-03-27T18:55:00Z",
        "updatedAt" : "2018-03-27T18:58:00Z",
        "lastEditedBy" : "409df6ab-3b03-4605-a9f9-90ba7bb0018e",
        "tags" : [
        ]
      },
      {
        "id" : "ee79e1df-0c82-4027-8da5-848f08a16f36",
        "parentId" : "a8a861be-c4a7-4769-8166-9a5c6ea39d95",
        "authorId" : "3acc9a56-77df-4d8b-9117-e05dc9ac7ba2",
        "body" : "Yes, we tried it. We are using a body parameter (JSON object) not a query parameter. And this format is to access field `token` inside `visitor` inside request body (application/json). This is why \"visitor.token\"\r\n\r\nThe \"curl\" below is working and will create a new guest as shown in the screenshot.\r\n```\r\ncurl -s -H \"Content-type: application/json\" -H \"${H_USERID}\" -H \"${H_AUTHTOKEN}\" \"http://localhost:3000/api/v1/livechat/messages\" -d'{\r\n  \"visitor\": {\r\n    \"token\":\"04aa15e2-31ed-11e8-ac97-93976ab3c67b\",\r\n    \"name\": \"Guest Name\",\r\n    \"email\": \"guest@mail.com\",\r\n    \"phone\": {\r\n        \"number\": \"+5511999999999\"\r\n    }\r\n  },\r\n  \"messages\": [\r\n    {\r\n       \"msg\": \"Hi!!\"\r\n    }\r\n  ]\r\n}'\r\n```\r\n\r\n![screenshot-new-guest](https://user-images.githubusercontent.com/3268876/37989808-ceeede86-31da-11e8-834d-9049dd8f4c5e.png)\r\n",
        "createdAt" : "2018-03-27T19:22:28Z",
        "updatedAt" : "2018-03-27T19:22:28Z",
        "lastEditedBy" : "3acc9a56-77df-4d8b-9117-e05dc9ac7ba2",
        "tags" : [
        ]
      },
      {
        "id" : "180e4470-b099-417e-b180-2610546c7a0a",
        "parentId" : "a8a861be-c4a7-4769-8166-9a5c6ea39d95",
        "authorId" : "3acc9a56-77df-4d8b-9117-e05dc9ac7ba2",
        "body" : "If you want to try, here is the whole script:\r\nhttps://gist.github.com/hmagarotto/6251f86e1f00035cc249c8ef05238a90",
        "createdAt" : "2018-03-27T19:39:15Z",
        "updatedAt" : "2018-03-27T19:39:15Z",
        "lastEditedBy" : "3acc9a56-77df-4d8b-9117-e05dc9ac7ba2",
        "tags" : [
        ]
      },
      {
        "id" : "1a413a7b-4529-4059-85a3-a8e2976dbd6a",
        "parentId" : "a8a861be-c4a7-4769-8166-9a5c6ea39d95",
        "authorId" : "409df6ab-3b03-4605-a9f9-90ba7bb0018e",
        "body" : "OK, sorry. I was testing this in another way.",
        "createdAt" : "2018-03-27T19:49:24Z",
        "updatedAt" : "2018-03-27T19:49:24Z",
        "lastEditedBy" : "409df6ab-3b03-4605-a9f9-90ba7bb0018e",
        "tags" : [
        ]
      }
    ],
    "commit" : "976b0922eac55d5b40550304033cd635fcd24f48",
    "line" : 12,
    "diffHunk" : "@@ -1,1 +10,14 @@\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor\" is required');\n\t\t}\n\t\tif (!this.bodyParams.visitor.token) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor.token\" is required');\n\t\t}"
  }
]