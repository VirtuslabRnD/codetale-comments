[
  {
    "id" : "852a12d9-1522-41f3-9d2b-1d47adff248d",
    "prId" : 69737,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/69737#pullrequestreview-164725072",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "e5165efa-5ae3-40ea-8dc6-6c5ce7ed33a4",
        "parentId" : null,
        "authorId" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "body" : "Discussion topic: do we need similar tolerations in the cluster-level agent spec? I suspect the only reason we would is if all nodes are tainted. @x13n @MaciekPytel @kawych @piosz @bmoyles0117",
        "createdAt" : "2018-10-13T01:16:22Z",
        "updatedAt" : "2018-10-13T01:16:39Z",
        "lastEditedBy" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "tags" : [
        ]
      },
      {
        "id" : "6442a755-122a-4c79-8831-3831390fd238",
        "parentId" : "e5165efa-5ae3-40ea-8dc6-6c5ce7ed33a4",
        "authorId" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "body" : "Some of that conversation happened in https://github.com/kubernetes/kubernetes/pull/68920#discussion_r221987620.",
        "createdAt" : "2018-10-13T20:35:22Z",
        "updatedAt" : "2018-10-13T20:35:22Z",
        "lastEditedBy" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "tags" : [
        ]
      },
      {
        "id" : "d6189933-8684-4866-87ef-1cb13761e579",
        "parentId" : "e5165efa-5ae3-40ea-8dc6-6c5ce7ed33a4",
        "authorId" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "body" : "Ah, thanks for the pointer. I see the priority class now. Given that we'll only cherry-pick this into 1.12 and 1.11, this should work. If we ever need a 1.10 cherry-pick, we'd have to add stronger tolerations (e.g., `CriticalAddonsOnly`).",
        "createdAt" : "2018-10-13T20:44:29Z",
        "updatedAt" : "2018-10-13T20:44:29Z",
        "lastEditedBy" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "tags" : [
        ]
      },
      {
        "id" : "e5dcfe7b-8992-42b0-84d4-f94455c15036",
        "parentId" : "e5165efa-5ae3-40ea-8dc6-6c5ce7ed33a4",
        "authorId" : "e2aaf386-2908-41e6-860b-bcb2cffa1cc7",
        "body" : "`CriticalAddonsOnly` isn't really stronger - the ones added here are wildcard ones, so they include it already.",
        "createdAt" : "2018-10-15T07:38:51Z",
        "updatedAt" : "2018-10-15T07:38:52Z",
        "lastEditedBy" : "e2aaf386-2908-41e6-860b-bcb2cffa1cc7",
        "tags" : [
        ]
      },
      {
        "id" : "9a5efd03-95b2-4dcd-a291-c85e5a8a437b",
        "parentId" : "e5165efa-5ae3-40ea-8dc6-6c5ce7ed33a4",
        "authorId" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "body" : "I meant for the cluster-level agent, which currently doesn't have any tolerations.",
        "createdAt" : "2018-10-15T11:29:32Z",
        "updatedAt" : "2018-10-15T11:29:32Z",
        "lastEditedBy" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "tags" : [
        ]
      },
      {
        "id" : "4579a00f-d6f0-4861-adbb-51ac146f61d5",
        "parentId" : "e5165efa-5ae3-40ea-8dc6-6c5ce7ed33a4",
        "authorId" : "e2aaf386-2908-41e6-860b-bcb2cffa1cc7",
        "body" : "Oh, right. I think if someone is tainting all their nodes, something may break anyway, but yes, this could at least mitigate the problem in 1.10.",
        "createdAt" : "2018-10-15T11:33:50Z",
        "updatedAt" : "2018-10-15T11:33:50Z",
        "lastEditedBy" : "e2aaf386-2908-41e6-860b-bcb2cffa1cc7",
        "tags" : [
        ]
      },
      {
        "id" : "13ac91a7-0f22-4f7f-8049-e8727bd15166",
        "parentId" : "e5165efa-5ae3-40ea-8dc6-6c5ce7ed33a4",
        "authorId" : "3f00d8a9-68e2-438c-85da-b03590361276",
        "body" : "I think a lot of things won't schedule if you taint all your nodes (DNS, metrics-server, ...). I don't think cluster-level agent should have stronger tolerations than other cluster-level system components. ",
        "createdAt" : "2018-10-15T14:14:32Z",
        "updatedAt" : "2018-10-15T14:14:32Z",
        "lastEditedBy" : "3f00d8a9-68e2-438c-85da-b03590361276",
        "tags" : [
        ]
      }
    ],
    "commit" : "85d8b5069b143692a9b5851b115b883ce2fb5e5a",
    "line" : 4,
    "diffHunk" : "@@ -1,1 +59,63 @@      schedulerName: default-scheduler\n      terminationGracePeriodSeconds: 30\n      tolerations:\n      - operator: \"Exists\"\n        effect: \"NoExecute\""
  },
  {
    "id" : "302a94c0-35eb-40f9-b995-08a40f0ffb9e",
    "prId" : 66485,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/66485#pullrequestreview-142468071",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "e0878bbf-ead3-416f-ad98-40f3d5692352",
        "parentId" : null,
        "authorId" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "body" : "Just double checking - Is this change on purpose? Or something got in by accident when addressing the rebasing conflicts?",
        "createdAt" : "2018-08-01T16:40:41Z",
        "updatedAt" : "2018-08-06T15:26:51Z",
        "lastEditedBy" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "tags" : [
        ]
      },
      {
        "id" : "e609f491-4c8d-4280-b3f5-32b3243f1a12",
        "parentId" : "e0878bbf-ead3-416f-ad98-40f3d5692352",
        "authorId" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "body" : "Same. LGTM.",
        "createdAt" : "2018-08-01T16:51:24Z",
        "updatedAt" : "2018-08-06T15:26:51Z",
        "lastEditedBy" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "tags" : [
        ]
      }
    ],
    "commit" : "32c2bfadfdd4e74e42f55810460640df4436b5f6",
    "line" : 41,
    "diffHunk" : "@@ -1,1 +90,94 @@        name: metadata-agent\n        livenessProbe:\n          httpGet:\n            path: /healthz\n            port: 8000"
  },
  {
    "id" : "6f185ccc-6b59-4d2f-9d92-a86ea463ebd5",
    "prId" : 66485,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/66485#pullrequestreview-142468071",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "08a138db-bcde-46ce-a8c1-710324704b51",
        "parentId" : null,
        "authorId" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "body" : "Same here. Is this health probe change on purpose? Or something got in by accident when addressing the rebasing conflicts?",
        "createdAt" : "2018-08-01T16:41:06Z",
        "updatedAt" : "2018-08-06T15:26:51Z",
        "lastEditedBy" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "tags" : [
        ]
      },
      {
        "id" : "ecd4c135-4c29-4ece-9f85-66d0af485c10",
        "parentId" : "08a138db-bcde-46ce-a8c1-710324704b51",
        "authorId" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "body" : "The new health checks use http-based health checks to a handler that the API server exposes. Is this your concern? I feel that I might be missing something when you point out a rebase conflict.",
        "createdAt" : "2018-08-01T16:47:20Z",
        "updatedAt" : "2018-08-06T15:26:51Z",
        "lastEditedBy" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "tags" : [
        ]
      },
      {
        "id" : "34e6eeee-2ae7-4032-ae4a-fa0426550106",
        "parentId" : "08a138db-bcde-46ce-a8c1-710324704b51",
        "authorId" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "body" : "Ah. These changes were probably there before the rebase then. I was not sure of that and wanna double check.\r\n\r\nLooks good.",
        "createdAt" : "2018-08-01T16:51:14Z",
        "updatedAt" : "2018-08-06T15:26:51Z",
        "lastEditedBy" : "b6d26bb4-a0e1-418a-8ea1-8f2e86b6d1d1",
        "tags" : [
        ]
      }
    ],
    "commit" : "32c2bfadfdd4e74e42f55810460640df4436b5f6",
    "line" : 41,
    "diffHunk" : "@@ -1,1 +34,38 @@        name: metadata-agent\n        livenessProbe:\n          httpGet:\n            path: /healthz\n            port: 8000"
  },
  {
    "id" : "0c77351d-87a9-4c8b-b104-8a20d0083627",
    "prId" : 62756,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/62756#pullrequestreview-116696712",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "fd5558b0-e928-432a-bac5-bc6e8c0b39aa",
        "parentId" : null,
        "authorId" : "9f030d50-62db-4b00-a28c-847709b74d97",
        "body" : "Also add it to the `metadata-agent-cluster-level`?",
        "createdAt" : "2018-05-01T13:32:40Z",
        "updatedAt" : "2018-05-03T05:50:43Z",
        "lastEditedBy" : "9f030d50-62db-4b00-a28c-847709b74d97",
        "tags" : [
        ]
      },
      {
        "id" : "2825fe7e-9f12-4546-8f7e-90473f61ff73",
        "parentId" : "fd5558b0-e928-432a-bac5-bc6e8c0b39aa",
        "authorId" : "4186ed58-9575-4126-b730-073268bc67cb",
        "body" : "Thanks for the catch! Added now.",
        "createdAt" : "2018-05-01T20:47:45Z",
        "updatedAt" : "2018-05-03T05:50:43Z",
        "lastEditedBy" : "4186ed58-9575-4126-b730-073268bc67cb",
        "tags" : [
        ]
      }
    ],
    "commit" : "27da26754f97d1be384bee71ee0335291115a286",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +42,46 @@        app: metadata-agent\n      annotations:\n        seccomp.security.alpha.kubernetes.io/pod: 'docker/default'\n    spec:\n      serviceAccountName: metadata-agent"
  },
  {
    "id" : "dbbfa4cc-3b46-4d8a-a87c-4e9df345e825",
    "prId" : 62043,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/62043#pullrequestreview-113994851",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "bf698a20-87af-4af5-a104-b454f273fe89",
        "parentId" : null,
        "authorId" : "acf367dc-26b7-4dc5-b0fa-2397add126d0",
        "body" : "This ConfigMap is missing labels for addon manager:\r\nkubernetes.io/cluster-service: \"true\"\r\naddonmanager.kubernetes.io/mode: Reconcile",
        "createdAt" : "2018-04-20T14:15:34Z",
        "updatedAt" : "2018-04-20T14:15:34Z",
        "lastEditedBy" : "acf367dc-26b7-4dc5-b0fa-2397add126d0",
        "tags" : [
        ]
      }
    ],
    "commit" : "e350c461160def588ac30662eaf404476e042589",
    "line" : 6,
    "diffHunk" : "@@ -1,1 +10,14 @@apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: metadata-agent-config\n  namespace: kube-system"
  },
  {
    "id" : "5627beb0-c93c-4534-b4ea-2677a7ba7aab",
    "prId" : 56576,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/56576#pullrequestreview-80870100",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "d772a93a-93e7-411e-a8a4-5c08a0ba8376",
        "parentId" : null,
        "authorId" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "body" : "Don't you also need to change the logging agent configuration to point to this port?",
        "createdAt" : "2017-11-29T18:03:30Z",
        "updatedAt" : "2017-11-29T18:03:35Z",
        "lastEditedBy" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "tags" : [
        ]
      },
      {
        "id" : "d3e3a820-7428-4e7e-adb1-3b406773866d",
        "parentId" : "d772a93a-93e7-411e-a8a4-5c08a0ba8376",
        "authorId" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "body" : "Yes, but the logging agent doesn't support the host as a parameter. We should discuss if the port should be part of the same parameter, or a separate parameter entirely. Making it part of METADATA_AGENT_HOSTNAME would be easier, as we could check for the existence of a \":\" in the hostname, and append :8000 if not found. WDYT?",
        "createdAt" : "2017-11-29T22:08:23Z",
        "updatedAt" : "2017-11-29T22:08:23Z",
        "lastEditedBy" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "tags" : [
        ]
      },
      {
        "id" : "f004d573-7d76-4ddd-9ce5-0bd4fa28bfe6",
        "parentId" : "d772a93a-93e7-411e-a8a4-5c08a0ba8376",
        "authorId" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "body" : "I'm confused -- the logging agent uses the `metadata_agent_url` parameter, which can definitely include the port. Are you talking about the environment variables used by the container's entrypoint script? If so, then we can add a METADATA_AGENT_PORT variable or rename the current one to METADATA_AGENT_URL.",
        "createdAt" : "2017-11-29T22:15:23Z",
        "updatedAt" : "2017-11-29T22:15:24Z",
        "lastEditedBy" : "0b2de092-e468-4d99-9434-b45bb8947530",
        "tags" : [
        ]
      },
      {
        "id" : "d1b751ae-f260-49ad-80d2-cf20ef1ecce6",
        "parentId" : "d772a93a-93e7-411e-a8a4-5c08a0ba8376",
        "authorId" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "body" : "Yeah I'm referencing the container's entrypoint script.\r\n\r\nThis is where the sed replace occurs\r\nhttps://github.com/GoogleCloudPlatform/google-fluentd/blob/master/docker/run.sh#L13\r\n\r\nAnd this is what it's replacing \"local-metadata-agent.stackdriver.com\":8000, not the :8000. Easy enough to update.\r\nhttps://github.com/GoogleCloudPlatform/google-fluentd/blob/master/docker/Dockerfile#L9\r\n\r\nWe can discuss the right naming for the env variable, but for now it's not modifiable in any existing docker image.",
        "createdAt" : "2017-11-29T22:19:17Z",
        "updatedAt" : "2017-11-29T22:19:17Z",
        "lastEditedBy" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "tags" : [
        ]
      },
      {
        "id" : "60a587fc-583b-4d9c-8547-41800f567bfb",
        "parentId" : "d772a93a-93e7-411e-a8a4-5c08a0ba8376",
        "authorId" : "acf367dc-26b7-4dc5-b0fa-2397add126d0",
        "body" : "Are you OK with this being final configuration for Metadata Agent?",
        "createdAt" : "2017-11-30T10:30:03Z",
        "updatedAt" : "2017-11-30T10:30:03Z",
        "lastEditedBy" : "acf367dc-26b7-4dc5-b0fa-2397add126d0",
        "tags" : [
        ]
      },
      {
        "id" : "9a273915-cbf1-4388-b10a-9d21a8dba716",
        "parentId" : "d772a93a-93e7-411e-a8a4-5c08a0ba8376",
        "authorId" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "body" : "I'm ok with this configuration for the Metadata agent. However, in order for these changes to matter we still need to make changes to a few other places.\r\n\r\n1. The input source for containers needs to incorporate the local_resource_id label. You can see how did it below.\r\n    The section that this needs to be added in is here: https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-gcp/fluentd-gcp-configmap.yaml#L74\r\n\r\n```\r\n$ curl -s https://storage.googleapis.com/stackdriver-container-alpha/configs/stackdriver-agents.yaml | cat -n | grep -C 5 local_resource_id\r\n\r\n   205\t      <match reform.**>\r\n   206\t        @type record_reformer\r\n   207\t        enable_ruby true\r\n   208\t        <record>\r\n   209\t          \"logging.googleapis.com/local_resource_id\" ${\"k8s_container.#{tag_parts[4].split('-')[-1]}\"}\r\n   210\t        </record>\r\n   212\t        tag ${if record['stream'] == 'stderr' then 'raw.kubernetes.stderr' else 'raw.kubernetes.stdout' end}\r\n   213\t      </match>\r\n```\r\n\r\n2. You need to update the google_cloud output plugin for kubernetes.* to enable the metadata agent.\r\n\r\n     https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-gcp/fluentd-gcp-configmap.yaml#L351\r\n\r\n    You can do this by adding these lines. However you manage to get these lines in there, you'll need to ensure that the hostname is set to the `spec.nodeName` from the downwards API. We do this in our `run.sh` as you're familiar with here: https://github.com/GoogleCloudPlatform/google-fluentd/blob/master/docker/run.sh#L15\r\n\r\n```\r\n# Enable metadata agent lookups.\r\nenable_metadata_agent true\r\nmetadata_agent_url \"http://local-metadata-agent.stackdriver.com:8799\"\r\n```",
        "createdAt" : "2017-12-01T23:01:08Z",
        "updatedAt" : "2017-12-01T23:01:42Z",
        "lastEditedBy" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "tags" : [
        ]
      },
      {
        "id" : "37ab69de-a018-43d3-baca-c247e8a8bc03",
        "parentId" : "d772a93a-93e7-411e-a8a4-5c08a0ba8376",
        "authorId" : "acf367dc-26b7-4dc5-b0fa-2397add126d0",
        "body" : "@crassirostris \r\nMik, do you agree with these changes? Do you have this in your plans?",
        "createdAt" : "2017-12-04T15:06:30Z",
        "updatedAt" : "2017-12-04T15:06:30Z",
        "lastEditedBy" : "acf367dc-26b7-4dc5-b0fa-2397add126d0",
        "tags" : [
        ]
      }
    ],
    "commit" : "b314d188776109b80e353144c1dbf4e9862d9031",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +23,27 @@        ports:\n        - containerPort: 8000\n          hostPort: 8799\n          protocol: TCP\n        resources:"
  },
  {
    "id" : "7a7ac146-f3cf-4ab5-974c-e33fd71f3956",
    "prId" : 56219,
    "prUrl" : "https://github.com/kubernetes/kubernetes/pull/56219#pullrequestreview-78685037",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "6bbcaa75-0ab1-48fd-bf22-93932108da90",
        "parentId" : null,
        "authorId" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "body" : "nit: as this rolls into production, we will want to look at occupying a less common port.",
        "createdAt" : "2017-11-22T21:19:17Z",
        "updatedAt" : "2017-11-22T21:24:14Z",
        "lastEditedBy" : "b787a5e8-0552-4d8e-b0b7-df6e8633dd77",
        "tags" : [
        ]
      },
      {
        "id" : "edab2f4b-857f-48ec-868f-03b63c0b4a22",
        "parentId" : "6bbcaa75-0ab1-48fd-bf22-93932108da90",
        "authorId" : "acf367dc-26b7-4dc5-b0fa-2397add126d0",
        "body" : "Thanks for pointing this out, I'll change it in a follow-up PR. Do we need to agree on some port number (e.g. for fluentd to communicate), or it doesn't make a difference for you now?",
        "createdAt" : "2017-11-23T11:09:42Z",
        "updatedAt" : "2017-11-23T11:09:43Z",
        "lastEditedBy" : "acf367dc-26b7-4dc5-b0fa-2397add126d0",
        "tags" : [
        ]
      }
    ],
    "commit" : "52f7695f0071a89895f00614e098fdca79e6f42c",
    "line" : 24,
    "diffHunk" : "@@ -1,1 +22,26 @@        name: metadata-agent\n        ports:\n        - containerPort: 8000\n          hostPort: 8000\n          protocol: TCP"
  }
]