[
  {
    "id" : "2b8e8dd9-49eb-4255-8f2b-299362ce332b",
    "prId" : 9039,
    "prUrl" : "https://github.com/apache/kafka/pull/9039#pullrequestreview-458453943",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "c760119a-7bb8-4c2e-876d-82b5aca376a7",
        "parentId" : null,
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "I was wondering what this method is actually used for so I checked out the callers of `KStreamWindowAggregate#windows`. There's a method called `extractGracePeriod` in `GraphGraceSearchUtil` where we might actually need to make a small addition to include the new sliding window processor.\r\n\r\nI think it's for Suppression, which needs to figure out the grace period of the upstream operator since grace period doesn't get passed in directly to `suppress`",
        "createdAt" : "2020-07-29T23:58:03Z",
        "updatedAt" : "2020-08-31T22:19:06Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      },
      {
        "id" : "909f38c8-40dd-4d93-a0b2-9fb12e552bc4",
        "parentId" : "c760119a-7bb8-4c2e-876d-82b5aca376a7",
        "authorId" : "114424ac-2f76-47ba-b653-f85692b08607",
        "body" : "done!",
        "createdAt" : "2020-07-30T14:26:20Z",
        "updatedAt" : "2020-08-31T22:19:06Z",
        "lastEditedBy" : "114424ac-2f76-47ba-b653-f85692b08607",
        "tags" : [
        ]
      }
    ],
    "commit" : "de97db6cf39eb34eab0207f3cc45a5085317b2a4",
    "line" : 69,
    "diffHunk" : "@@ -1,1 +67,71 @@    }\n\n    public SlidingWindows windows() {\n        return windows;\n    }"
  },
  {
    "id" : "a9e1ea31-72c3-444a-b68e-7f9ad3179369",
    "prId" : 9039,
    "prUrl" : "https://github.com/apache/kafka/pull/9039#pullrequestreview-478995471",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "fcd45b85-01d4-4537-892f-0f4c4a4895ea",
        "parentId" : null,
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "Just a note to other reviewers: we're planning to revisit the issue of \"early\" records later and are just dropping them for now to make the general algorithm easier to review and understand. It needs some special handling for the edge case of records that arrive earlier than the full sliding window due to the inability to store windows with negative start times",
        "createdAt" : "2020-08-05T01:36:28Z",
        "updatedAt" : "2020-08-31T22:19:06Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      },
      {
        "id" : "05cf7484-2cee-4f1b-a571-795ed85bab8b",
        "parentId" : "fcd45b85-01d4-4537-892f-0f4c4a4895ea",
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "https://github.com/apache/kafka/pull/9157",
        "createdAt" : "2020-08-10T22:18:45Z",
        "updatedAt" : "2020-08-31T22:19:06Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      },
      {
        "id" : "c7e75905-52db-45b8-a796-4bb701e08689",
        "parentId" : "fcd45b85-01d4-4537-892f-0f4c4a4895ea",
        "authorId" : "f84c555e-0e5d-4773-b994-4121b6b8dada",
        "body" : "Is this condition supposed to be checking whether records are \"early\" with respect to now? It looks like it should be:\r\n```suggestion\r\n            if (timestamp < (observedStreamTime - windows.timeDifferenceMs())) {\r\n```",
        "createdAt" : "2020-08-27T18:53:31Z",
        "updatedAt" : "2020-08-31T22:19:06Z",
        "lastEditedBy" : "f84c555e-0e5d-4773-b994-4121b6b8dada",
        "tags" : [
        ]
      },
      {
        "id" : "13e1b109-f680-407f-8700-9937643c0d72",
        "parentId" : "fcd45b85-01d4-4537-892f-0f4c4a4895ea",
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "No, the condition is correct. In this context \"early\" just means \"within timeDifferenceMs of the zero timestamp\". We need some special handling to cover this full range of all record timestamps due to the inability to store negative timestamps. This algorithm works correctly for all records outside of this regardless of \"now\"",
        "createdAt" : "2020-08-27T21:50:34Z",
        "updatedAt" : "2020-08-31T22:19:06Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      },
      {
        "id" : "697cd50a-202c-4dc6-8dcd-89d00b7dd4f9",
        "parentId" : "fcd45b85-01d4-4537-892f-0f4c4a4895ea",
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "To be honest, it might not be so bad to just leave things as is and drop early records, since any sensible timestamps are unlikely to be that close to the epoch. But I do believe users may want to use lower timestamps in their unit testing (`1598565116374` is not a very human readable number) and would be surprised to see these records just dropped. ",
        "createdAt" : "2020-08-27T21:53:00Z",
        "updatedAt" : "2020-08-31T22:19:06Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      },
      {
        "id" : "b3c923d8-38db-4ea8-b38e-f72cf0a711f8",
        "parentId" : "fcd45b85-01d4-4537-892f-0f4c4a4895ea",
        "authorId" : "f84c555e-0e5d-4773-b994-4121b6b8dada",
        "body" : "Thanks for the confirmation! I agree with your thinking.",
        "createdAt" : "2020-08-31T22:16:28Z",
        "updatedAt" : "2020-08-31T22:19:06Z",
        "lastEditedBy" : "f84c555e-0e5d-4773-b994-4121b6b8dada",
        "tags" : [
        ]
      }
    ],
    "commit" : "de97db6cf39eb34eab0207f3cc45a5085317b2a4",
    "line" : 122,
    "diffHunk" : "@@ -1,1 +120,124 @@            final long timestamp = context().timestamp();\n            //don't process records that don't fall within a full sliding window\n            if (timestamp < windows.timeDifferenceMs()) {\n                log.warn(\n                    \"Skipping record due to early arrival. value=[{}] topic=[{}] partition=[{}] offset=[{}]\","
  },
  {
    "id" : "3e563f4f-7736-48e1-9e4d-8ec59859c460",
    "prId" : 9157,
    "prUrl" : "https://github.com/apache/kafka/pull/9157#pullrequestreview-472822157",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "ffec3e5a-956c-46f6-b207-1d430432a1d2",
        "parentId" : null,
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "This is just a window from [0, timeDifferenceMs] that stores the aggregation of all the \"early\" records, right? I can't really think of a more descriptive name so can we just leave a comment explaining what it's for",
        "createdAt" : "2020-08-24T23:13:19Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      }
    ],
    "commit" : "7d4ca6a3b9ea899afa680ec852fdfdfb5e2f3d58",
    "line" : 172,
    "diffHunk" : "@@ -1,1 +249,253 @@\n            // A window from [0, timeDifferenceMs] that holds all early records\n            KeyValue<Windowed<K>, ValueAndTimestamp<Agg>> combinedWindow = null;\n            ValueAndTimestamp<Agg> rightWinAgg = null;\n            boolean rightWinAlreadyCreated = false;"
  },
  {
    "id" : "89c465af-eec2-4749-8b03-fa73e895a985",
    "prId" : 9157,
    "prUrl" : "https://github.com/apache/kafka/pull/9157#pullrequestreview-481033464",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "d93d770e-155d-4e4d-ac94-ad21b2728ee1",
        "parentId" : null,
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "Same here, can this ever be null? It doesn't seem like it, even if it's a new window we still pass in the initializer value so `valueAndTime` won't ever be null. ...right?",
        "createdAt" : "2020-09-01T22:27:44Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      },
      {
        "id" : "85a23154-c389-42ab-87a7-fa2d0488f9f7",
        "parentId" : "d93d770e-155d-4e4d-ac94-ad21b2728ee1",
        "authorId" : "114424ac-2f76-47ba-b653-f85692b08607",
        "body" : "I just ran the tests and it's _mostly_ true that it won't be null. We do have a test, and so it seems like a real life scenario (?), where the reduce initializer is null, so when creating a new window `valueAndTime` is null.",
        "createdAt" : "2020-09-02T13:51:05Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "114424ac-2f76-47ba-b653-f85692b08607",
        "tags" : [
        ]
      },
      {
        "id" : "73d71af1-d4b4-491c-a49c-5f35c8194c39",
        "parentId" : "d93d770e-155d-4e4d-ac94-ad21b2728ee1",
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "True, I guess there's no reason the initializer can't return null. Nevermind then",
        "createdAt" : "2020-09-02T17:13:20Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      }
    ],
    "commit" : "7d4ca6a3b9ea899afa680ec852fdfdfb5e2f3d58",
    "line" : 310,
    "diffHunk" : "@@ -1,1 +370,374 @@            if (windowEnd > closeTime) {\n                //get aggregate from existing window\n                final Agg oldAgg = getValueOrNull(valueAndTime);\n                final Agg newAgg = aggregator.apply(key, value, oldAgg);\n"
  },
  {
    "id" : "97e44c23-82a1-467b-b476-39ede8cffd1d",
    "prId" : 9157,
    "prUrl" : "https://github.com/apache/kafka/pull/9157#pullrequestreview-480230394",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "c19c58ea-90e6-45ac-83c4-ed223abb7d01",
        "parentId" : null,
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "By the way, I think we should also check if the record is so old that even the latest window it could possibly create/affect would be dropped, and then not process the record at all. (ie basically check if the current record's right window would be dropped) We can record on the lateRecordDropSensor and log the message using the current record's left window. ",
        "createdAt" : "2020-09-02T00:50:36Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      }
    ],
    "commit" : "7d4ca6a3b9ea899afa680ec852fdfdfb5e2f3d58",
    "line" : 10,
    "diffHunk" : "@@ -1,1 +121,125 @@            observedStreamTime = Math.max(observedStreamTime, inputRecordTimestamp);\n            final long closeTime = observedStreamTime - windows.gracePeriodMs();\n\n            if (inputRecordTimestamp + 1L + windows.timeDifferenceMs() <= closeTime) {\n                log.warn("
  },
  {
    "id" : "9da0e6f1-f0e4-4d93-b958-ba8c8d749e9e",
    "prId" : 9157,
    "prUrl" : "https://github.com/apache/kafka/pull/9157#pullrequestreview-482919463",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "16ea1ebb-819a-4ce4-b7d5-88de1dc80872",
        "parentId" : null,
        "authorId" : "9baadc38-cd41-4762-be0c-791258ced78c",
        "body" : "Not sure how this change relates to \"early records\"?",
        "createdAt" : "2020-09-03T15:37:47Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "9baadc38-cd41-4762-be0c-791258ced78c",
        "tags" : [
        ]
      },
      {
        "id" : "c13ee5cc-edb9-4cbb-8a0f-aeec578ecb0f",
        "parentId" : "16ea1ebb-819a-4ce4-b7d5-88de1dc80872",
        "authorId" : "114424ac-2f76-47ba-b653-f85692b08607",
        "body" : "I think it might've gotten pulled over when updating from the original PR",
        "createdAt" : "2020-09-04T16:05:12Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "114424ac-2f76-47ba-b653-f85692b08607",
        "tags" : [
        ]
      },
      {
        "id" : "6ef5f549-0f07-43b6-bb53-6f1572965af0",
        "parentId" : "16ea1ebb-819a-4ce4-b7d5-88de1dc80872",
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "This was just from the semi-related cleanup of splitting `putAndForward` into a separate method for `createRightWindow`, which was done after the first PR was merged (hence the cleanup occurs in this PR). I think?",
        "createdAt" : "2020-09-04T20:18:48Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      }
    ],
    "commit" : "7d4ca6a3b9ea899afa680ec852fdfdfb5e2f3d58",
    "line" : 319,
    "diffHunk" : "@@ -1,1 +371,375 @@                //get aggregate from existing window\n                final Agg oldAgg = getValueOrNull(valueAndTime);\n                final Agg newAgg = aggregator.apply(key, value, oldAgg);\n\n                final long newTimestamp = oldAgg == null ? inputRecordTimestamp : Math.max(inputRecordTimestamp, valueAndTime.timestamp());"
  },
  {
    "id" : "30bcbf3b-a287-4adf-ab7d-cbc09416aab7",
    "prId" : 9157,
    "prUrl" : "https://github.com/apache/kafka/pull/9157#pullrequestreview-484522844",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "dc3b57e9-0316-4420-8192-80836327ffe8",
        "parentId" : null,
        "authorId" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "body" : "nit: log an error and include the relevant info (eg `windowStart` and `inputRecordTimestamp` at least). Same for the IllegalStateException in `processEarly`",
        "createdAt" : "2020-09-08T22:03:54Z",
        "updatedAt" : "2020-09-08T23:35:27Z",
        "lastEditedBy" : "d97f50bf-60f9-45b3-81a0-a24a5f42f740",
        "tags" : [
        ]
      }
    ],
    "commit" : "7d4ca6a3b9ea899afa680ec852fdfdfb5e2f3d58",
    "line" : 115,
    "diffHunk" : "@@ -1,1 +202,206 @@                            startTime, inputRecordTimestamp\n                        );\n                        throw new IllegalStateException(\"Unexpected window found when processing sliding windows\");\n                    }\n                }"
  }
]