[
  {
    "id" : "ee627b4f-f8e9-4fa3-ba25-63e7d723e365",
    "prId" : 57257,
    "prUrl" : "https://github.com/flutter/flutter/pull/57257#pullrequestreview-414704339",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "parentId" : null,
        "authorId" : "fd82dff4-bfc7-4076-8507-e7e4521446f2",
        "body" : "What about using the mkdir method described in this FAQ, at least as a fallback when flock doesn't exist? It seems more reliable than shlock, and would probably work on platforms without either one: http://mywiki.wooledge.org/BashFAQ/045\r\n\r\nIt goes something like this:\r\n```bash\r\n lockdir=/tmp/myscript.lock\r\n if mkdir \"$lockdir\"\r\n then\r\n     echo >&2 \"successfully acquired lock\"\r\n\r\n     # Remove lockdir when the script finishes, or when it receives a signal\r\n     trap 'rm -rf \"$lockdir\"' 0    # remove directory when script finishes\r\n\r\n     # Optionally create temporary files in this directory, because\r\n     # they will be removed automatically:\r\n     tmpfile=$lockdir/filelist\r\n\r\n else\r\n     echo >&2 \"cannot acquire lock, giving up on $lockdir\"\r\n     exit 0\r\n fi\r\n```",
        "createdAt" : "2020-05-18T16:29:22Z",
        "updatedAt" : "2020-05-18T17:58:46Z",
        "lastEditedBy" : "fd82dff4-bfc7-4076-8507-e7e4521446f2",
        "tags" : [
        ]
      },
      {
        "id" : "d4039c1f-33ad-45aa-bce2-b5f47e903162",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "body" : "@gspencergoog both of your suggestions (this one and the change to `follow_links()`) seem worth doing. However, is it all right if I make those changes in a follow-up PR so that if it breaks the world, we still have these scripts factored out into multiple entrypoints.\r\n\r\nAs far as I can tell, the problems you've pointed out won't be exacerbated by this change, right?",
        "createdAt" : "2020-05-18T17:23:34Z",
        "updatedAt" : "2020-05-18T17:58:46Z",
        "lastEditedBy" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "tags" : [
        ]
      },
      {
        "id" : "b2ad3ad6-6018-4294-bfed-0eab27f2b83c",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "fd82dff4-bfc7-4076-8507-e7e4521446f2",
        "body" : "Sure, that's fine. We should address them, though.",
        "createdAt" : "2020-05-18T17:30:10Z",
        "updatedAt" : "2020-05-18T17:58:46Z",
        "lastEditedBy" : "fd82dff4-bfc7-4076-8507-e7e4521446f2",
        "tags" : [
        ]
      },
      {
        "id" : "4d32f2db-d711-4ddc-b177-fe95b98435d2",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "body" : "> Sure, that's fine. We should address them, though.\r\n\r\npinky swear :)",
        "createdAt" : "2020-05-18T17:31:33Z",
        "updatedAt" : "2020-05-18T17:58:46Z",
        "lastEditedBy" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "tags" : [
        ]
      },
      {
        "id" : "273cb2e1-fe3a-4062-81a4-6f1ff3fc3478",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "body" : "Filed https://github.com/flutter/flutter/issues/57512 to track.",
        "createdAt" : "2020-05-18T18:10:57Z",
        "updatedAt" : "2020-05-18T18:10:58Z",
        "lastEditedBy" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "tags" : [
        ]
      },
      {
        "id" : "1dcc4663-7e1f-40bb-b157-34df18199c96",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "48f1352d-88f2-485f-a06d-eadbf95bd625",
        "body" : "There are some poorly implemented userland filesystems where the mkdir trick doesn't work, but those are edge cases on an edge case.  It's a pretty solid backup for flock.",
        "createdAt" : "2020-05-19T17:15:42Z",
        "updatedAt" : "2020-05-19T17:15:42Z",
        "lastEditedBy" : "48f1352d-88f2-485f-a06d-eadbf95bd625",
        "tags" : [
        ]
      },
      {
        "id" : "c7b2114c-ecb0-4ef0-beef-8ef04d80772b",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "body" : "> There are some poorly implemented userland filesystems where the mkdir trick doesn't work, but those are edge cases on an edge case. It's a pretty solid backup for flock.\r\n\r\n*sigh*, it seems like BASH scripting is all about choosing which edge cases you want to optimize for...",
        "createdAt" : "2020-05-19T17:21:31Z",
        "updatedAt" : "2020-05-19T17:21:32Z",
        "lastEditedBy" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "tags" : [
        ]
      },
      {
        "id" : "99b94ffe-6b86-4241-9b94-bad744b982fe",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "fd82dff4-bfc7-4076-8507-e7e4521446f2",
        "body" : "There's another case that is an edge case and a problem: If I'm mounting the flutter dir over a file share, and I access it from both a Linux system and a Mac system simultaneously, then the locking won't hold, since one is using flock and one is using shlock (or mkdir). They'll happily overwrite each other then.",
        "createdAt" : "2020-05-19T18:10:44Z",
        "updatedAt" : "2020-05-19T18:10:44Z",
        "lastEditedBy" : "fd82dff4-bfc7-4076-8507-e7e4521446f2",
        "tags" : [
        ]
      },
      {
        "id" : "a2b073cf-1d9b-4119-b4bc-bedcd8fdd569",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "body" : "This is true. Using the same repo from multiple host OSes is not supported anyway (the cached artifacts can't be shared), but we should detect this.",
        "createdAt" : "2020-05-19T18:13:50Z",
        "updatedAt" : "2020-05-19T18:13:50Z",
        "lastEditedBy" : "7ae842f7-1029-4528-8bf6-8472584744ed",
        "tags" : [
        ]
      },
      {
        "id" : "f0c30bb3-cba3-4610-bd35-808e86e33e04",
        "parentId" : "13379b1c-10c3-4e12-accc-3bc778e7ec33",
        "authorId" : "fd82dff4-bfc7-4076-8507-e7e4521446f2",
        "body" : "BTW, I put up a draft PR to try and address some of this (although it doesn't address the two-hosts problem): https://github.com/flutter/flutter/pull/57590",
        "createdAt" : "2020-05-19T18:14:14Z",
        "updatedAt" : "2020-05-19T18:14:15Z",
        "lastEditedBy" : "fd82dff4-bfc7-4076-8507-e7e4521446f2",
        "tags" : [
        ]
      }
    ],
    "commit" : "cc814f036c5c8661d38b47d6a650638a1cc347cf",
    "line" : 77,
    "diffHunk" : "@@ -1,1 +75,79 @@  # scope,  i.e. when this function returns.  The lock is released via\n  # a trap when using \"shlock\".\n  if hash flock 2>/dev/null; then\n    flock 3 2>/dev/null || true\n  elif hash shlock 2>/dev/null; then"
  }
]