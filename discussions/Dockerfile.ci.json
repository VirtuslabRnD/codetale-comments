[
  {
    "id" : "d7f56731-d7b4-40c4-a3d5-392002349fdf",
    "prId" : 8857,
    "prUrl" : "https://github.com/apache/airflow/pull/8857#pullrequestreview-410909601",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "a7743a89-05eb-41ac-8035-2c00b3f2ab6a",
        "parentId" : null,
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "Nice!",
        "createdAt" : "2020-05-13T13:06:19Z",
        "updatedAt" : "2020-05-13T14:28:03Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "f73a5da4-9794-420a-b039-7805304033d4",
        "parentId" : "a7743a89-05eb-41ac-8035-2c00b3f2ab6a",
        "authorId" : "e29ffafb-ac51-434b-b9e0-af262caae1ee",
        "body" : ";)",
        "createdAt" : "2020-05-13T13:13:37Z",
        "updatedAt" : "2020-05-13T14:28:03Z",
        "lastEditedBy" : "e29ffafb-ac51-434b-b9e0-af262caae1ee",
        "tags" : [
        ]
      }
    ],
    "commit" : "e62dc680d00257f4817720804b0ffa6f049309dc",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +42,46 @@\n# By increasing this number we can do force build of all dependencies\nARG DEPENDENCIES_EPOCH_NUMBER=\"3\"\n# Increase the value below to force renstalling of all dependencies\nENV DEPENDENCIES_EPOCH_NUMBER=${DEPENDENCIES_EPOCH_NUMBER}"
  },
  {
    "id" : "5418e39e-f652-4552-ad0e-187596cb6094",
    "prId" : 10784,
    "prUrl" : "https://github.com/apache/airflow/pull/10784#pullrequestreview-491052928",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "parentId" : null,
        "authorId" : "c25957e2-1132-4c48-a536-3824307fd862",
        "body" : "This means that the PRs will run with the upgraded constraints right?",
        "createdAt" : "2020-09-15T13:38:37Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "c25957e2-1132-4c48-a536-3824307fd862",
        "tags" : [
        ]
      },
      {
        "id" : "86e1b634-3808-4ff6-b328-2af801502689",
        "parentId" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "Nope. Only when the buld runs in master. All the PRs have \"UPGRADE_TO_LATEST_CONSTRAINTS\" set to \"false\" but all the \"master\" push-es have the UPGRADE_TO_LATEST_CONSTRAINTS set to \"COMMIT_SHA\" so that every new master push will automatically invalidate this line in Dockerfile (but only master push, not PR).",
        "createdAt" : "2020-09-15T13:45:06Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "f309ca9a-fbcb-4d97-9511-e79f5dd3741d",
        "parentId" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "Correction. Every \"push\" and \"scheduled\" build as well: https://github.com/apache/airflow/pull/10784/files#diff-cf2e198c11119438802588d2da4d372aR145",
        "createdAt" : "2020-09-15T13:46:19Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "63dca77d-0c60-403b-b652-28b5c56d8a61",
        "parentId" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "So bottomline: Every \"merge\" and \"scheduled\" build will attempt to automatically upgrade to latest constratins. Additionally if a \"merge\" push will run successfully (i.e. all the tests pass) the newly upgraded constratins will be pushed to the \"constraints\" branch. ",
        "createdAt" : "2020-09-15T13:49:01Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "ac0eefd1-9335-4517-a6b8-e355648be2c4",
        "parentId" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "And in case there is a problem with any dependencies we will see merge builds failing, but it will not impact the PRs. This so far happened only when setup.py changed, but I believe smaller incremental upgrades after every merge make much more sense as we will precisely see what caused the problems. I also plan to show a \"constraint diff\" in such build shortly soo that we immediately see which changed requirements caused failure.",
        "createdAt" : "2020-09-15T13:52:01Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "305d3d03-7ff9-447f-9ae7-1bb97cdb8fbb",
        "parentId" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "authorId" : "c25957e2-1132-4c48-a536-3824307fd862",
        "body" : "What happens in case where we upgrade the dependencies in PR, will they fail with no package found error?",
        "createdAt" : "2020-09-17T22:31:04Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "c25957e2-1132-4c48-a536-3824307fd862",
        "tags" : [
        ]
      },
      {
        "id" : "c0304486-653c-4deb-ab8b-3c6660fcc3af",
        "parentId" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "Everything will work, I believe (but it would be great to check if there are no loopholes).\r\n\r\nThis part has not changed and we run it for > year now. Only the location changed to run the scripts  -  the scripts are run in  the \"workflow_run\". Here we build the image using `scripts/ci` taken from master, but the `Dockerfile`, `setup.py`, `scripts/in_container` and everything else is coming from the PR.\r\n\r\nIn Dockerfile.ci there are two steps of pip  install:\r\n\r\n1)  The first one: https://github.com/apache/airflow/blob/5b3fb53d9c5c943abb8ddc90214c320b7a11c8c2/Dockerfile.ci#L223 installs deps from master. This one only invalidates when we rebuild the image from scratch (i.e. when we change Dockerfile or when we get a new base python image. In all other cases, this one is taken from cache - even if setup.py changes. This is because we COPY setup.py in one of the following lines (not before). It's really an optimization - thanks to that, even if setup.py changes, it does not take 20 minutes to build the image but maybe 6-7 minutes (because all dependencies from the previous master run are already installed in the layer taken from the cache. \r\n\r\n2) then we copy setup.py: https://github.com/apache/airflow/blob/master/Dockerfile.ci#L243 - if setup.py is not changed vs. latest master build - this layer is also taken from cache as well as the subsequent step of pip install (this way if no setup.py changes the image build is ~ 3/4 minutes - we do not lose time on even checking for new requirements. But if the setup.py changes (setup.py comes from the PR - just to remind) then Docker cache gets invalidated here and all later layers of the image are built from here.\r\n\r\n3) Then if setup.py changed in the previous step we reach that line during rebuilding the layers: https://github.com/apache/airflow/blob/master/Dockerfile.ci#L258. \r\nIn \"normal\" PR's (UPGRADE_TO_LATEST_CONSTRAINT = \"false\") we run this command:\r\n `pip install -e \".[${AIRFLOW_EXTRAS}]\"   --constraint \"${AIRFLOW_CONSTRAINTS_URL}\" `\r\n\r\nThis will:\r\na) install all the new stuff that appeared in setup.py (so here where we install new packages)\r\nb) upgrade all the stuff for which limits were changed in setup.py and the limits do not fit either constraints or already installed versions\r\nc) but all the rest remains untouched.\r\n\r\nThis way PR gets only the previously \"good\" constrains + anything that changed in the setuup.py for this PR (this is where we avoid the 'package not found`).\r\n\r\nBasically it means that it will only try to upgrade or install new deps that freshly appeared in setup.py. But if the previous requirements are fitting the setup.py limits, no \"eager\" upgrade of those requirements is performed.\r\n\r\nIn the other case (UPGRADE_TO_LATEST_CONSTRAINT = \"commit hash\") the same pip install is run with `--upgrade --upgrade-strategy eager and NO constraints'. This is only run in case we run a \"master merge\" push or scheduled build. This  means that pip will try to upgrade all the dependencies to their most recent versions that fulfill the setup.py limitations  - without looking at the last constraints. If such a build succeeds (all tests pass), then we upgrade constraints to match those newly upgraded versions (because we know that they passed the tests). This is recorded as the commit message in teh orphaned \"constraints-master\" or constraints-1-10 branches (depending if it was a master or v1-10-test push):\r\n\r\nExample here: https://github.com/apache/airflow/commit/625194596587bd8b3ef54f1902b6060e4a0c187b - you see which commit originated it and what exactly changes so we can easily track the history of upgrades of those.\r\n\r\nOnce the image is build (with potentially new requirements), it is pushed to registry and tests for the run that triggered the build are run using this image.\r\n\r\n\r\nWhy check-ing for \"commit hash\" - because if it was \"true\" then this line woudl only be invalidated if anything changed in the \"setup.py\" above.. By adding commit hash here, we make sure to invalidate this line with every merge push, and it means that we will be running \"--upgrade --upgrade-strategy eager\" every time we merge to master. This way we will have bigger number of smaller incremental changes (with newly released versions of dependent libraries\" every time we merge.",
        "createdAt" : "2020-09-17T23:05:55Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "2f401fd5-4dfa-46e0-b7e5-9bb308c53d40",
        "parentId" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "authorId" : "c25957e2-1132-4c48-a536-3824307fd862",
        "body" : "That was my impression and understanding too but when it failed `azure-identity` few days back and today again when I pushed that commit to v1-10-test the commit failed with `module not found`.\r\n\r\n(btw thanks for the detailed explanation)",
        "createdAt" : "2020-09-17T23:22:23Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "c25957e2-1132-4c48-a536-3824307fd862",
        "tags" : [
        ]
      },
      {
        "id" : "a3ff6da7-fee2-426c-97d2-92ed011b6459",
        "parentId" : "f3d22d5a-046a-42b0-ace3-643e4816d911",
        "authorId" : "c25957e2-1132-4c48-a536-3824307fd862",
        "body" : "Example Run with failure:\r\n\r\nhttps://github.com/apache/airflow/runs/1130333784?check_suite_focus=true",
        "createdAt" : "2020-09-17T23:23:59Z",
        "updatedAt" : "2020-09-22T12:32:53Z",
        "lastEditedBy" : "c25957e2-1132-4c48-a536-3824307fd862",
        "tags" : [
        ]
      }
    ],
    "commit" : "31cef5b1f2f4b4f56bae6d821b216cb33e9e1cd5",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +257,261 @@# and push the constraints if everything is successful\nRUN \\\n    if [[ \"${UPGRADE_TO_LATEST_CONSTRAINTS}\" != \"false\" ]]; then \\\n        pip install -e \".[${AIRFLOW_EXTRAS}]\" --upgrade --upgrade-strategy eager; \\\n    else \\"
  },
  {
    "id" : "42c46169-3dd8-4665-b2bf-b295bcf5b3fd",
    "prId" : 12181,
    "prUrl" : "https://github.com/apache/airflow/pull/12181#pullrequestreview-529147832",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f116dcfe-95ba-48ad-8fea-8347d922be14",
        "parentId" : null,
        "authorId" : "e29ffafb-ac51-434b-b9e0-af262caae1ee",
        "body" : "```suggestion\r\nENV RUNTIME_APT_DEPS=${RUNTIME_APT_DEPS}\r\n```",
        "createdAt" : "2020-11-12T14:36:31Z",
        "updatedAt" : "2020-11-13T18:58:45Z",
        "lastEditedBy" : "e29ffafb-ac51-434b-b9e0-af262caae1ee",
        "tags" : [
        ]
      }
    ],
    "commit" : "2d639d94959dd72a4e01e6b6cb1119dbb353bd1a",
    "line" : 7,
    "diffHunk" : "@@ -1,1 +135,139 @@      vim \\\n      xxd\"\nENV RUNTIME_APT_DEP=${RUNTIME_APT_DEPS}\n\nARG ADDITIONAL_RUNTIME_APT_DEPS=\"\""
  },
  {
    "id" : "166887f8-2082-400f-9266-33bbb6ebe9e0",
    "prId" : 12604,
    "prUrl" : "https://github.com/apache/airflow/pull/12604#pullrequestreview-538111350",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "bafdba5b-ac86-4568-a027-9252b305e7c4",
        "parentId" : null,
        "authorId" : "c25957e2-1132-4c48-a536-3824307fd862",
        "body" : "Same URL is defined at:\r\n\r\nhttps://github.com/apache/airflow/blob/780c0b4ab8d1a64ca806942ae094f722d9beb447/Dockerfile.ci#L248-L249",
        "createdAt" : "2020-11-25T02:28:48Z",
        "updatedAt" : "2020-11-25T02:28:48Z",
        "lastEditedBy" : "c25957e2-1132-4c48-a536-3824307fd862",
        "tags" : [
        ]
      }
    ],
    "commit" : "780c0b4ab8d1a64ca806942ae094f722d9beb447",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +274,278 @@        pip install \\\n            \"https://github.com/${AIRFLOW_REPO}/archive/${AIRFLOW_BRANCH}.tar.gz#egg=apache-airflow[${AIRFLOW_EXTRAS}]\" \\\n                --constraint \"${AIRFLOW_CONSTRAINTS_LOCATION}\" \\\n                && pip uninstall --yes apache-airflow; \\\n    fi"
  },
  {
    "id" : "e8342ef7-cb93-4773-8702-4502dd249f97",
    "prId" : 13178,
    "prUrl" : "https://github.com/apache/airflow/pull/13178#pullrequestreview-555952977",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "6f82fd8e-e292-4523-bd86-78d194823a51",
        "parentId" : null,
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "I guess it depends on #13177 so it should be updated accordingly (or maybe merge those two PRS).",
        "createdAt" : "2020-12-19T08:20:35Z",
        "updatedAt" : "2020-12-20T01:25:32Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      },
      {
        "id" : "2baf62ca-d9dd-4a37-a354-5701783b727f",
        "parentId" : "6f82fd8e-e292-4523-bd86-78d194823a51",
        "authorId" : "07638d17-cc8b-40a4-abdc-7b39759362ab",
        "body" : "I merged these PRs.",
        "createdAt" : "2020-12-19T16:31:54Z",
        "updatedAt" : "2020-12-20T01:25:32Z",
        "lastEditedBy" : "07638d17-cc8b-40a4-abdc-7b39759362ab",
        "tags" : [
        ]
      }
    ],
    "commit" : "430897dce3c6e6e8a68f823f18adb1568bbd21b3",
    "line" : 5,
    "diffHunk" : "@@ -1,1 +196,200 @@\n# Increase the value here to force reinstalling Apache Airflow pip dependencies\nARG PIP_DEPENDENCIES_EPOCH_NUMBER=\"5\"\nENV PIP_DEPENDENCIES_EPOCH_NUMBER=${PIP_DEPENDENCIES_EPOCH_NUMBER}\n"
  },
  {
    "id" : "e4f82722-c30a-44fd-86fb-929531d5703d",
    "prId" : 13313,
    "prUrl" : "https://github.com/apache/airflow/pull/13313#pullrequestreview-560358927",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "62784285-9b1c-4748-88f8-751fdace3336",
        "parentId" : null,
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "You must copy the airflow/www/compile_assets.sh script here as well.",
        "createdAt" : "2020-12-31T14:15:40Z",
        "updatedAt" : "2020-12-31T14:18:34Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      }
    ],
    "commit" : "7b6abe674424a36472cb295b9b52bc32f70270bd",
    "line" : 3,
    "diffHunk" : "@@ -1,1 +343,347 @@# commands so as otherwise it copies the _contents_ of static/ in to www/\nCOPY airflow/www/webpack.config.js ${AIRFLOW_SOURCES}/airflow/www/\nCOPY airflow/www/static ${AIRFLOW_SOURCES}/airflow/www/static/\nCOPY airflow/www/compile_assets.sh ${AIRFLOW_SOURCES}/airflow/www/compile_assets.sh\n# Package JS/css for production"
  },
  {
    "id" : "22f69b61-30df-49d0-92dd-fcec1b309fba",
    "prId" : 13422,
    "prUrl" : "https://github.com/apache/airflow/pull/13422#pullrequestreview-560587472",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "c79c381f-0d8a-4315-bb82-7d1addf9e5d1",
        "parentId" : null,
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "We want to stick to the constraints here as well (unless setup.py requirements change)",
        "createdAt" : "2021-01-01T13:32:31Z",
        "updatedAt" : "2021-01-02T00:52:42Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      }
    ],
    "commit" : "583b0496fca9d7ea782eaa10ce1cc8b2d88e143a",
    "line" : 17,
    "diffHunk" : "@@ -1,1 +327,331 @@        else \\\n            pip install -e \".[${AIRFLOW_EXTRAS}]\" --upgrade --upgrade-strategy only-if-needed\\\n                --constraint \"${AIRFLOW_CONSTRAINTS_LOCATION}\"; \\\n            pip install --upgrade \"pip==${AIRFLOW_PIP_VERSION}\"; \\\n        fi; \\"
  },
  {
    "id" : "bb594b00-3ffa-4fb6-8d68-75224f017527",
    "prId" : 13422,
    "prUrl" : "https://github.com/apache/airflow/pull/13422#pullrequestreview-560587514",
    "prSource" : "GitHub",
    "comments" : [
      {
        "id" : "f5ea41ac-fcb6-4227-b5db-7e83d001b846",
        "parentId" : null,
        "authorId" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "body" : "Same 'docker-file-context' installation for CI image. It might be useful only in case we want to test CI image built from packages, good to keep that option.",
        "createdAt" : "2021-01-01T13:33:44Z",
        "updatedAt" : "2021-01-02T00:52:42Z",
        "lastEditedBy" : "e8563344-32ea-4c07-9731-a2fed8d2edf2",
        "tags" : [
        ]
      }
    ],
    "commit" : "583b0496fca9d7ea782eaa10ce1cc8b2d88e143a",
    "line" : 28,
    "diffHunk" : "@@ -1,1 +336,340 @@COPY docker-context-files/ /docker-context-files/\n\n# hadolint ignore=SC2086, SC2010\nRUN if [[ ${INSTALL_FROM_DOCKER_CONTEXT_FILES} == \"true\" ]]; then \\\n        reinstalling_apache_airflow_packages=$(ls /docker-context-files/apache?airflow*.{whl,tar.gz} 2>/dev/null || true); \\"
  }
]